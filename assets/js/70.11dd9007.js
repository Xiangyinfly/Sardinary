(window.webpackJsonp=window.webpackJsonp||[]).push([[70],{593:function(e,n,a){"use strict";a.r(n);var t=a(2),s=Object(t.a)({},(function(){var e=this,n=e._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("aside",[e._v("\nğŸ’¡ ***æ‰«æçš„ç»“æœæ˜¯beanDefinition***\n")]),e._v(" "),n("h2",{attrs:{id:"componentscançš„æ‰«æ"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#componentscançš„æ‰«æ"}},[e._v("#")]),e._v(" @ComponentScançš„æ‰«æ")]),e._v(" "),n("p",[e._v("è§£æComponentScanAnnotationParserç±»ï¼š")]),e._v(" "),n("h3",{attrs:{id:"_1ï¸âƒ£-newä¸€ä¸ªscanner"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1ï¸âƒ£-newä¸€ä¸ªscanner"}},[e._v("#")]),e._v(" 1ï¸âƒ£ï¼šnewä¸€ä¸ªscanner")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('ClassPathBeanDefinitionScanner scanner = new ClassPathBeanDefinitionScanner (this.registry,componentScan.getBoolean("useDefaultFilters"), this. environment, this. resourceLoader);\n')])])]),n("p",[e._v("this.registryï¼šspringå®¹å™¨ï¼Œç”¨æ¥æ”¾å…¥äº§ç”Ÿçš„beanDefinition\ncomponentScan.getBoolean(â€œuseDefaultFiltersâ€)ï¼šé»˜è®¤ä¸ºtrueï¼Œå³ä½¿ç”¨é»˜è®¤çš„è¿‡æ»¤å™¨")]),e._v(" "),n("h3",{attrs:{id:"_2ï¸âƒ£-æ‰«æå™¨scannerå»è®¾ç½®ä¸€äº›å±æ€§"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2ï¸âƒ£-æ‰«æå™¨scannerå»è®¾ç½®ä¸€äº›å±æ€§"}},[e._v("#")]),e._v(" 2ï¸âƒ£ï¼šæ‰«æå™¨scannerå»è®¾ç½®ä¸€äº›å±æ€§")]),e._v(" "),n("h3",{attrs:{id:"_1-è‡ªå®šä¹‰beanåå­—"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-è‡ªå®šä¹‰beanåå­—"}},[e._v("#")]),e._v(" 1.è‡ªå®šä¹‰beanåå­—")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('    //è‡ªå®šä¹‰beanåå­—\n    Class<? extends BeanNameGenerator> generatorClass = componentScan.getClass("nameGenerator");\n    boolean useInheritedGenerator = (BeanNameGenerator.class == generatorClass);\n    //åˆ¤æ–­æ˜¯å¦ä¸ºé»˜è®¤å€¼\n    scanner.setBeanNameGenerator(useInheritedGenerator ? this.beanNameGenerator :\n                BeanUtils.instantiateClass(generatorClass));\n')])])]),n("p",[e._v("é»˜è®¤çš„ä¸ºAnnotationBeanNameGeneratorï¼Œç”Ÿæˆæ–¹æ³•å¦‚ä¸‹")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("@Override\npublic String generateBeanName (BeanDefinition definition,BeanDefinitionRegistry\nregistry) {\n    if(definition instanceof AnnotatedBeanDefinition) {\n    //è·å–æ³¨è§£æ‰€æŒ‡å®šçš„beanName\n    //é»˜è®¤ä¸ºç±»@Componentæ³¨è§£é‡Œvalueå±æ€§çš„å€¼\n        String beanName = determineBeanNameFromAnnotation((AnnotatedBeanDefinition) definition);\n        if (StringUtils. hasText (beanName)) {\n        // Explicit bean name found.\n        return beanName;\n    }\n    // Fallback: generate a unique default bean name.\n    //ç”Ÿæˆé»˜è®¤å\n    return buildDefaultBeanName (definition, registry);\n}\n")])])]),n("p",[e._v("ç”Ÿæˆé»˜è®¤åçš„æ–¹æ³•")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('protected String buildDefaultBeanName(BeanDefinition definition) {\n    String beanClassName = definition. getBeanClassName;\n    Assert. state ( beanClassName != null,"No bean class name set");\n    String shortClassName = ClassUtils. getShortName (beanClassName) ;\n    return Introspector. decapitalize(shortClassName);\nï½\n')])])]),n("p",[e._v("æˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€ä¸ªMyBeanNameGeneratorç±»ï¼Œå®ç°BeanNameGeneratoræ¥å£æ¥è‡ªå®šä¹‰beançš„åå­—")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('public class MyBeanNameGenerator implements BeanNameGenerator {\n    @Override\n    public String generateBeanName(BeanDefinitiondefinition,BeanDefinitionRegistry\nregistry) {\n        return "My"+definition.getBeanClassName();\n    }\n}\n')])])]),n("p",[e._v("ç„¶ååœ¨configç±»çš„@Componentæ³¨è§£æ·»åŠ å±æ€§nameGenerator =\nMyBeanNameGenerator.class)ä»¥èµ·ä½œç”¨")]),e._v(" "),n("h3",{attrs:{id:"_2-è®¾ç½®é»˜è®¤ä»£ç†æ¨¡å¼"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-è®¾ç½®é»˜è®¤ä»£ç†æ¨¡å¼"}},[e._v("#")]),e._v(" 2.è®¾ç½®é»˜è®¤ä»£ç†æ¨¡å¼")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('ScopedProxyMode scopedProxyMode = componentScan.getEnum("scopedProxy");\n        if (scopedProxyMode != ScopedProxyMode.DEFAULT) {\n            scanner.setScopedProxyMode(scopedProxyMode);\n        }\n        else {\n            Class<? extends ScopeMetadataResolver> resolverClass = componentScan.getClass("scopeResolver");\n            scanner.setScopeMetadataResolver(BeanUtils.instantiateClass(resolverClass));\n        }\n')])])]),n("p",[e._v("å…³äºscopedProxyå±æ€§ï¼š å‰ç½®çŸ¥è¯†ï¼š å‡è®¾s1ç±»åŠ ä¸Š@Scope\n(WebApplicationContext.\nSCOPE_REQUEST)æ³¨è§£ï¼Œå³åªæœ‰åˆ›å»ºè¯·æ±‚çš„æ—¶å€™æ‰ä¼šç”Ÿæˆbeanã€‚è€Œs2ç±»ä¸­æœ‰@Autowiredçš„s1ç±»ï¼ˆåˆ›å»ºçš„æ—¶å€™å¼ºåˆ¶è¦æ±‚æ³¨å…¥s1ï¼‰ï¼Œä½†æ˜¯åœ¨s2åˆ›å»ºçš„æ—¶å€™ï¼ˆå³å®¹å™¨åˆå§‹åŒ–çš„æ—¶å€™ï¼‰ï¼Œs1å¹¶æœªè¢«åˆ›å»ºã€‚springè§£å†³è¯¥é—®é¢˜çš„æ–¹æ³•æ˜¯å…ˆç”Ÿæˆs1çš„ä¸€ä¸ªä»£ç†å¯¹è±¡æ³¨å…¥s2ï¼Œè€Œæ”¹ä»£ç†å¯¹è±¡çš„ç”Ÿæˆæ¨¡å¼ç”±@Scopeæ³¨è§£ä¸­çš„proxyModeå±æ€§å†³å®šï¼ˆcglibã€jdkç­‰ï¼‰ã€‚\nåœ¨@ComponentScanæ³¨è§£çš„scopeProxyå±æ€§ä¸­ä¹Ÿå¯ä»¥æ‰¹é‡é…ç½®ç±»çš„ä»£ç†å¯¹è±¡ç”Ÿæˆæ¨¡å¼ã€‚\nå¦‚æœç±»çš„@Scopeæ³¨è§£ä¸­æœªé…ç½®ä»£ç†æ¨¡å¼ï¼Œå°±ä½¿ç”¨@ComponentScanæ³¨è§£æ‰€é…ç½®çš„ã€‚")]),e._v(" "),n("h3",{attrs:{id:"_3-èµ„æºåŒ¹é…è§„åˆ™"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-èµ„æºåŒ¹é…è§„åˆ™"}},[e._v("#")]),e._v(" 3.èµ„æºåŒ¹é…è§„åˆ™")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('scanner.setResourcePattern(componentScan.getString("resourcePattern"));\n')])])]),n("p",[e._v("é»˜è®¤ä¸ºstatic final String DEFAULT_RESOURCE_PATTERN = â€œ**/*.classâ€ï¼›\nå³æ‰«æä¼ å…¥è·¯å¾„åŠå…¶å­è·¯å¾„ä¸‹çš„æ‰€æœ‰.classæ–‡ä»¶")]),e._v(" "),n("h3",{attrs:{id:"_4-ä¸¤ä¸ªfilter"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-ä¸¤ä¸ªfilter"}},[e._v("#")]),e._v(" 4.ä¸¤ä¸ªfilter")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('for (AnnotationAttributes includeFilterAttributes : componentScan.getAnnotationArray("includeFilters")) {\n            List<TypeFilter> typeFilters = TypeFilterUtils.createTypeFiltersFor(includeFilterAttributes, this.environment,\n                    this.resourceLoader, this.registry);\n            for (TypeFilter typeFilter : typeFilters) {\n                scanner.addIncludeFilter(typeFilter);\n            }\n        }\n        for (AnnotationAttributes excludeFilterAttributes : componentScan.getAnnotationArray("excludeFilters")) {\n            List<TypeFilter> typeFilters = TypeFilterUtils.createTypeFiltersFor(excludeFilterAttributes, this.environment,\n                this.resourceLoader, this.registry);\n            for (TypeFilter typeFilter : typeFilters) {\n                scanner.addExcludeFilter(typeFilter);\n            }\n        }\n')])])]),n("blockquote",[n("p",[e._v("excludeFilterï¼š excludeFilters = {@ComponentScan.Filter (type =\nFilterType.ASSIGNABLE_TYPE,classes = UserService. class)}\nå³æ’é™¤æ‰«æè·¯å¾„ä¸‹çš„UserService. classæ–‡ä»¶ï¼Œä¸åˆ›å»ºUserServiceçš„bean")])]),e._v(" "),n("h3",{attrs:{id:"_5-é…ç½®æ‡’åŠ è½½"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-é…ç½®æ‡’åŠ è½½"}},[e._v("#")]),e._v(" 5.é…ç½®æ‡’åŠ è½½")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('boolean lazyInit = componentScan.getBoolean("lazyInit");\n        if (lazyInit) {\n            scanner.getBeanDefinitionDefaults().setLazyInit(true);\n        }\n')])])]),n("h3",{attrs:{id:"_6-æ‰«æåŒ…è·¯å¾„"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-æ‰«æåŒ…è·¯å¾„"}},[e._v("#")]),e._v(" 6.æ‰«æåŒ…è·¯å¾„")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('Set<String> basePackages = new LinkedHashSet<>();\n        String[] basePackagesArray = componentScan.getStringArray("basePackages");//å¯ä»¥ä¼ å…¥å­—ç¬¦ä¸²æ•°ç»„\n        for (String pkg : basePackagesArray) {\n            String[] tokenized = StringUtils.tokenizeToStringArray(this.environment.resolvePlaceholders(pkg),\n                    ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);//æŒ‰ç…§è§„åˆ™è§£æ\n            Collections.addAll(basePackages, tokenized);\n        }\n        for (Class<?> clazz : componentScan.getClassArray("basePackageClasses")) {\n            basePackages.add(ClassUtils.getPackageName(clazz));\n        }\n        //ç©ºå¤„ç†\n        if (basePackages.isEmpty()) {\n            basePackages.add(ClassUtils.getPackageName(declaringClass));\n        }\n')])])]),n("p",[e._v("basePackageClasseså±æ€§ï¼šå°†ä¼ å…¥ç±»çš„åŒ…åä½œä¸ºè·¯å¾„ä¼ å…¥\nç©ºå¤„ç†ï¼šå¦‚æœæœªä¼ å…¥ä»»ä½•å‚æ•°ï¼Œå°±å°†æ·»åŠ è¯¥æ³¨è§£çš„configç±»çš„åŒ…è·¯å¾„ä½œä¸ºæ‰«æè·¯å¾„")]),e._v(" "),n("h3",{attrs:{id:"_7-æ’é™¤configç±»"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-æ’é™¤configç±»"}},[e._v("#")]),e._v(" 7.æ’é™¤configç±»")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("scanner.addExcludeFilter(new AbstractTypeHierarchyTraversingFilter(false, false) {\n            @Override\n            protected boolean matchClassName(String className) {\n                return declaringClass.equals(className);\n            }\n        });\n")])])]),n("p",[e._v("ExcludeFilterçš„ä½œç”¨ï¼š\næ’é™¤æ·»åŠ æ”¹æ³¨è§£çš„configç±»ã€‚å› ä¸ºconfigç±»åœ¨AnnotationConfigApplicationContext\napplicationContext = new\nAnnotationConfigApplicationContext(AppConfig.class)è¯­å¥ä¸­å·²ç»æ‰‹åŠ¨åŠ å…¥springå®¹å™¨")]),e._v(" "),n("h3",{attrs:{id:"_3ï¸âƒ£-return-scanner-doscan-åŒ…è·¯å¾„"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3ï¸âƒ£-return-scanner-doscan-åŒ…è·¯å¾„"}},[e._v("#")]),e._v(" 3ï¸âƒ£ï¼šreturn scanner.doScan(åŒ…è·¯å¾„)")]),e._v(" "),n("h3",{attrs:{id:"doscanæ–¹æ³•"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#doscanæ–¹æ³•"}},[e._v("#")]),e._v(" doScanæ–¹æ³•")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('protected Set<BeanDefinitionHolder> doScan(String... basePackages) {\n    Assert.notEmpty(basePackages, "At least one base package must be specified");\n    Set<BeanDefinitionHolder> beanDefinitions = new LinkedHashSet<>();\n    for (String basePackage : basePackages) {\n        //çœŸæ­£è¿›è¡Œæ‰«æï¼Œæ‰«æå¾—åˆ°çš„ç»“æœä¸ºBeanDefinition\n       Set<BeanDefinition> candidates = 1ï¸âƒ£findCandidateComponents(basePackage);\n       for (BeanDefinition candidate : candidates) {\n          ScopeMetadata scopeMetadata = this.scopeMetadataResolver.resolveScopeMetadata(candidate);\n          candidate.setScope(scopeMetadata.getScopeName());\n          String beanName = this.beanNameGenerator.generateBeanName(candidate, this.registry);\n          if (candidate instanceof AbstractBeanDefinition abstractBeanDefinition) {\n             postProcessBeanDefinition(abstractBeanDefinition, beanName);\n          }\n          if (candidate instanceof AnnotatedBeanDefinition annotatedBeanDefinition) {\n             AnnotationConfigUtils.processCommonDefinitionAnnotations(annotatedBeanDefinition);\n          }\n\n        //æ£€æŸ¥æ˜¯å¦æ‰«æåˆ°ç›¸åŒçš„BeanDefinitionã€‚ä¸åŒåŒ…å¯èƒ½æ‰«æåˆ°ç›¸åŒçš„bean\n          if (5ï¸âƒ£checkCandidate(beanName, candidate)) {\n             BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(candidate, beanName);\n             definitionHolder =\n                   AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, this.registry);\n             beanDefinitions.add(definitionHolder);\n             //åœ¨springå®¹å™¨ä¸­æ³¨å†Œ\n             registerBeanDefinition(definitionHolder, this.registry);\n          }\n       }\n    }\n    return beanDefinitions;\n}\n')])])]),n("h3",{attrs:{id:"_5ï¸âƒ£æ£€æµ‹æ˜¯å¦å­˜åœ¨ç›¸åŒåç§°çš„bean-checkcandidate-beanname"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5ï¸âƒ£æ£€æµ‹æ˜¯å¦å­˜åœ¨ç›¸åŒåç§°çš„bean-checkcandidate-beanname"}},[e._v("#")]),e._v(" 5ï¸âƒ£æ£€æµ‹æ˜¯å¦å­˜åœ¨ç›¸åŒåç§°çš„beanï¼šcheckCandidate(beanName,")]),e._v(" "),n("p",[e._v("candidate)")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('protected boolean checkCandidate(String beanName, BeanDefinition beanDefinition) throws IllegalStateException {\n    if (!this.registry.containsBeanDefinition(beanName)) {\n       return true;\n    }\n    BeanDefinition existingDef = this.registry.getBeanDefinition(beanName);\n    BeanDefinition originatingDef = existingDef.getOriginatingBeanDefinition();\n    if (originatingDef != null) {\n       existingDef = originatingDef;\n    }\n    if (6ï¸âƒ£isCompatible(beanDefinition, existingDef)) {  //åˆ¤æ–­æ˜¯å¦å…¼å®¹\n       return false;\n    }\n    //æŠ›å¼‚å¸¸ï¼Œspringå®¹å™¨ä¸èƒ½æ­£å¸¸å¯åŠ¨\n    throw new ConflictingBeanDefinitionException("Annotation-specified bean name \'" + beanName +\n          "\' for bean class [" + beanDefinition.getBeanClassName() + "] conflicts with existing, " +\n          "non-compatible bean definition of same name and class [" + existingDef.getBeanClassName() + "]");\n}\n')])])]),n("h3",{attrs:{id:"_6ï¸âƒ£åˆ¤æ–­æ˜¯å¦å…¼å®¹-iscompatible-beandefinition"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6ï¸âƒ£åˆ¤æ–­æ˜¯å¦å…¼å®¹-iscompatible-beandefinition"}},[e._v("#")]),e._v(" 6ï¸âƒ£åˆ¤æ–­æ˜¯å¦å…¼å®¹ï¼šisCompatible(beanDefinition,")]),e._v(" "),n("p",[e._v("existingDef))")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("protected boolean isCompatible(BeanDefinition newDef, BeanDefinition existingDef) {\n    //ä¸¤ä¸ªç±»ä¸ä¸€æ ·ï¼Œè¿”å›false->å¯¼è‡´æŠ›å¼‚å¸¸\n    return (!(existingDef instanceof ScannedGenericBeanDefinition) ||  // explicitly registered overriding bean\n          (newDef.getSource() != null && newDef.getSource().equals(existingDef.getSource())) ||  // scanned same file twice\n          newDef.equals(existingDef));  // scanned equivalent class twice\n}\n")])])]),n("h3",{attrs:{id:"_1ï¸âƒ£çœŸæ­£è¿›è¡Œæ‰«æçš„æ–¹æ³•-findcandidatecomponents"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1ï¸âƒ£çœŸæ­£è¿›è¡Œæ‰«æçš„æ–¹æ³•-findcandidatecomponents"}},[e._v("#")]),e._v(" 1ï¸âƒ£çœŸæ­£è¿›è¡Œæ‰«æçš„æ–¹æ³•ï¼šfindCandidateComponents")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("public Set<BeanDefinition> findCandidateComponents(String basePackage) {\n    //7ï¸âƒ£ä¼˜åŒ–çš„æ–¹æ³•\n    if (this.componentsIndex != null && indexSupportsIncludeFilters()) {\n       return addCandidateComponentsFromIndex(this.componentsIndex, basePackage);\n    }\n    else {\n        //ä¸€èˆ¬æ‰§è¡Œelse\n       return 2ï¸âƒ£scanCandidateComponents(basePackage);\n    }\n}\n")])])]),n("h3",{attrs:{id:"_7ï¸âƒ£componentsindexæœºåˆ¶"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7ï¸âƒ£componentsindexæœºåˆ¶"}},[e._v("#")]),e._v(" 7ï¸âƒ£componentsIndexæœºåˆ¶")]),e._v(" "),n("p",[e._v("åœ¨spring.componentsæ–‡ä»¶ä¸­æŒ‡å®šè¦æˆä¸ºbeançš„ç±»ã€‚\nspringåªä¼šå»æ‰«æspring.componentsæ–‡ä»¶ä¸­æŒ‡å®šçš„ç±»å¹¶ç”Ÿæˆbeanã€‚")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("com.example.service.Service1=org.springframework.stereotype.Component\n")])])]),n("h3",{attrs:{id:"_2ï¸âƒ£elseçš„æ–¹æ³•-scancandidatecomponents"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2ï¸âƒ£elseçš„æ–¹æ³•-scancandidatecomponents"}},[e._v("#")]),e._v(" 2ï¸âƒ£elseçš„æ–¹æ³•ï¼šscanCandidateComponents")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('private Set<BeanDefinition> scanCandidateComponents(String basePackage) {\n    Set<BeanDefinition> candidates = new LinkedHashSet<>();\n    try {\n       String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +\n             resolveBasePackage(basePackage) + \'/\' + this.resourcePattern;  //è·å–å®Œæ•´çš„è·¯å¾„\n       Resource[] resources = getResourcePatternResolver().getResources(packageSearchPath);//è·å–æ‰«æè·¯å¾„ä¸‹é¢çš„æ‰€æœ‰.classæ–‡ä»¶èµ„æº\n       boolean traceEnabled = logger.isTraceEnabled();\n       boolean debugEnabled = logger.isDebugEnabled();\n       for (Resource resource : resources) {\n          String filename = resource.getFilename();\n          if (filename != null && filename.contains(ClassUtils.CGLIB_CLASS_SEPARATOR)) {\n             // Ignore CGLIB-generated classes in the classpath\n             continue;\n          }\n          if (traceEnabled) {\n             logger.trace("Scanning " + resource);\n          }\n          try {\n             MetadataReader metadataReader = getMetadataReaderFactory().getMetadataReader(resource); //å¾—åˆ°ç±»çš„å…ƒæ•°æ®è¯»å–å™¨\n             if (3ï¸âƒ£isCandidateComponent(metadataReader)) {  //è¿›è¡Œç¬¬ä¸€æ¬¡åˆ¤æ–­\n                ScannedGenericBeanDefinition sbd = new ScannedGenericBeanDefinition(metadataReader);  //åˆ¤æ–­å®Œæˆåç”ŸæˆbeanDefinition\n                sbd.setSource(resource);\n                if (4ï¸âƒ£isCandidateComponent(sbd)) {  //è¿›è¡Œç¬¬äºŒæ¬¡åˆ¤æ–­\n                   if (debugEnabled) {\n                      logger.debug("Identified candidate component class: " + resource);\n                   }\n                   candidates.add(sbd);  //æ»¡è¶³æ¡ä»¶ååŠ å…¥é›†åˆè¿”å›\n                }\n                else {\n                   if (debugEnabled) {\n                      logger.debug("Ignored because not a concrete top-level class: " + resource);\n                   }\n                }\n             }\n             else {\n                if (traceEnabled) {\n                   logger.trace("Ignored because not matching any filter: " + resource);\n                }\n             }\n          }\n          catch (FileNotFoundException ex) {\n             if (traceEnabled) {\n                logger.trace("Ignored non-readable " + resource + ": " + ex.getMessage());\n             }\n          }\n          catch (Throwable ex) {\n             throw new BeanDefinitionStoreException(\n                   "Failed to read candidate component class: " + resource, ex);\n          }\n       }\n    }\n    catch (IOException ex) {\n       throw new BeanDefinitionStoreException("I/O failure during classpath scanning", ex);\n    }\n    return candidates;\n}\n')])])]),n("blockquote",[n("p",[e._v("é—®é¢˜ï¼šå¦‚ä½•å¾—åˆ°æ‰«æè·¯å¾„ä¸‹çš„ç±»çš„metadataï¼Ÿ")])]),e._v(" "),n("blockquote",[n("p",[e._v("è§£å†³ï¼š\nå¦‚æœä½¿ç”¨åå°„ï¼Œä¼šåœ¨springå®¹å™¨åŠ è½½çš„æ—¶å€™å°†æ‰«æè·¯å¾„ä¸‹çš„æ‰€æœ‰ç±»åŠ è½½åˆ°jvmä¸­ï¼Œå¦‚æœæ‰€æœ‰è¿™äº›ç±»ä¸­åªæœ‰æå°‘ä¸€éƒ¨åˆ†æœ€ç»ˆéœ€è¦æˆä¸ºbeanï¼Œä¼šé€ æˆå¾ˆå¤§çš„èµ„æºæµªè´¹\nä½¿ç”¨asmæŠ€æœ¯ï¼Œä¸æ¶‰åŠåˆ°ç±»çš„åŠ è½½å°±å¯ä»¥å¾—åˆ°ç±»çš„ä¿¡æ¯")])]),e._v(" "),n("p",[e._v("3ï¸âƒ£ç¬¬ä¸€æ¬¡åˆ¤æ–­isCandidateComponent(metadataReader)ï¼š")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("protected boolean isCandidateComponent(MetadataReader metadataReader) throws IOException {\n    for (TypeFilter tf : this.excludeFilters) {\n        //å¦‚æœè¯¥ç±»ä¿¡æ¯ä¸å…¶ä¸­ä¸€ä¸ªexcludeFiltersåŒ¹é…ï¼Œåˆ™è¿”å›falseï¼Œè¯¥ç±»ä¼šè¢«æ’é™¤æ‰\n       if (tf.match(metadataReader, getMetadataReaderFactory())) {\n          return false;\n       }\n    }\n    for (TypeFilter tf : this.includeFilters) {\n        //è‡³å°‘åŒ¹é…ä¸€ä¸ªincludeFiltersï¼Œæ‰æœ‰å¯èƒ½æˆä¸ºä¸€ä¸ªbean\n       if (tf.match(metadataReader, getMetadataReaderFactory())) {\n          return isConditionMatch(metadataReader);  //åˆ¤æ–­æœ‰æ²¡æœ‰@Conditionalæ³¨è§£ä¸”æ³¨è§£è‡ªå®šä¹‰çš„æ¡ä»¶\n\n       }\n    }\n    return false;\n}\n")])])]),n("blockquote",[n("p",[e._v("tf.match(metadataReader, getMetadataReaderFactory()):\nå¦‚æœæ²¡æœ‰æŒ‡å®šè¿‡æ»¤å™¨ï¼Œåˆ™ä¼šä½¿ç”¨é»˜è®¤è¿‡æ»¤å™¨ã€‚ é»˜è®¤è¿‡æ»¤å™¨åœ¨new\nscannerçš„æ—¶å€™è®¾ç½®ï¼šcomponentScan.getBoolean(â€œuseDefaultFiltersâ€)ï¼šé»˜è®¤ä¸ºtrueï¼Œå³ä½¿ç”¨é»˜è®¤çš„è¿‡æ»¤å™¨\nåœ¨scannerçš„æ„é€ æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨æ–¹æ³•è®¾ç½®ä¸‰ä¸ªincludeFilterï¼ˆä¸‰ä¸ªæ³¨è§£å¯¹åº”çš„è¿‡æ»¤å™¨ï¼Œ@Componentï¼Œ@Namedç­‰ï¼‰")])]),e._v(" "),n("blockquote",[n("p",[e._v("isConditionMatch(metadataReader)ï¼š\nåˆ¤æ–­æœ‰æ²¡æœ‰æ»¡è¶³åˆ©ç”¨@Conditionalæ³¨è§£è‡ªå®šä¹‰çš„æ¡ä»¶ã€‚\nå†™ä¸€ä¸ªé…ç½®ç±»cå®ç°Conditionæ¥å£ï¼Œé‡å†™matchesæ–¹æ³•ï¼Œ\nåœ¨å…¶ä¸­è‡ªå®šä¹‰beanåˆ›å»ºçš„æ¡ä»¶ã€‚serviceç±»ä¸­æ·»åŠ @Conditional(c.class)ä»¥ç”Ÿæ•ˆã€‚")])]),e._v(" "),n("p",[e._v("4ï¸âƒ£ç¬¬äºŒæ¬¡åˆ¤æ–­isCandidateComponent(sbd)ï¼š")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("protected boolean isCandidateComponent(AnnotatedBeanDefinition beanDefinition) {\n    AnnotationMetadata metadata = beanDefinition.getMetadata();\n    return (metadata.isIndependent() && (metadata.isConcrete() ||\n          (metadata.isAbstract() && metadata.hasAnnotatedMethods(Lookup.class.getName()))));\n}\n")])])]),n("blockquote",[n("p",[e._v("metadata.isIndependent()ï¼šæ˜¯å¦ä¸ºç‹¬ç«‹ç±»ã€‚éé™æ€çš„å†…éƒ¨ç±»ä¸æ˜¯ç‹¬ç«‹ç±»ï¼Œéé™æ€çš„å†…éƒ¨ç±»å®ä¾‹åŒ–è¦ä¾èµ–å¤–éƒ¨ç±»çš„å¯¹è±¡ã€‚éé™æ€çš„å†…éƒ¨ç±»è¢«æ’é™¤ä¸èƒ½ç”Ÿæˆbean\né™æ€çš„å†…éƒ¨ç±»å®ä¾‹åŒ–ä¸ä¾èµ–å¤–éƒ¨ç±»çš„å¯¹è±¡ï¼Œå¯ä»¥ç”Ÿæˆbean")])]),e._v(" "),n("blockquote",[n("p",[e._v("metadata.isConcrete()ï¼šæ—¢ä¸æ˜¯æ¥å£ä¹Ÿä¸æ˜¯æŠ½è±¡ç±»ï¼Œè¿”å›trueã€‚æ¥å£å’ŒæŠ½è±¡ç±»ä¸èƒ½å®ä¾‹åŒ–ï¼Œä¸èƒ½ç”Ÿæˆbeanå¯¹è±¡ã€‚mybatisä¸­çš„mapperæ¥å£é€šè¿‡åŠ¨æ€ä»£ç†ç”Ÿæˆä»£ç†ç±»çš„beanå¯¹è±¡")])]),e._v(" "),n("blockquote",[n("p",[e._v("metadata.isAbstract() &&\nmetadata.hasAnnotatedMethods(Lookup.class.getName()ï¼šæ˜¯æŠ½è±¡ç±»ä¸”ç±»ä¸­å­˜åœ¨æ·»åŠ äº†Lookupæ³¨è§£çš„æ–¹æ³•\nï¼Œä¹Ÿè¿”å›true sd ç‹¬ç«‹çš„ ä¸” ç±»ä¸­å­˜åœ¨æ·»åŠ äº†Lookupæ³¨è§£çš„æ–¹æ³• çš„ æŠ½è±¡ç±»\nç”Ÿæˆçš„beanå¯¹è±¡æ˜¯å…¶ä»£ç†å¯¹è±¡")])]),e._v(" "),n("h2",{attrs:{id:"å…³äº-lookupæ³¨è§£"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#å…³äº-lookupæ³¨è§£"}},[e._v("#")]),e._v(" å…³äº@Lookupæ³¨è§£")]),e._v(" "),n("blockquote",[n("p",[e._v("@Lookupæ³¨è§£çš„å±æ€§éœ€è¦æŒ‡å®šä¸€ä¸ªbeanåå­—ï¼Œ@Lookup(beanå)")])]),e._v(" "),n("blockquote",[n("p",[e._v("æ·»åŠ äº†@Lookupæ³¨è§£çš„æ–¹æ³•ä¸ä¼šæ‰§è¡Œæ–¹æ³•é‡Œçš„é€»è¾‘ï¼Œåªä¼šè¿”å›beanåå­—å¯¹åº”çš„beanã€‚\nå› æ­¤è¿”å›å€¼ç±»å‹ä¸ºbeanå¯¹è±¡çš„ç±»å‹ã€‚")])]),e._v(" "),n("blockquote",[n("p",[e._v("é—®é¢˜ï¼šå‡è®¾s1ç±»æ˜¯singletonï¼Œs2ç±»æ˜¯prototypeä¸”s1ç±»ä¸­æœ‰å±æ€§s2ã€‚\n1.åœ¨s1ä¸­ç”¨æ™®é€šæ–¹æ³•ç›´æ¥æ‰“å°å¤šæ¬¡s2å¾—åˆ°çš„s2å¯¹è±¡æ˜¯åŒä¸€ä¸ªå—ï¼Ÿ\n2.ç”¨s1çš„æ·»åŠ äº†@Lookupæ³¨è§£çš„æ–¹æ³•è·å–s2ï¼Œå¾—åˆ°çš„s2å¯¹è±¡æ˜¯åŒä¸€ä¸ªå—ï¼Ÿ")])]),e._v(" "),n("blockquote",[n("p",[e._v("ç­”æ¡ˆï¼š 1.æ˜¯åŒä¸€ä¸ªã€‚å› ä¸ºs1ä¸­çš„s2å±æ€§åœ¨åˆ›å»ºs1çš„beançš„æ—¶å€™å·²ç»æ³¨å…¥ã€‚\n2.ä¸æ˜¯åŒä¸€ä¸ªã€‚")])])])}),[],!1,null,null,null);n.default=s.exports}}]);