<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CAS和Atomic类 | Sardinary&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content=" ">
    
    <link rel="preload" href="/Sardinary/assets/css/0.styles.cca88062.css" as="style"><link rel="preload" href="/Sardinary/assets/js/app.b4352b80.js" as="script"><link rel="preload" href="/Sardinary/assets/js/7.1de0e771.js" as="script"><link rel="preload" href="/Sardinary/assets/js/2.32e86603.js" as="script"><link rel="preload" href="/Sardinary/assets/js/1.87af8fda.js" as="script"><link rel="preload" href="/Sardinary/assets/js/16.16e886bc.js" as="script"><link rel="prefetch" href="/Sardinary/assets/js/10.49a810cd.js"><link rel="prefetch" href="/Sardinary/assets/js/11.7175f7e3.js"><link rel="prefetch" href="/Sardinary/assets/js/14.a5477566.js"><link rel="prefetch" href="/Sardinary/assets/js/15.439772b1.js"><link rel="prefetch" href="/Sardinary/assets/js/17.0e6e36bb.js"><link rel="prefetch" href="/Sardinary/assets/js/18.5e148afa.js"><link rel="prefetch" href="/Sardinary/assets/js/19.73412c71.js"><link rel="prefetch" href="/Sardinary/assets/js/20.e6e484b2.js"><link rel="prefetch" href="/Sardinary/assets/js/21.7c59eb62.js"><link rel="prefetch" href="/Sardinary/assets/js/22.1a4515f8.js"><link rel="prefetch" href="/Sardinary/assets/js/23.77f49651.js"><link rel="prefetch" href="/Sardinary/assets/js/24.2978efd9.js"><link rel="prefetch" href="/Sardinary/assets/js/25.c67021f4.js"><link rel="prefetch" href="/Sardinary/assets/js/26.6879f189.js"><link rel="prefetch" href="/Sardinary/assets/js/27.a2713265.js"><link rel="prefetch" href="/Sardinary/assets/js/28.0e7ec6a5.js"><link rel="prefetch" href="/Sardinary/assets/js/29.b33743d7.js"><link rel="prefetch" href="/Sardinary/assets/js/3.5b666661.js"><link rel="prefetch" href="/Sardinary/assets/js/30.3b66f6c0.js"><link rel="prefetch" href="/Sardinary/assets/js/31.a9a2ab1e.js"><link rel="prefetch" href="/Sardinary/assets/js/32.14ad86fd.js"><link rel="prefetch" href="/Sardinary/assets/js/33.1afd794c.js"><link rel="prefetch" href="/Sardinary/assets/js/34.31730445.js"><link rel="prefetch" href="/Sardinary/assets/js/35.acb79716.js"><link rel="prefetch" href="/Sardinary/assets/js/36.f161e3da.js"><link rel="prefetch" href="/Sardinary/assets/js/37.164bb569.js"><link rel="prefetch" href="/Sardinary/assets/js/38.0e4326d9.js"><link rel="prefetch" href="/Sardinary/assets/js/39.c0cdc477.js"><link rel="prefetch" href="/Sardinary/assets/js/4.95ecc938.js"><link rel="prefetch" href="/Sardinary/assets/js/40.4c8a03a6.js"><link rel="prefetch" href="/Sardinary/assets/js/41.b3e26267.js"><link rel="prefetch" href="/Sardinary/assets/js/42.6526990c.js"><link rel="prefetch" href="/Sardinary/assets/js/43.237a07a2.js"><link rel="prefetch" href="/Sardinary/assets/js/44.20a80a6c.js"><link rel="prefetch" href="/Sardinary/assets/js/45.ee53ec88.js"><link rel="prefetch" href="/Sardinary/assets/js/46.55f62d10.js"><link rel="prefetch" href="/Sardinary/assets/js/47.2a4b0a3b.js"><link rel="prefetch" href="/Sardinary/assets/js/48.d2f40143.js"><link rel="prefetch" href="/Sardinary/assets/js/49.6f809adc.js"><link rel="prefetch" href="/Sardinary/assets/js/5.c87bfc3b.js"><link rel="prefetch" href="/Sardinary/assets/js/50.e8110b40.js"><link rel="prefetch" href="/Sardinary/assets/js/51.e5d33d8f.js"><link rel="prefetch" href="/Sardinary/assets/js/52.35081e55.js"><link rel="prefetch" href="/Sardinary/assets/js/53.f148b50f.js"><link rel="prefetch" href="/Sardinary/assets/js/54.c9fddbbe.js"><link rel="prefetch" href="/Sardinary/assets/js/55.3bf482f3.js"><link rel="prefetch" href="/Sardinary/assets/js/56.284247d8.js"><link rel="prefetch" href="/Sardinary/assets/js/57.cd2fa388.js"><link rel="prefetch" href="/Sardinary/assets/js/58.9717d8f3.js"><link rel="prefetch" href="/Sardinary/assets/js/59.387411ca.js"><link rel="prefetch" href="/Sardinary/assets/js/6.363116dc.js"><link rel="prefetch" href="/Sardinary/assets/js/60.10700fc9.js"><link rel="prefetch" href="/Sardinary/assets/js/61.37f12cd5.js"><link rel="prefetch" href="/Sardinary/assets/js/62.1ee2e76e.js"><link rel="prefetch" href="/Sardinary/assets/js/63.05cc0dee.js"><link rel="prefetch" href="/Sardinary/assets/js/64.2eefe5c7.js"><link rel="prefetch" href="/Sardinary/assets/js/65.57aedaf0.js"><link rel="prefetch" href="/Sardinary/assets/js/66.3362b95c.js"><link rel="prefetch" href="/Sardinary/assets/js/67.31c9d9fd.js"><link rel="prefetch" href="/Sardinary/assets/js/68.966d4fa1.js"><link rel="prefetch" href="/Sardinary/assets/js/69.a33abe62.js"><link rel="prefetch" href="/Sardinary/assets/js/70.11dd9007.js"><link rel="prefetch" href="/Sardinary/assets/js/71.8006b388.js"><link rel="prefetch" href="/Sardinary/assets/js/72.73f1646b.js"><link rel="prefetch" href="/Sardinary/assets/js/73.f53d7f97.js"><link rel="prefetch" href="/Sardinary/assets/js/74.db2bf712.js"><link rel="prefetch" href="/Sardinary/assets/js/8.1ffd42bb.js"><link rel="prefetch" href="/Sardinary/assets/js/9.8e14a092.js"><link rel="prefetch" href="/Sardinary/assets/js/vendors~docsearch.34a230bb.js">
    <link rel="stylesheet" href="/Sardinary/assets/css/0.styles.cca88062.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Sardinary's Blog</h3> <p class="description" data-v-59e6cb88> </p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Sardinary Chen</span>
          
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Sardinary/" class="home-link router-link-active"><img src="/Sardinary/avatar.jpg" alt="Sardinary's Blog" class="logo"> <span class="site-name">Sardinary's Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Sardinary/" class="nav-link"><i class="undefined"></i>
  🏠
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Sardinary/categories/后端/" class="nav-link"><i class="undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/Sardinary/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Sardinary 🎈
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Xiangyinfly" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/Sardinary/avatar.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    Sardinary Chen
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>36</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>12</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/Sardinary/" class="nav-link"><i class="undefined"></i>
  🏠
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Sardinary/categories/后端/" class="nav-link"><i class="undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/Sardinary/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Sardinary 🎈
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Xiangyinfly" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>CAS和Atomic类</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Sardinary Chen</span>
          
        <!---->
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">CAS和Atomic类</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>Sardinary Chen</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2/26/2024</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>JUC</span><span class="tag-item" data-v-8a445198>Java进阶</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="cas是什么"><a href="#cas是什么" class="header-anchor">#</a> CAS是什么</h1> <ul><li><p>compare and swap，比较并交换</p></li> <li><p>包含三个操作数</p> <ul><li>内存位置</li> <li>预期原值</li> <li>更新值</li></ul></li> <li><p>执行CAS时，会将内存位置的值和预期原值比较</p> <ul><li>如果相匹配，处理器会自动将该位置值更新为新值</li> <li>如果不匹配，处理器不做操作，或者重试（自旋）</li> <li>多个线程同时执行CAS只有一个会成功</li></ul></li> <li><p>是JDK提供的非阻塞原子性操作，通过硬件保证了比较-更新的原子性</p></li> <li><p>是一条CPU的原子指令（cmpxchg指令），不会造成数据不一致。Unsafe提供的CAS方法（如compareAndSwapXXX）底层实现即为CPU指令cmpxchg</p> <p>执行cmpxchg的时候，会判断当前系统是否为多核系统，如果是就给总线加锁，只有一个线程会对总线加锁成功，加锁成功后会执行cas，即cas的原子性实际上是CPU实现独占的</p> <p>比起用synchronized加锁，cas排他时间短很多，多线程情况下性能好</p></li></ul> <h1 id="unsafe类"><a href="#unsafe类" class="header-anchor">#</a> Unsafe类</h1> <ul><li>是CAS的核心类</li> <li>Java需要native方法才能访问底层系统，unsafe相当于一个后门，基于该类可以直接操作特定内存的数据</li> <li>unsafe类中的所有方法都是native修饰的，也就是说unsafe类中的方法都直接调用操作系统底层资源执行相应任务</li></ul> <p><img src="/Sardinary/assets/img/Untitled26.6e350149.png" alt="Untitled"></p> <ul><li><p>valueOffset表示该变量值在内存中的偏移地址，因为unsafe是根据内存偏移地址获取数据的</p></li> <li><p>变量value用volatile修饰，保证多线程之间的内存可见性（所以CAS底层加了锁？？）</p></li> <li><p>AtomicInteger主要利用CAS+volatile和native方法来保证原子操作，避免加锁的高开销</p></li> <li><p>getAndIncrement方法分析</p> <ul><li>var1:this</li> <li>var2:偏移量valueOffset</li> <li>var4:自增的量，此处为1</li> <li>var5:内存中得到的value最新值</li></ul> <p><img src="/Sardinary/assets/img/Untitled27.24f9907c.png" alt="Untitled"></p></li> <li><p>底层</p> <p><img src="/Sardinary/assets/img/Untitled28.edd6d295.png" alt="Untitled"></p></li></ul> <h1 id="原子引用"><a href="#原子引用" class="header-anchor">#</a> 原子引用</h1> <ul><li><p>利用泛型实现自定义类的原子化</p> <p><img src="/Sardinary/assets/img/Untitled29.a773a4cb.png" alt="Untitled"></p></li></ul> <h1 id="自旋锁"><a href="#自旋锁" class="header-anchor">#</a> <a href="/Sardinary/blogs/JUC/锁 35759a4548ac42698d4ae24ab59a62ea.html">自旋锁</a></h1> <h1 id="cas缺点"><a href="#cas缺点" class="header-anchor">#</a> CAS缺点</h1> <ul><li>如果CAS一直失败会一直进行尝试。循环时间长开销很大</li> <li>只能保证一个共享变量的原子性
<ul><li>当对一个共享变量执行操作时,我们可以使用循环CAS的方式来保证原子操作</li> <li>对多个共享变量操作时,循环CAS就无法保证操作的原子性,这个时候就可以用锁来保证原子性</li></ul></li> <li>ABA问题
<ul><li>比如，一个线程one从内存位置V中取出A,这时候另一个线程two也从内存中取出A,并且线程two进行了一些操作将值变成了B,然后线程two又将V位置的数据变成A,这时候线程one进行CAS操作发现内存中仍然是A,然后线程one操作成功</li> <li>尽管线程one的CAS操作成功,但是不代表这个过程就是没问题的</li> <li><a href="/Sardinary/blogs/JUC/CAS和Atomic类 532499754a134662add3f629b929a7e6.html">解决：AtomicStampedReference</a></li></ul></li></ul> <h2 id="atomicstampedreference类"><a href="#atomicstampedreference类" class="header-anchor">#</a> AtomicStampedReference类</h2> <ul><li><p>ABA问题解决方案是使用 AtomicStampedReference，每修改一次都会有一个版本号</p></li> <li><p>AtomicStampedReference用来解决AtomicInteger中的ABA问题，该demo企图将integer的值从0一直增长到1000，但当integer的值增长到128后，将停止增长。</p> <p>出现该现象有两点原因：</p> <ul><li>使用int类型而非Integer保存当前值</li> <li>Interger对-128~127的缓存这个范围才有效,不在这个范围comareAndSet会一直返回false</li></ul></li></ul> <h1 id="原子类"><a href="#原子类" class="header-anchor">#</a> 原子类</h1> <h2 id="基本类型原子类"><a href="#基本类型原子类" class="header-anchor">#</a> 基本类型原子类</h2> <h3 id="常用api"><a href="#常用api" class="header-anchor">#</a> 常用API</h3> <table><thead><tr><th>方法</th> <th>解释</th></tr></thead> <tbody><tr><td>public final int get()</td> <td>获取当前的值</td></tr> <tr><td>public final int getAndSet(int newValue)</td> <td>获取到当前的值,并设置新的值</td></tr> <tr><td>public final int getAndIncrement()</td> <td>获取当前的值,并自增</td></tr> <tr><td>public final int getAndDecrement()</td> <td>获取到当前的值,并自减</td></tr> <tr><td>public final int getAndAdd(int delta)</td> <td>获取到当前的值,并加上预期的值</td></tr> <tr><td>public final int incrementAndGet( )</td> <td>返回的是加1后的值</td></tr> <tr><td>boolean compareAndSet(int expect,int update)</td> <td>如果输入的数值等于预期值,返回true</td></tr></tbody></table> <ul><li><p>AtomicInteger</p> <ul><li><p>CountDownLatch的应用</p> <ul><li><p>问题处：</p> <p>main线程执行完for循环就马上执行下面的输出</p> <p>但此时被循环调用的多个线程可能并没有执行完，因此输出的result可能会小于理论值</p> <p>此时可以使用CountDownLatch</p></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicIntegerDemo</span> <span class="token punctuation">{</span>
    <span class="token class-name">AtomicInteger</span> atomicInteger<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPlusPlus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        atomicInteger<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">CountDownLatch</span> countDownLatch<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AtomicIntegerDemo</span> atomic<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicIntegerDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 10个线程进行循环100次调用addPlusPlus的操作,最终结果是10*100=1000</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
               <span class="token keyword">try</span><span class="token punctuation">{</span>
                   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       atomic<span class="token punctuation">.</span><span class="token function">addPlusPlus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token punctuation">}</span>
               <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
                   countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
				 <span class="token comment">//问题处</span>
        <span class="token comment">//(1). 如果不加上下面的停顿3秒的时间,会导致还没有进行i++ 1000次main线程就已经结束了</span>
				 <span class="token comment">//但是停顿的秒数不太好确定，需要更优雅的方法</span>
        <span class="token comment">// try { TimeUnit.SECONDS.sleep(3);  } catch (InterruptedException e) {e.printStackTrace();}</span>
        <span class="token comment">//(2). 使用CountDownLatch去解决等待时间的问题</span>
        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\t&quot;</span><span class="token operator">+</span><span class="token string">&quot;获取到的result:&quot;</span><span class="token operator">+</span>atomic<span class="token punctuation">.</span>atomicInteger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><p>AtomicBoolean</p> <ul><li>可以作为中断标识停止线程的方式</li></ul></li> <li><p>AtomicLong</p> <ul><li><p>AtomicLong的底层是CAS+自旋锁的思想,适用于低并发的全局计算,高并发后性能急剧下降</p> <p>原因如下:N个线程CAS操作修改线程的值,每次只有一个成功过,其他N-1失败,失败的不停的自旋直到成功,这样大量失败自旋的情况,一下子cpu就打高了(AtomicLong的自旋会成为瓶颈)</p></li> <li><p>在高并发的情况下,我们使用LoadAdder</p></li></ul></li></ul> <h2 id="数组类型原子类"><a href="#数组类型原子类" class="header-anchor">#</a> <strong>数组类型原子类</strong></h2> <ul><li>AtomicIntegerArray</li> <li>AtomicLongArray</li> <li>AtomicReferenceArray</li></ul> <h2 id="引用类型原子类"><a href="#引用类型原子类" class="header-anchor">#</a> <strong>引用类型原子类</strong></h2> <ul><li>AtomicReference</li> <li>AtomicStampedReference
<ul><li>解决ABA问题</li></ul></li> <li>AtomicMark ableReference
<ul><li>原子更新带有标志位的引用类型对象</li> <li>只有true和false两种类型</li> <li>解决是否修改(它的定义就是将状态戳简化位true|false),一次性</li> <li>状态戳(true/false)原子引用</li> <li>不建议用它解决ABA问题</li></ul></li></ul> <h2 id="对象属性修改原子类"><a href="#对象属性修改原子类" class="header-anchor">#</a> <strong>对象属性修改原子类</strong></h2> <ul><li><p>目的</p> <ul><li>可以以一种线程安全的方式操作非线程安全对象内的某些字段</li> <li>可以避免锁定整个对象,减少锁定的范围,只关注长期、敏感性变化的某一个字段,而不是整个对象,达到精确加锁+节约内存的目的</li></ul></li> <li><p>使用</p> <ul><li>更新的对象属性必须使用public volatile修饰符</li> <li>因为对象的属性修改类型原子类都是抽象类,所以每次使用都必须使用静态方法newUpdater()创建一个更新器,并且需要设置想要更新的类和属性</li></ul></li> <li><p>类型</p> <ul><li><p>AtomicIntegerFieldUpdater</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicIntegerFieldUpdaterDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">BankAccount</span> bankAccount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BankAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    bankAccount<span class="token punctuation">.</span><span class="token function">changeMoney</span><span class="token punctuation">(</span>bankAccount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bankAccount<span class="token punctuation">.</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">BankAccount</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> bankName<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> money<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">AtomicIntegerFieldUpdater</span> atomicIntegerFieldUpdater <span class="token operator">=</span> <span class="token class-name">AtomicIntegerFieldUpdater</span><span class="token punctuation">.</span><span class="token function">newUpdater</span><span class="token punctuation">(</span><span class="token class-name">BankAccount</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">changeMoney</span><span class="token punctuation">(</span><span class="token class-name">BankAccount</span> bankAccount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        atomicIntegerFieldUpdater<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span>bankAccount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>AtomicReferenceFieldUpdater</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">MyVar</span> <span class="token comment">//资源类</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">volatile</span> <span class="token class-name">Boolean</span> isInit <span class="token operator">=</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">;</span>

    <span class="token class-name">AtomicReferenceFieldUpdater</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MyVar</span><span class="token punctuation">,</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> referenceFieldUpdater <span class="token operator">=</span>
            <span class="token class-name">AtomicReferenceFieldUpdater</span><span class="token punctuation">.</span><span class="token function">newUpdater</span><span class="token punctuation">(</span><span class="token class-name">MyVar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token string">&quot;isInit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">MyVar</span> myVar<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>referenceFieldUpdater<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>myVar<span class="token punctuation">,</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">,</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\t&quot;</span><span class="token operator">+</span><span class="token string">&quot;----- start init,need 2 seconds&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//暂停几秒钟线程</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\t&quot;</span><span class="token operator">+</span><span class="token string">&quot;----- over init&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\t&quot;</span><span class="token operator">+</span><span class="token string">&quot;----- 已经有线程在进行初始化工作。。。。。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicReferenceFieldUpdaterDemo</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">MyVar</span> myVar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyVar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span><span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                myVar<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>myVar<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li></ul> <h2 id="原子操作增强类"><a href="#原子操作增强类" class="header-anchor">#</a> 原子操作增强类</h2> <p><img src="/Sardinary/assets/img/Untitled30.ef4d092a.png" alt="Untitled"></p> <h3 id="常用api-2"><a href="#常用api-2" class="header-anchor">#</a> 常用API</h3> <table><thead><tr><th>方法</th> <th>解释</th></tr></thead> <tbody><tr><td>void add(long x)</td> <td>将当前的value加1</td></tr> <tr><td>void increment( )</td> <td>将当前的value加1</td></tr> <tr><td>void decrement( )</td> <td>将当前value减1</td></tr> <tr><td>long sum( )</td> <td>返回当前的值,特别注意,在没有并发更新value的情况下</td></tr> <tr><td></td> <td>sum会返回一个精确值,在存在并发的情况下,sum不保证返回精确值</td></tr> <tr><td>long longvale</td> <td>等价于long sum( )</td></tr> <tr><td></td> <td>将value重置为0,可用于替换重新new一个LongAdder,但次方法只可以在没有并发更新的情况下使用</td></tr> <tr><td>long sumThenReset()</td> <td>获取当前value,并将value重置为0</td></tr></tbody></table> <ul><li><p>DoubleAccumulator</p></li> <li><p>DoubleAdder</p></li> <li><p>LongAccumulator</p> <ul><li>用来计算加法、减法,且从零开始计算</li></ul></li> <li><p>LongAdder</p> <ul><li>提供了自定义的函数操作</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">LongAccumulator</span> longAccumulator<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LongAccumulator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LongBinaryOperator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">applyAsLong</span><span class="token punctuation">(</span><span class="token keyword">long</span> left<span class="token punctuation">,</span> <span class="token keyword">long</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> left <span class="token operator">*</span> right<span class="token punctuation">;</span><span class="token comment">//这里指定什么运算</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//第二个参数指定初始值</span>
</code></pre></div></li></ul> <h3 id="atomiclong和longadder的区别"><a href="#atomiclong和longadder的区别" class="header-anchor">#</a> <strong>AtomicLong和LongAdder的区别</strong></h3> <p><img src="/Sardinary/assets/img/Untitled31.0b4094e7.png" alt="Untitled"></p> <p><img src="/Sardinary/assets/img/Untitled32.16cc3694.png" alt="Untitled"></p> <h2 id="源码分析-以longadder为例"><a href="#源码分析-以longadder为例" class="header-anchor">#</a> 源码分析 <em>以LongAdder为例</em></h2> <ul><li>LongAdder是<a href="/Sardinary/blogs/JUC/CAS和Atomic类 532499754a134662add3f629b929a7e6.html">Strip64</a>的子类</li></ul> <p><img src="/Sardinary/assets/img/Untitled33.6664d1bf.png" alt="Untitled"></p> <h3 id="为什么longadder这么快"><a href="#为什么longadder这么快" class="header-anchor">#</a> 为什么LongAdder这么快</h3> <ul><li><p>内部是一个Base+一个Cell[]数组</p> <ul><li>base变量：非竞争状态条件下,直接累加到该变量上</li> <li>Cell[]数组:竞争条件下(高并发下),累加各个线程自己的槽Cell[i]中</li></ul></li> <li><p>LongAdder在无竞争的情况,跟AtomicLong一样,对同一个base进行操作,当出现竞争关系时则采用化整为零的做法,从空间换时间,用一个数组cells,将一个value拆分进这个数组cells</p> <p>多个线程需要同时对value进行操作时候,可以对线程id进行hash得到hash值,再根据hash值映射到这个数组cells的某个下标,再对该下标所对应的值进行自增操作</p> <p>当所有线程操作完毕,将数组cells的所有值和无竞争值base都加起来作为最终结果(分散热点)</p></li> <li><p>sum()会将所有cell数组中的value和base累加作为返回值,核心的思想就是将之前AtomicLong一个value的更新压力分散到多个value中去,从而降级更新热点</p></li></ul> <p><img src="/Sardinary/assets/img/Untitled34.7de2c7e0.png" alt="Untitled"></p> <h3 id="源码解读-以longadder-increment-为例"><a href="#源码解读-以longadder-increment-为例" class="header-anchor">#</a> 源码解读 <em>以longAdder.increment()为例</em></h3> <p><strong>increment()</strong></p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">/**
     * Equivalent to {@code add(1)}.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><strong>→ add(long x)</strong></p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Cell</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cs<span class="token punctuation">;</span> <span class="token keyword">long</span> b<span class="token punctuation">,</span> v<span class="token punctuation">;</span> <span class="token keyword">int</span> m<span class="token punctuation">;</span> <span class="token class-name">Cell</span> c<span class="token punctuation">;</span>
				<span class="token comment">//if1:cell数组不为空</span>
				<span class="token comment">//if2:base更新失败</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cs <span class="token operator">=</span> cells<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">casBase</span><span class="token punctuation">(</span>b <span class="token operator">=</span> base<span class="token punctuation">,</span> b <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">getProbe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> uncontended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//默认没有冲突为true</span>
							<span class="token comment">//if1:cell数组为空</span>
							<span class="token comment">//if2:cell数组长度小于0</span>
							<span class="token comment">//if3:当前线程所在的cell为空，说明当前线程还没更新过cell</span>
							<span class="token comment">//if4:更新当前线程的cell失败，说明竞争激烈出现冲突，应该扩容</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cs <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> cs<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
                <span class="token punctuation">(</span>c <span class="token operator">=</span> cs<span class="token punctuation">[</span>index <span class="token operator">&amp;</span> m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
                <span class="token operator">!</span><span class="token punctuation">(</span>uncontended <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">cas</span><span class="token punctuation">(</span>v <span class="token operator">=</span> c<span class="token punctuation">.</span>value<span class="token punctuation">,</span> v <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">longAccumulate</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> uncontended<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre></div><ul><li><p>cs表示cells引用</p></li> <li><p>b表示获取的base值</p></li> <li><p>v表示期望值</p></li> <li><p>m表示cells数组的长度</p></li> <li><p>c表示当前线程命中的cell单元格</p></li> <li><p>cells即Striped类中的属性*<code>transient volatile* Cell[] cells</code></p></li> <li><p>casBase，即对base进行cas操作</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token comment">/**
     * CASes the base field.
     */</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">casBase</span><span class="token punctuation">(</span><span class="token keyword">long</span> cmp<span class="token punctuation">,</span> <span class="token keyword">long</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">BASE</span><span class="token punctuation">.</span><span class="token function">weakCompareAndSetRelease</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> cmp<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div></li> <li><p>uncontended，即没有冲突，默认为true</p></li> <li><p>getProbe()，返回的是线程中的threadLocalRandomProbe字段，是通过随机数生成一个值，对对于一个确定的线程这个值是固定的（除非刻意修改）</p> <p><img src="/Sardinary/assets/img/Untitled35.3a661dff.png" alt="Untitled"></p></li></ul> <p><strong>流程：</strong></p> <ul><li><p>当最开始并发压力小的时候，<code>!casBase(b = base, b + x)</code> 执行成功，表达式值为false，由于cells数组未新建，<code>(cs = cells) != null</code> 返回false，方法结束</p></li> <li><p>并发压力增大的时候，当第一次 <code>!casBase(b = base, b + x)</code> 开始出现比对失败，表达式返回为true，进入第一个if</p> <p>由于cs==null为true，进入第二个if，执行<a href="/Sardinary/blogs/JUC/CAS和Atomic类 532499754a134662add3f629b929a7e6.html">longAccumulate</a>方法，进行cell数组初始化</p></li> <li><p>之后通过getProbe得到cells数组里一个具体的槽位索引index</p> <ul><li>如果index处槽位存在：即槽位不为null，则<code>(c = cs[index &amp; m]) == null</code> 为false，并且index赋值给c，在<code>c.cas(v = c.value, v + x)</code> 中进行cas操作
<ul><li>如果index处槽位空闲：即cas操作返回true并赋值给uncontended，此时<code>!(uncontended = c.cas(v = c.value, v + x))</code> 返回为false</li></ul></li></ul> <p>→ 即：if语句四个条件都不成立，不走longAccumulate方法，不必进行cell数组扩容</p> <ul><li>如果index处 槽位不存在 和 槽位不空闲，这两者多于一个成立，即cells数组槽位不够用了，if条件就成立，走longAccumulate方法进行cell数组扩容</li></ul> <aside>
  👏 因此，`(c = cs[index &amp; m]) == null || !(uncontended = c.cas(v = c.value, v + x))` 这两个判断是在筛选 找不到对应下标的cell 或者 出现cell冲突 这两种情况，然后使这两种情况进入longAccumulate方法进行cells扩容
  </aside></li></ul> <p><strong>总结：</strong></p> <ul><li>最初无竞争的时候只更新base</li> <li>更新base失败后，首次新建一个cell[]数组</li> <li>当多个线程竞争同一个cell激烈时，可能要对cell数组进行扩容</li></ul> <p><img src="/Sardinary/assets/img/Untitled36.eb50b3e5.png" alt="Untitled"></p> <p><img src="/Sardinary/assets/img/Untitled37.646dd14e.png" alt="Untitled"></p> <p><strong>→ longAccumulate(x, null, uncontended, index)</strong></p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token comment">/**
     * Handles cases of updates involving initialization, resizing,
     * creating new Cells, and/or contention. See above for
     * explanation. This method suffers the usual non-modularity
     * problems of optimistic retry code, relying on rechecked sets of
     * reads.
     *
     * @param x the value
     * @param fn the update function, or null for add (this convention
     * avoids the need for an extra field or function in LongAdder).
     * @param wasUncontended false if CAS failed before call
     * @param index thread index from getProbe
     */</span>
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">longAccumulate</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token class-name">LongBinaryOperator</span> fn<span class="token punctuation">,</span>
                              <span class="token keyword">boolean</span> wasUncontended<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">//如果add方法中的getProbe返回0，即index==0，说明index未初始化</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">//使用ThreadLocalRandom为当前线程重新计算一个hash值，强制初始化</span>
            <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// force initialization</span>
						<span class="token comment">//重新获得probe值</span>
            index <span class="token operator">=</span> <span class="token function">getProbe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token comment">//hash值被重置就好比变成了一个全新的线程，所以设置了wasUncontended(即 非竞争状态)为true</span>
            wasUncontended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">boolean</span> collide <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment">// True if last slot nonempty</span>
            <span class="token class-name">Cell</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cs<span class="token punctuation">;</span> <span class="token class-name">Cell</span> c<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">;</span> <span class="token keyword">long</span> v<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cs <span class="token operator">=</span> cells<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> cs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> cs<span class="token punctuation">[</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cellsBusy <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment">// Try to attach new Cell</span>
                        <span class="token class-name">Cell</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cell</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Optimistically create</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>cellsBusy <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">casCellsBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">try</span> <span class="token punctuation">{</span>               <span class="token comment">// Recheck under lock</span>
                                <span class="token class-name">Cell</span><span class="token punctuation">[</span><span class="token punctuation">]</span> rs<span class="token punctuation">;</span> <span class="token keyword">int</span> m<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rs <span class="token operator">=</span> cells<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                                    <span class="token punctuation">(</span>m <span class="token operator">=</span> rs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                                    rs<span class="token punctuation">[</span>j <span class="token operator">=</span> <span class="token punctuation">(</span>m <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> index<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    rs<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">;</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                                cellsBusy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>           <span class="token comment">// Slot is now non-empty</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    collide <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wasUncontended<span class="token punctuation">)</span>       <span class="token comment">// CAS already known to fail</span>
                    wasUncontended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token comment">// Continue after rehash</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">cas</span><span class="token punctuation">(</span>v <span class="token operator">=</span> c<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                               <span class="token punctuation">(</span>fn <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> v <span class="token operator">+</span> x <span class="token operator">:</span> fn<span class="token punctuation">.</span><span class="token function">applyAsLong</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;=</span> <span class="token constant">NCPU</span> <span class="token operator">||</span> cells <span class="token operator">!=</span> cs<span class="token punctuation">)</span>
                    collide <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token comment">// At max size or stale</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>collide<span class="token punctuation">)</span>
                    collide <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cellsBusy <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">casCellsBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>cells <span class="token operator">==</span> cs<span class="token punctuation">)</span>        <span class="token comment">// Expand table unless stale</span>
                            cells <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>cs<span class="token punctuation">,</span> n <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        cellsBusy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    collide <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                   <span class="token comment">// Retry with expanded table</span>
                <span class="token punctuation">}</span>
									<span class="token comment">//失败后rehash继续尝试</span>
                index <span class="token operator">=</span> <span class="token function">advanceProbe</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
						<span class="token comment">//cellsBusy为0表示无锁状态</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cellsBusy <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token operator">*</span>cells <span class="token operator">==</span> cs<span class="token operator">*</span><span class="token operator">*</span> <span class="token operator">&amp;&amp;</span> <span class="token function">casCellsBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>                           <span class="token comment">// Initialize table</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>cells <span class="token operator">==</span> cs<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
													<span class="token comment">//此处新建cell数组，初始化2格大小</span>
													<span class="token comment">//cell数组大小为2的幂</span>
                        <span class="token class-name">Cell</span><span class="token punctuation">[</span><span class="token punctuation">]</span> rs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cell</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
													<span class="token comment">//找到当前线程hash到数组的位置并创建cell</span>
                        rs<span class="token punctuation">[</span>index <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cell</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        cells <span class="token operator">=</span> rs<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    cellsBusy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Fall back on using base</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">casBase</span><span class="token punctuation">(</span>v <span class="token operator">=</span> base<span class="token punctuation">,</span>
                             <span class="token punctuation">(</span>fn <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> v <span class="token operator">+</span> x <span class="token operator">:</span> fn<span class="token punctuation">.</span><span class="token function">applyAsLong</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre></div><p><strong>代码分析</strong></p> <ul><li><p>绿色背景：cells已经被初始化</p> <ul><li><p>如果找不到对应下标的cell，进入下面if</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> cs<span class="token punctuation">[</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>cellsBusy <span class="token operator">==</span> <span class="token number">0</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment">// Try to attach new Cell</span>
        <span class="token class-name">Cell</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cell</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Optimistically create</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>cellsBusy <span class="token operator">==</span> <span class="token number">0</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token operator">&amp;&amp;</span> <span class="token function">casCellsBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>               <span class="token comment">// Recheck under lock</span>
                <span class="token class-name">Cell</span><span class="token punctuation">[</span><span class="token punctuation">]</span> rs<span class="token punctuation">;</span> <span class="token keyword">int</span> m<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rs <span class="token operator">=</span> cells<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span>m <span class="token operator">=</span> rs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                    rs<span class="token punctuation">[</span>j <span class="token operator">=</span> <span class="token punctuation">(</span>m <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> index<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
												<span class="token comment">//将创建好的Cell r加进cells</span>
                    rs<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                cellsBusy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>           <span class="token comment">// Slot is now non-empty</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
		<span class="token comment">//默认为false，不允许扩容</span>
    collide <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>(cs = cells) != null即在cell数组中index位置处为空</li> <li>加粗处<strong>cellsBusy == 0</strong>类似双端加锁，保证高并发下健壮性</li></ul></li> <li><p>如果不是上述情况</p> <ul><li><p>else-if-1</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wasUncontended<span class="token punctuation">)</span>       <span class="token comment">// CAS already known to fail</span>
	  wasUncontended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>      <span class="token comment">// Continue after rehash</span>
</code></pre></div><p>该线程在此cell位中竞争失败，rehash后重新循环</p> <p>由于add方法中进入longAccumulate方法的if条件有一条是<code>!(uncontended = c.cas(v = c.value, v + x))</code>，则可能<code>wasUncontended</code> 为false</p> <p>该else-if将<code>wasUncontended</code> 设置为true是为了跳出if分支，在绿色部分最后一行代码index = advanceProbe(index);进行rehash，继续循环</p></li> <li><p>else-if-2</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">cas</span><span class="token punctuation">(</span>v <span class="token operator">=</span> c<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
    <span class="token punctuation">(</span>fn <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> v <span class="token operator">+</span> x <span class="token operator">:</span> fn<span class="token punctuation">.</span><span class="token function">applyAsLong</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre></div><p>else-if-1中线程rehash后继续循环，如果rehash后再次CAS返回true，就会进入此分支，写值成功，跳出循环</p></li> <li><p>else-if-3</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;=</span> <span class="token constant">NCPU</span> <span class="token operator">||</span> cells <span class="token operator">!=</span> cs<span class="token punctuation">)</span>
    collide <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token comment">// At max size or stale</span>
</code></pre></div><p>如果n大于CPU最大容量或者cells和我们的不是同一个，就设置collide = false，不可以扩容，并通过index = advanceProbe(index);进行rehash，重新尝试</p> <p>绿色部分第一个if设置collide默认为false</p></li> <li><p>else-if-4</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>collide<span class="token punctuation">)</span>
    collide <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre></div><p>如果不存在分支3的情况，则允许扩容</p> <p>由于collide默认设置为false，则设为true，成为下次循环进入扩容分支的条件</p></li> <li><p>else-if-5</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cellsBusy <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">casCellsBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token comment">//当前cells数组和最先赋值的cs是同一个，代表没有被其他线程扩容过</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cells <span class="token operator">==</span> cs<span class="token punctuation">)</span>        <span class="token comment">// Expand table unless stale</span>
							<span class="token comment">//新建cells数组大小变为原来的2倍并拷贝原来数组数据</span>
            cells <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>cs<span class="token punctuation">,</span> n <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
				<span class="token comment">//释放锁</span>
        cellsBusy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		<span class="token comment">//恢复扩容状态为false</span>
    collide <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token comment">//扩容后继续循环，直到cas执行成功后break</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>                   <span class="token comment">// Retry with expanded table</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果不出现分支3的问题，且上次循环进入分支4将collide设为了true，则进入此分支进行扩容</p></li></ul></li></ul></li> <li><p>橙色背景：cells没有加锁且没有初始化，则尝试对其加锁并初始化cell数组</p> <ul><li><p>加粗部分两次进行了<strong>cells == cs</strong>判断，类似于双端加锁</p> <p>不double check下一个线程就有可能再new一个cell数组，上一个线程对应数组中的值将会被篡改</p></li> <li><p>index &amp; 1类似于hashmap常用到的计算散列桶index的算法，通常都是<code>hash&amp;(table.len - 1)</code></p></li></ul></li> <li><p>蓝色背景：cells正在进行初始化，尝试直接在基数base上进行累加操作</p> <ul><li>多次尝试CAS修改但失败的线程会走这个分支</li> <li>该分支实现直接操作base基数，将值累加在base上</li> <li>即如果有线程正在初始化，其他多个线程就得更新base值</li></ul></li></ul> <p><strong>入参：</strong></p> <ul><li>long x：需要增加的值，一般为1</li> <li>LongBinaryOperator fn：默认传递nul</li> <li>boolean wasUncontended：竞争标识，false代表有竞争。只有cell初始化后，并且当前线程CAS竞争修改失败，才会是false</li> <li>int index：传入的cell下标</li></ul> <p><strong>流程：</strong></p> <ul><li>第一次进入该方法时，<code>(cs = cells) != null</code> 为false，于是进入橙色高亮部分，初始化cell数组大小为2</li> <li>之后进入该方法时，<code>(cs = cells) != null &amp;&amp; (n = cs.length) &gt; 0</code> 成立进入绿色高亮部分</li></ul> <p><strong>总结：</strong></p> <p><img src="/Sardinary/assets/img/Untitled38.35d4c6ea.png" alt="Untitled"></p> <p><img src="/Sardinary/assets/img/Untitled39.7df6d28b.png" alt="Untitled"></p> <p><strong>→ sum()</strong></p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token comment">/**
     * Returns the current sum.  The returned value is &lt;em&gt;NOT&lt;/em&gt; an
     * atomic snapshot; invocation in the absence of concurrent
     * updates returns an accurate result, but concurrent updates that
     * occur while the sum is being calculated might not be
     * incorporated.
     *
     * @return the sum
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Cell</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cs <span class="token operator">=</span> cells<span class="token punctuation">;</span>
        <span class="token keyword">long</span> sum <span class="token operator">=</span> base<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Cell</span> c <span class="token operator">:</span> cs<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    sum <span class="token operator">+=</span> c<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><ul><li>将cell数组中所有的value累加再和base相加的结果作为返回值</li> <li>但是sum执行时，并没有限制对base和cells的更新，所以LongAdder不是强一致性的，而是最终一致性的
<ol><li>首先,最终返回的sum局部变量,初始被赋值为base,而最终返回时,很可能base已经被更新了,而此时局部变量sum不会更新,造成不一致</li> <li>其次,这里对cell的读取也无法保证是最后一次写入的值。所以,sum方法在没有并发的情况下,可以获得正确的结果</li></ol></li></ul> <h3 id="strip64"><a href="#strip64" class="header-anchor">#</a> Strip64</h3> <ul><li><p>重要成员函数</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token comment">/** Number of CPUS, to place bound on table size */</span>
		<span class="token comment">//cpu数量，即cells数组的最大长度</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NCPU</span> <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Table of cells. When non-null, size is a power of 2.
     */</span>
		<span class="token comment">//cells数组，为2的幂，方便位运算</span>
    <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Cell</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cells<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Base value, used mainly when there is no contention, but also as
     * a fallback during table initialization races. Updated via CAS.
     */</span>
		<span class="token comment">//基础valye值，并发较低时，只累加该值主要用于没有竞争的情况，通过CAS更新</span>
    <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> base<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Spinlock (locked via CAS) used when resizing and/or creating Cells.
     */</span>
		<span class="token comment">//创建或扩容cells数组时使用的自旋锁变量调整单元格大小（扩容），创建单元格时使用的锁</span>
    <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> cellsBusy<span class="token punctuation">;</span>
</code></pre></div></li> <li><p>重要变量或方法的定义</p> <ol><li>base: 类似于AtomicLong中全局的value值。再没有竞争情况下数据直接累加到base上,或者cells扩容时,也需要将数据写入到base上</li> <li>collide:表示扩容意向,false一定不会扩容,true可能会扩容</li> <li>cellsBusy:初始化cells或者扩容cells需要获取锁,0表示无锁状态,1表示其他线程已经持有了锁</li> <li>casCellsBusy:通过CAS操作修改cellsBusy的值,CAS成功代表获取锁,返回true</li> <li>NCPU:当前计算机CPU数量,Cell数组扩容时会使用到</li> <li>getProbe():获取当前线程的hash值</li> <li>advanceProbe():重置当前线程的hash值</li></ol></li></ul> <h3 id="cell"><a href="#cell" class="header-anchor">#</a> Cell</h3> <ul><li>Strip64的一个内部类</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@jdk.internal.vm.annotation.Contended</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Cell</span> <span class="token punctuation">{</span>
        <span class="token keyword">volatile</span> <span class="token keyword">long</span> value<span class="token punctuation">;</span>
        <span class="token class-name">Cell</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span> value <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">cas</span><span class="token punctuation">(</span><span class="token keyword">long</span> cmp<span class="token punctuation">,</span> <span class="token keyword">long</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">VALUE</span><span class="token punctuation">.</span><span class="token function">weakCompareAndSetRelease</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> cmp<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">VALUE</span><span class="token punctuation">.</span><span class="token function">setVolatile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword">long</span> identity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">VALUE</span><span class="token punctuation">.</span><span class="token function">setVolatile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token keyword">long</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token constant">VALUE</span><span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// VarHandle mechanics</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">VarHandle</span> <span class="token constant">VALUE</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">MethodHandles<span class="token punctuation">.</span>Lookup</span> l <span class="token operator">=</span> <span class="token class-name">MethodHandles</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token constant">VALUE</span> <span class="token operator">=</span> l<span class="token punctuation">.</span><span class="token function">findVarHandle</span><span class="token punctuation">(</span><span class="token class-name">Cell</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ReflectiveOperationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExceptionInInitializerError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/JUC/CAS%E5%92%8CAtomic%E7%B1%BB%20532499754a134662add3f629b929a7e6.html#atomicstampedreference类" class="sidebar-link reco-side-atomicstampedreference类" data-v-b57cc07c>AtomicStampedReference类</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/JUC/CAS%E5%92%8CAtomic%E7%B1%BB%20532499754a134662add3f629b929a7e6.html#基本类型原子类" class="sidebar-link reco-side-基本类型原子类" data-v-b57cc07c>基本类型原子类</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/JUC/CAS%E5%92%8CAtomic%E7%B1%BB%20532499754a134662add3f629b929a7e6.html#常用api" class="sidebar-link reco-side-常用api" data-v-b57cc07c>常用API</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/JUC/CAS%E5%92%8CAtomic%E7%B1%BB%20532499754a134662add3f629b929a7e6.html#数组类型原子类" class="sidebar-link reco-side-数组类型原子类" data-v-b57cc07c>数组类型原子类</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/JUC/CAS%E5%92%8CAtomic%E7%B1%BB%20532499754a134662add3f629b929a7e6.html#引用类型原子类" class="sidebar-link reco-side-引用类型原子类" data-v-b57cc07c>引用类型原子类</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/JUC/CAS%E5%92%8CAtomic%E7%B1%BB%20532499754a134662add3f629b929a7e6.html#对象属性修改原子类" class="sidebar-link reco-side-对象属性修改原子类" data-v-b57cc07c>对象属性修改原子类</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/JUC/CAS%E5%92%8CAtomic%E7%B1%BB%20532499754a134662add3f629b929a7e6.html#原子操作增强类" class="sidebar-link reco-side-原子操作增强类" data-v-b57cc07c>原子操作增强类</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/JUC/CAS%E5%92%8CAtomic%E7%B1%BB%20532499754a134662add3f629b929a7e6.html#常用api-2" class="sidebar-link reco-side-常用api-2" data-v-b57cc07c>常用API</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/JUC/CAS%E5%92%8CAtomic%E7%B1%BB%20532499754a134662add3f629b929a7e6.html#atomiclong和longadder的区别" class="sidebar-link reco-side-atomiclong和longadder的区别" data-v-b57cc07c>AtomicLong和LongAdder的区别</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/JUC/CAS%E5%92%8CAtomic%E7%B1%BB%20532499754a134662add3f629b929a7e6.html#源码分析-以longadder为例" class="sidebar-link reco-side-源码分析-以longadder为例" data-v-b57cc07c>源码分析 以LongAdder为例</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/JUC/CAS%E5%92%8CAtomic%E7%B1%BB%20532499754a134662add3f629b929a7e6.html#为什么longadder这么快" class="sidebar-link reco-side-为什么longadder这么快" data-v-b57cc07c>为什么LongAdder这么快</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/JUC/CAS%E5%92%8CAtomic%E7%B1%BB%20532499754a134662add3f629b929a7e6.html#源码解读-以longadder-increment-为例" class="sidebar-link reco-side-源码解读-以longadder-increment-为例" data-v-b57cc07c>源码解读 以longAdder.increment()为例</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/JUC/CAS%E5%92%8CAtomic%E7%B1%BB%20532499754a134662add3f629b929a7e6.html#strip64" class="sidebar-link reco-side-strip64" data-v-b57cc07c>Strip64</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/JUC/CAS%E5%92%8CAtomic%E7%B1%BB%20532499754a134662add3f629b929a7e6.html#cell" class="sidebar-link reco-side-cell" data-v-b57cc07c>Cell</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:0;" data-v-248d85d6></canvas></div><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="/Sardinary/assets/js/app.b4352b80.js" defer></script><script src="/Sardinary/assets/js/7.1de0e771.js" defer></script><script src="/Sardinary/assets/js/2.32e86603.js" defer></script><script src="/Sardinary/assets/js/1.87af8fda.js" defer></script><script src="/Sardinary/assets/js/16.16e886bc.js" defer></script>
  </body>
</html>
