<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Scan命令 | Sardinary&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content=" ">
    
    <link rel="preload" href="/Sardinary/assets/css/0.styles.cca88062.css" as="style"><link rel="preload" href="/Sardinary/assets/js/app.b4352b80.js" as="script"><link rel="preload" href="/Sardinary/assets/js/7.1de0e771.js" as="script"><link rel="preload" href="/Sardinary/assets/js/2.32e86603.js" as="script"><link rel="preload" href="/Sardinary/assets/js/1.87af8fda.js" as="script"><link rel="preload" href="/Sardinary/assets/js/64.2eefe5c7.js" as="script"><link rel="prefetch" href="/Sardinary/assets/js/10.49a810cd.js"><link rel="prefetch" href="/Sardinary/assets/js/11.7175f7e3.js"><link rel="prefetch" href="/Sardinary/assets/js/14.a5477566.js"><link rel="prefetch" href="/Sardinary/assets/js/15.439772b1.js"><link rel="prefetch" href="/Sardinary/assets/js/16.16e886bc.js"><link rel="prefetch" href="/Sardinary/assets/js/17.0e6e36bb.js"><link rel="prefetch" href="/Sardinary/assets/js/18.5e148afa.js"><link rel="prefetch" href="/Sardinary/assets/js/19.73412c71.js"><link rel="prefetch" href="/Sardinary/assets/js/20.e6e484b2.js"><link rel="prefetch" href="/Sardinary/assets/js/21.7c59eb62.js"><link rel="prefetch" href="/Sardinary/assets/js/22.1a4515f8.js"><link rel="prefetch" href="/Sardinary/assets/js/23.77f49651.js"><link rel="prefetch" href="/Sardinary/assets/js/24.2978efd9.js"><link rel="prefetch" href="/Sardinary/assets/js/25.c67021f4.js"><link rel="prefetch" href="/Sardinary/assets/js/26.6879f189.js"><link rel="prefetch" href="/Sardinary/assets/js/27.a2713265.js"><link rel="prefetch" href="/Sardinary/assets/js/28.0e7ec6a5.js"><link rel="prefetch" href="/Sardinary/assets/js/29.b33743d7.js"><link rel="prefetch" href="/Sardinary/assets/js/3.5b666661.js"><link rel="prefetch" href="/Sardinary/assets/js/30.3b66f6c0.js"><link rel="prefetch" href="/Sardinary/assets/js/31.a9a2ab1e.js"><link rel="prefetch" href="/Sardinary/assets/js/32.14ad86fd.js"><link rel="prefetch" href="/Sardinary/assets/js/33.1afd794c.js"><link rel="prefetch" href="/Sardinary/assets/js/34.31730445.js"><link rel="prefetch" href="/Sardinary/assets/js/35.acb79716.js"><link rel="prefetch" href="/Sardinary/assets/js/36.f161e3da.js"><link rel="prefetch" href="/Sardinary/assets/js/37.164bb569.js"><link rel="prefetch" href="/Sardinary/assets/js/38.0e4326d9.js"><link rel="prefetch" href="/Sardinary/assets/js/39.c0cdc477.js"><link rel="prefetch" href="/Sardinary/assets/js/4.95ecc938.js"><link rel="prefetch" href="/Sardinary/assets/js/40.4c8a03a6.js"><link rel="prefetch" href="/Sardinary/assets/js/41.b3e26267.js"><link rel="prefetch" href="/Sardinary/assets/js/42.6526990c.js"><link rel="prefetch" href="/Sardinary/assets/js/43.237a07a2.js"><link rel="prefetch" href="/Sardinary/assets/js/44.20a80a6c.js"><link rel="prefetch" href="/Sardinary/assets/js/45.ee53ec88.js"><link rel="prefetch" href="/Sardinary/assets/js/46.55f62d10.js"><link rel="prefetch" href="/Sardinary/assets/js/47.2a4b0a3b.js"><link rel="prefetch" href="/Sardinary/assets/js/48.d2f40143.js"><link rel="prefetch" href="/Sardinary/assets/js/49.6f809adc.js"><link rel="prefetch" href="/Sardinary/assets/js/5.c87bfc3b.js"><link rel="prefetch" href="/Sardinary/assets/js/50.e8110b40.js"><link rel="prefetch" href="/Sardinary/assets/js/51.e5d33d8f.js"><link rel="prefetch" href="/Sardinary/assets/js/52.35081e55.js"><link rel="prefetch" href="/Sardinary/assets/js/53.f148b50f.js"><link rel="prefetch" href="/Sardinary/assets/js/54.c9fddbbe.js"><link rel="prefetch" href="/Sardinary/assets/js/55.3bf482f3.js"><link rel="prefetch" href="/Sardinary/assets/js/56.284247d8.js"><link rel="prefetch" href="/Sardinary/assets/js/57.cd2fa388.js"><link rel="prefetch" href="/Sardinary/assets/js/58.9717d8f3.js"><link rel="prefetch" href="/Sardinary/assets/js/59.387411ca.js"><link rel="prefetch" href="/Sardinary/assets/js/6.363116dc.js"><link rel="prefetch" href="/Sardinary/assets/js/60.10700fc9.js"><link rel="prefetch" href="/Sardinary/assets/js/61.37f12cd5.js"><link rel="prefetch" href="/Sardinary/assets/js/62.1ee2e76e.js"><link rel="prefetch" href="/Sardinary/assets/js/63.05cc0dee.js"><link rel="prefetch" href="/Sardinary/assets/js/65.57aedaf0.js"><link rel="prefetch" href="/Sardinary/assets/js/66.3362b95c.js"><link rel="prefetch" href="/Sardinary/assets/js/67.31c9d9fd.js"><link rel="prefetch" href="/Sardinary/assets/js/68.966d4fa1.js"><link rel="prefetch" href="/Sardinary/assets/js/69.a33abe62.js"><link rel="prefetch" href="/Sardinary/assets/js/70.11dd9007.js"><link rel="prefetch" href="/Sardinary/assets/js/71.8006b388.js"><link rel="prefetch" href="/Sardinary/assets/js/72.73f1646b.js"><link rel="prefetch" href="/Sardinary/assets/js/73.f53d7f97.js"><link rel="prefetch" href="/Sardinary/assets/js/74.db2bf712.js"><link rel="prefetch" href="/Sardinary/assets/js/8.1ffd42bb.js"><link rel="prefetch" href="/Sardinary/assets/js/9.8e14a092.js"><link rel="prefetch" href="/Sardinary/assets/js/vendors~docsearch.34a230bb.js">
    <link rel="stylesheet" href="/Sardinary/assets/css/0.styles.cca88062.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Sardinary's Blog</h3> <p class="description" data-v-59e6cb88> </p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Sardinary Chen</span>
          
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Sardinary/" class="home-link router-link-active"><img src="/Sardinary/avatar.jpg" alt="Sardinary's Blog" class="logo"> <span class="site-name">Sardinary's Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Sardinary/" class="nav-link"><i class="undefined"></i>
  🏠
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Sardinary/categories/后端/" class="nav-link"><i class="undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/Sardinary/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Sardinary 🎈
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Xiangyinfly" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/Sardinary/avatar.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    Sardinary Chen
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>36</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>12</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/Sardinary/" class="nav-link"><i class="undefined"></i>
  🏠
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Sardinary/categories/后端/" class="nav-link"><i class="undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/Sardinary/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Sardinary 🎈
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Xiangyinfly" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Scan命令</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Sardinary Chen</span>
          
        <!---->
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">Scan命令</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>lixd</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2/26/2024</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>Redis</span><span class="tag-item" data-v-8a445198>微服务</span><span class="tag-item" data-v-8a445198>转载</span></i></div></div> <div class="theme-reco-content content__default"><p>主要分析了 Redis Scan 命令基本使用和具体实现，包括 Count 参数与 Scan 总耗时的关系，以及核心的逆二进制迭代算法分析。</p> <h2 id="_1-概述"><a href="#_1-概述" class="header-anchor">#</a> <strong>1. 概述</strong></h2> <p>由于 Redis 是单线程在处理用户的命令，而 Keys 命令会一次性遍历所有 Key，于是在 命令执行过程中，无法执行其他命令。这就导致如果 Redis 中的 key 比较多，那么 Keys 命令执行时间就会比较长，从而阻塞 Redis。</p> <p>所以很多教程都推荐使用 Scan 命令来代替 Keys，因为 Scan 可以限制每次遍历的 key 数量。</p> <p>Keys 的缺点：</p> <ul><li>1）没有limit，我们只能一次性获取所有符合条件的key，如果结果有上百万条，那么等待你的就是“无穷无尽”的字符串输出。</li> <li>2）keys命令是遍历算法，时间复杂度是O(N)。如我们刚才所说，这个命令非常容易导致Redis服务卡顿。因此，我们要尽量避免在生产环境使用该命令。</li></ul> <p>相比于keys命令，Scan命令有两个比较明显的优势：</p> <ul><li>1）Scan命令的时间复杂度虽然也是O(N)，但它是分次进行的，不会阻塞线程。</li> <li>2）Scan命令提供了 count 参数，可以控制每次遍历的集合数。</li></ul> <blockquote><p>可以理解为 Scan 是渐进式的 Keys。</p></blockquote> <p>Scan 命令语法如下：</p> <div class="language- extra-class"><pre class="language-text"><code>SCAN cursor[MATCH pattern][COUNT count]

</code></pre></div><hr> <ul><li>cursor - 游标。</li> <li>pattern - 匹配的模式。</li> <li>count - 指定每次遍历多少个集合。
<ul><li>可以简单理解为每次遍历多少个元素</li> <li>根据测试，推荐 Count大小为 1W。</li></ul></li></ul> <p>Scan 返回值为数组，会返回一个游标+一系列的 Key</p> <p>大致用法如下：</p> <p>SCAN命令是基于游标的，每次调用后，都会返回一个游标，用于下一次迭代。当游标返回0时，表示迭代结束。</p> <blockquote><p>第一次 Scan 时指定游标为 0，表示开启新的一轮迭代，然后 Scan 命令返回一个新的游标，作为第二次 Scan 时的游标值继续迭代，一直到 Scan 返回游标为0，表示本轮迭代结束。</p></blockquote> <p>通过这个就可以看出，<strong>Scan 完成一次迭代，需要和 Redis 进行多次交互</strong>。</p> <p>Scan 命令注意事项：</p> <ul><li><strong>返回的结果可能会有重复，需要客户端去重复，这点非常重要;</strong></li> <li><strong>遍历的过程中如果有数据修改，改动后的数据能不能遍历到是不确定的;</strong></li> <li><strong>单次返回的结果是空的并不意味着遍历结束，而要看返回的游标值是否为零;</strong></li></ul> <h2 id="_2-scan-踩坑"><a href="#_2-scan-踩坑" class="header-anchor">#</a> <strong>2. Scan 踩坑</strong></h2> <p>使用时遇到一个 特殊场景，<strong>跨区域远程连接 Redis 并进行模糊查询</strong>，扫描所有指定前缀的 Key。</p> <p>最开始也没多想，直接就是开始 Scan，然后 Count 参数指定的是 1000。</p> <blockquote><p>Redis 中大概几百万 Key。</p></blockquote> <p>最后发现这个接口需要几十上百秒才返回。</p> <p>什么原因呢？</p> <p>Scan 命令中的 Count 指定一次扫描多少 Key，这里指定为 1000，几百万Key就需要几千次迭代，即和 Redis 交互几千次，然后因为是远程连接，网络延迟比较大，所以耗时特别长。</p> <p>最后将 Count 参数调大后，减少了交互次数，就好多了。</p> <blockquote><p>Count 参数越大，Redis 阻塞时间也会越长，需要取舍。</p> <p>极限一点，<strong>Count 参数和总 Key 数一致时，Scan 命令就和 Keys 效果一样了</strong>。</p></blockquote> <p>Count 大小和 Scan 总耗时的关系如下图：</p> <p><img src="https://github.com/lixd/blog/raw/master/images/redis/scan/scan_time_vs_count.png" alt="https://github.com/lixd/blog/raw/master/images/redis/scan/scan_time_vs_count.png"></p> <blockquote><p>图源：keydb</p></blockquote> <p>可以发现 Count 越大，总耗时就越短，不过越后面提升就越不明显了。</p> <blockquote><p>所以推荐的 Count 大小为 1W 左右。</p></blockquote> <p>如果不考虑 Redis 的阻塞，其实 Keys 比 Scan 会快很多，毕竟一次性处理，省去了多余的交互。</p> <h2 id="_3-scan原理"><a href="#_3-scan原理" class="header-anchor">#</a> <strong>3. Scan原理</strong></h2> <p>Redis使用了Hash表作为底层实现，原因不外乎高效且实现简单。类似于HashMap那样数组+链表的结构。其中第一维的数组大小为2n(n&gt;=0)。每次扩容数组长度扩大一倍。</p> <p>Scan命令就是对这个一维数组进行遍历。每次返回的游标值也都是这个数组的索引。Count 参数表示遍历多少个数组的元素，将这些元素下挂接的符合条件的结果都返回。因为每个元素下挂接的链表大小不同，所以每次返回的结果数量也就不同。</p> <h3 id="演示"><a href="#演示" class="header-anchor">#</a> <strong>演示</strong></h3> <p>关于 Scan 命令的遍历顺序，我们可以用一个小栗子来具体看一下：</p> <div class="language- extra-class"><pre class="language-text"><code>127.0.0.1:6379&gt; keys *
1)&quot;db_number&quot;
2)&quot;key1&quot;
3)&quot;myKey&quot;
127.0.0.1:6379&gt; scan0 MATCH * COUNT1
1)&quot;2&quot;
2) 1)&quot;db_number&quot;
127.0.0.1:6379&gt; scan2 MATCH * COUNT1
1)&quot;1&quot;
2) 1)&quot;myKey&quot;
127.0.0.1:6379&gt; scan1 MATCH * COUNT1
1)&quot;3&quot;
2) 1)&quot;key1&quot;
127.0.0.1:6379&gt; scan3 MATCH * COUNT1
1)&quot;0&quot;
2)(empty list orset)

</code></pre></div><hr> <p>如上所示，SCAN命令的遍历顺序是：0-&gt;2-&gt;1-&gt;3</p> <p>这个顺序看起来有些奇怪，我们把它转换成二进制：00-&gt;10-&gt;01-&gt;11</p> <p>可以看到每次这个序列是高位加1的。</p> <blockquote><p>普通二进制的加法，是从右往左相加、进位。而这个序列是从左往右相加、进位的。</p></blockquote> <p>相关源码：</p> <div class="language-c extra-class"><pre class="language-c"><code>v<span class="token operator">=</span><span class="token function">rev</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
v<span class="token operator">++</span><span class="token punctuation">;</span>
v<span class="token operator">=</span><span class="token function">rev</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><hr> <p>将游标倒置，加一后，再倒置，也就是我们所说的“高位加1”的操作。</p> <h3 id="相关源码"><a href="#相关源码" class="header-anchor">#</a> <strong>相关源码</strong></h3> <p>先贴一下代码：</p> <div class="language-c extra-class"><pre class="language-c"><code>
</code></pre></div><hr> <h3 id="reverse-binary-iteration"><a href="#reverse-binary-iteration" class="header-anchor">#</a> <strong>reverse binary iteration</strong></h3> <p>Redis Scan 命令最终使用的是 reverse binary iteration 算法，大概可以翻译为 逆二进制迭代，具体算法细节可以看一下这个<a href="https://github.com/redis/redis/pull/579" target="_blank" rel="noopener noreferrer">Github 相关讨论<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>这个算法简单来说就是：</p> <p><strong>依次从高位（有效位）开始，不断尝试将当前高位设置为1，然后变动更高位为不同组合，以此来扫描整个字典数组。</strong></p> <p>其最大的优势在于，从高位扫描的时候，如果槽位是2^N个,扫描的临近的2个元素都是与2^(N-1)相关的就是说同模的，比如槽位8时，0%4 == 4%4， 1%4 == 5%4 ， 因此想到其实hash的时候，跟模是很相关的。</p> <p>比如当整个字典大小只有4的时候，一个元素计算出的整数为5， 那么计算他的hash值需要模4，也就是hash(n) == 5%4 == 1 , 元素存放在第1个槽位中。当字典扩容的时候，字典大小变为8， 此时计算hash的时候为5%8 == 5 ， 该元素从1号slot迁移到了5号，1和5是对应的，我们称之为同模或者对应。</p> <p><strong>同模的槽位的元素最容易出现合并或者拆分了。因此在迭代的时候只要及时的扫描这些相关的槽位，这样就不会造成大面积的重复扫描。</strong></p> <h3 id="_3-种情况"><a href="#_3-种情况" class="header-anchor">#</a> <strong>3 种情况</strong></h3> <p>迭代哈希表时，有以下三种情况：</p> <ul><li>从迭代开始到结束，哈希表不 Rehash；</li> <li>从迭代开始到结束，哈希表Rehash，但每次迭代，哈希表要么不开始 Rehash，要么已经结束 Rehash；</li> <li>从一次迭代开始到结束，哈希表在一次或多次迭代中 Rehash。
<ul><li>即再 Rehash 过程中，执行 Scan 命令，这时数据可能只迁移了一部分。</li></ul></li></ul> <p>因此，游标的实现需要兼顾以上三种情况。上述三种情况下游标实现的要求如下：</p> <p><strong>第一种情况比较简单</strong>。假设redis的hash表大小为4，第一个游标为0，读取第一个bucket的数据，然后游标返回2，下次读取bucket 2 ，依次遍历。</p> <p><strong>第二种情况更复杂</strong>。假设redis的hash表大小为4，如果rehash后大小变成8。如果如上返回游标(即返回2)，则显示下图：</p> <p><img src="https://github.com/lixd/blog/raw/master/images/redis/scan/redis-scale.png" alt="https://github.com/lixd/blog/raw/master/images/redis/scan/redis-scale.png"></p> <p>假设bucket 0读取后返回到cursor 2，当客户端再次Scan cursor 2时，hash表已经被rehash，大小翻倍到8，redis计算一个key bucket如下：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

</code></pre></div><hr> <p>即如果大小为4，hash(key)&amp;11，如果大小为8，hash(key)&amp;111。所以当size从4扩大到8时，2 号bucket中的原始数据会被分散到2 (010) 和 6 (110) 这两个 bucket中。</p> <blockquote><p>从二进制来看，size为4时，在hash(key)之后，取低两位，即hash(key)&amp;11，如果size为8，bucket位置为hash(key) &amp; 111，即取低三个位。</p></blockquote> <p>所以依旧不会出现漏掉数据的情况。</p> <p><strong>第三种情况</strong>，如果返回游标2时正在进行rehash，则Hash表1的bucket 2中的一些数据可能已经rehash到了的Hash表2 的bucket[2]或bucket[6]，那么必须完全遍历 哈希表2的 bucket 2 和 6，否则可能会丢失数据。</p> <blockquote><p>Redis 全局有两个Hash表，扩容时会渐进式的将表1的数据迁移到表2，查询时程序会先在 ht[0] 里面进行查找， 如果没找到的话， 就会继续到 ht[1] 里面进行查找。</p> <p>详细信息可以查看：<a href="https://www.lixueduan.com/post/redis/04-global-datastructure/" target="_blank" rel="noopener noreferrer">Redis教程(四)—全局数据结构<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h3 id="游标计算"><a href="#游标计算" class="header-anchor">#</a> <strong>游标计算</strong></h3> <p>具体游标计算代码如下：</p> <blockquote><p>Scan 命令中的游标，其实就是 Redis 内部的 bucket。</p></blockquote> <div class="language-c extra-class"><pre class="language-c"><code>v<span class="token operator">|=</span><span class="token operator">~</span>m0<span class="token punctuation">;</span><span class="token comment">// 将游标v的unmarsked 比特都置为1</span>
v<span class="token operator">=</span><span class="token function">rev</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 反转v</span>
v<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//这个是关键，加1，对一个数加1，其实就是将这个数的低位的连续1变为0，然后将最低的一个0变为1，其实就是将最低的一个0变为1</span>
v<span class="token operator">=</span><span class="token function">rev</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//再次反转，即得到下一个游标值</span>

</code></pre></div><hr> <p>代码逻辑非常简单，计算过程如下：</p> <p><img src="https://github.com/lixd/blog/raw/master/images/redis/scan/scan-rbi.png" alt="https://github.com/lixd/blog/raw/master/images/redis/scan/scan-rbi.png"></p> <blockquote><p>图源：developpaper</p></blockquote> <ul><li>大小为 4 时，游标状态转换为 0-2-1-3。</li> <li>当大小为 8 时，游标状态转换为 0-4-2-6-1-5-3-7。</li></ul> <p>可以看出，当size由小变大时，所有原来的游标都能在大hashTable中找到对应的位置，并且顺序一致，不会重复读取，也不会被遗漏。</p> <p><strong>总结一下：redis在rehash 扩容的时候，不会重复或者漏掉数据。但缩容，可能会造成重复但不会漏掉数据。</strong></p> <h3 id="缩容处理"><a href="#缩容处理" class="header-anchor">#</a> <strong>缩容处理</strong></h3> <p><strong>之所以会出现重复数据，其实就是为了保证缩容后数据不丢。</strong></p> <p>假设当前 hash 大小为 8：</p> <ul><li>1）第一次先遍历了 0 号槽，返回游标为 4；</li> <li>2）准备遍历 4 号槽，然后此时发生了缩容，4 号槽的元素也进到 0 号槽了。</li> <li>3）但是0 号槽之前已经被遍历过了，此时会丢数据吗？</li></ul> <p>答案就在源码中：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">do</span><span class="token punctuation">{</span><span class="token comment">//扫描大点的表里面的槽位，注意这里是个循环，会将小表没有覆盖的slot全部扫描一次的</span>
<span class="token comment">/* Emit entries at cursor */</span>
de<span class="token operator">=</span>t1<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>v<span class="token operator">&amp;</span>m1<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token function">fn</span><span class="token punctuation">(</span>privdata<span class="token punctuation">,</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
de<span class="token operator">=</span>de<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Increment bits not covered by the smaller mask */</span>
<span class="token comment">//下面的意思是，还需要扩展小点的表，将其后缀固定，然后看高位可以怎么扩充。</span>
<span class="token comment">//其实就是想扫描一下小表里面的元素可能会扩充到哪些地方，需要将那些地方处理一遍。</span>
<span class="token comment">//后面的(v &amp; m0)是保留v在小表里面的后缀。</span>
<span class="token comment">//((v | m0) + 1) &amp; ~m0) 是想给v的扩展部分的二进制位不断的加1，来造成高位不断增加的效果。</span>
v<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token operator">|</span>m0<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token operator">~</span>m0<span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>v<span class="token operator">&amp;</span>m0<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* Continue while bits covered by mask difference is non-zero */</span>
<span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span>v<span class="token operator">&amp;</span><span class="token punctuation">(</span>m0<span class="token operator">^</span>m1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//终止条件是 v的高位区别位没有1了，其实就是说到头了。</span>

</code></pre></div><hr> <p>具体计算方法：</p> <div class="language-c extra-class"><pre class="language-c"><code>v<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token operator">|</span>m0<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token operator">~</span>m0<span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>v<span class="token operator">&amp;</span>m0<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><hr> <p>右边的下半部分是v，左边的上半部分是v。 (v&amp;m0) 取出v的低位，例如size=4时v&amp;00000011</p> <p>左半边(v|m0) + 1 将V 的低位设置为1，然后+1 将进位到v 的高位，再次&amp;m0，V 的高位将被取出。</p> <p>假设游标返回2并且正在rehashing，大小从4变为8，那么M0 = 00000011 v = 00000010</p> <p>根据公式计算的下一个光标是 ((00000010 | 00000011) +1) &amp; (11111111100) | (00000010 &amp; 00000011) = (00000100) &amp; (11111111100) | (00000000010) = (000000000110) 正好是 6。</p> <h2 id="_4-小结"><a href="#_4-小结" class="header-anchor">#</a> <strong>4. 小结</strong></h2> <ul><li>Scan Count 参数限制的是遍历的 bucket 数，而不是限制的返回的元素个数
<ul><li>由于不同 bucket 中的元素个数不同，其中满足条件的个数也不同，所以每次 Scan 返回元素也不一定相同</li></ul></li> <li>Count 越大，Scan 总耗时越短，但是单次耗时越大，即阻塞Redis 时间边长
<ul><li>推荐 Count 大小为 1W左右</li> <li>当 Count = Redis Key 总数时，Scan 和 Keys 效果一致</li></ul></li> <li>Scan 采用 逆二进制迭代法来计算游标，主要为了兼容Rehash的情况</li> <li>Scan 为了兼容缩容后不漏掉数据，会出现重复遍历。
<ul><li>即客户端需要做去重处理</li></ul></li></ul> <p>核心就是 逆二进制迭代法，比较复杂，而且算法作者也没有具体证明，为什么这样就能实现，只是测试发现没有问题，各种情况都能兼容。</p> <p>具体算法细节可以看一下这个<a href="https://github.com/redis/redis/pull/579" target="_blank" rel="noopener noreferrer">Github 相关讨论<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>antirez: Hello @pietern! I’m starting to re-evaluate the idea of an iterator for Redis, and the first item in this task is definitely to understand better your pull request and implementation. I don’t understand exactly the implementation with the reversed bits counter… I wonder if there is a way to make that more intuitive… so investing some more time into this, and if I fail I’ll just merge your code trying to augment it with more comments… Hard to explain but awesome.</p> <p><strong>pietern</strong>： Although I don’t have a formal proof for these guarantees, I’m reasonably confident they hold. I worked through every hash table state (stable, grow, shrink) and it appears to work everywhere by means of the reverse binary iteration (for lack of a better word).</p></blockquote> <p>所以只能说这个算法很巧妙。就像卡马克快速逆平方根算法：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token function">floatQ_rsqrt</span><span class="token punctuation">(</span>floatnumber<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
longi<span class="token punctuation">;</span>
floatx2<span class="token punctuation">,</span>y<span class="token punctuation">;</span>
constfloatthreehalfs<span class="token operator">=</span><span class="token number">1.5F</span><span class="token punctuation">;</span>
x2<span class="token operator">=</span>number<span class="token operator">*</span><span class="token number">0.5F</span><span class="token punctuation">;</span>
y<span class="token operator">=</span>number<span class="token punctuation">;</span>
i<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>y<span class="token punctuation">;</span><span class="token comment">// evil floating point bit level hacking</span>
i<span class="token operator">=</span><span class="token number">0x5f3759df</span><span class="token operator">-</span><span class="token punctuation">(</span>i<span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// what the fuck?</span>
y<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>i<span class="token punctuation">;</span>
y<span class="token operator">=</span>y<span class="token operator">*</span><span class="token punctuation">(</span>threehalfs<span class="token operator">-</span><span class="token punctuation">(</span>x2<span class="token operator">*</span>y<span class="token operator">*</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1st iteration</span>
<span class="token comment">//  y = y * ( threehalfs - ( x2 * y * y ) ); // 2nd iteration, this can be removed</span>
returny<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><hr> <p>其中的这个<code>0x5f3759df</code>数就很巧妙。</p> <h2 id="_5-参考"><a href="#_5-参考" class="header-anchor">#</a> <strong>5. 参考</strong></h2> <p><code>http://antirez.com/news/63</code></p> <p><code>https://developpaper.com/redis-scan-command-principle/</code></p> <p><code>https://www.cnblogs.com/thrillerz/p/4527510.html</code></p> <p><code>https://www.jianshu.com/p/abe5d8ae4852</code></p> <p><code>https://zhuanlan.zhihu.com/p/46353221</code></p> <p><code>https://docs.keydb.dev/blog/2020/08/10/blog-post/</code></p></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/Redis/Scan%E5%91%BD%E4%BB%A4%20d36fc05ba13040a7af39db5bda889461.html#_1-概述" class="sidebar-link reco-side-_1-概述" data-v-b57cc07c>1. 概述</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/Redis/Scan%E5%91%BD%E4%BB%A4%20d36fc05ba13040a7af39db5bda889461.html#_2-scan-踩坑" class="sidebar-link reco-side-_2-scan-踩坑" data-v-b57cc07c>2. Scan 踩坑</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/Redis/Scan%E5%91%BD%E4%BB%A4%20d36fc05ba13040a7af39db5bda889461.html#_3-scan原理" class="sidebar-link reco-side-_3-scan原理" data-v-b57cc07c>3. Scan原理</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/Redis/Scan%E5%91%BD%E4%BB%A4%20d36fc05ba13040a7af39db5bda889461.html#演示" class="sidebar-link reco-side-演示" data-v-b57cc07c>演示</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/Redis/Scan%E5%91%BD%E4%BB%A4%20d36fc05ba13040a7af39db5bda889461.html#相关源码" class="sidebar-link reco-side-相关源码" data-v-b57cc07c>相关源码</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/Redis/Scan%E5%91%BD%E4%BB%A4%20d36fc05ba13040a7af39db5bda889461.html#reverse-binary-iteration" class="sidebar-link reco-side-reverse-binary-iteration" data-v-b57cc07c>reverse binary iteration</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/Redis/Scan%E5%91%BD%E4%BB%A4%20d36fc05ba13040a7af39db5bda889461.html#_3-种情况" class="sidebar-link reco-side-_3-种情况" data-v-b57cc07c>3 种情况</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/Redis/Scan%E5%91%BD%E4%BB%A4%20d36fc05ba13040a7af39db5bda889461.html#游标计算" class="sidebar-link reco-side-游标计算" data-v-b57cc07c>游标计算</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/Redis/Scan%E5%91%BD%E4%BB%A4%20d36fc05ba13040a7af39db5bda889461.html#缩容处理" class="sidebar-link reco-side-缩容处理" data-v-b57cc07c>缩容处理</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/Redis/Scan%E5%91%BD%E4%BB%A4%20d36fc05ba13040a7af39db5bda889461.html#_4-小结" class="sidebar-link reco-side-_4-小结" data-v-b57cc07c>4. 小结</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/Redis/Scan%E5%91%BD%E4%BB%A4%20d36fc05ba13040a7af39db5bda889461.html#_5-参考" class="sidebar-link reco-side-_5-参考" data-v-b57cc07c>5. 参考</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:0;" data-v-248d85d6></canvas></div><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="/Sardinary/assets/js/app.b4352b80.js" defer></script><script src="/Sardinary/assets/js/7.1de0e771.js" defer></script><script src="/Sardinary/assets/js/2.32e86603.js" defer></script><script src="/Sardinary/assets/js/1.87af8fda.js" defer></script><script src="/Sardinary/assets/js/64.2eefe5c7.js" defer></script>
  </body>
</html>
