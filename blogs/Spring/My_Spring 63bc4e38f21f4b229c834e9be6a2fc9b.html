<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>My_Spring | Sardinary&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content=" ">
    
    <link rel="preload" href="/Sardinary/assets/css/0.styles.cca88062.css" as="style"><link rel="preload" href="/Sardinary/assets/js/app.b4352b80.js" as="script"><link rel="preload" href="/Sardinary/assets/js/7.1de0e771.js" as="script"><link rel="preload" href="/Sardinary/assets/js/2.32e86603.js" as="script"><link rel="preload" href="/Sardinary/assets/js/1.87af8fda.js" as="script"><link rel="preload" href="/Sardinary/assets/js/69.a33abe62.js" as="script"><link rel="prefetch" href="/Sardinary/assets/js/10.49a810cd.js"><link rel="prefetch" href="/Sardinary/assets/js/11.7175f7e3.js"><link rel="prefetch" href="/Sardinary/assets/js/14.a5477566.js"><link rel="prefetch" href="/Sardinary/assets/js/15.439772b1.js"><link rel="prefetch" href="/Sardinary/assets/js/16.16e886bc.js"><link rel="prefetch" href="/Sardinary/assets/js/17.0e6e36bb.js"><link rel="prefetch" href="/Sardinary/assets/js/18.5e148afa.js"><link rel="prefetch" href="/Sardinary/assets/js/19.73412c71.js"><link rel="prefetch" href="/Sardinary/assets/js/20.e6e484b2.js"><link rel="prefetch" href="/Sardinary/assets/js/21.7c59eb62.js"><link rel="prefetch" href="/Sardinary/assets/js/22.1a4515f8.js"><link rel="prefetch" href="/Sardinary/assets/js/23.77f49651.js"><link rel="prefetch" href="/Sardinary/assets/js/24.2978efd9.js"><link rel="prefetch" href="/Sardinary/assets/js/25.c67021f4.js"><link rel="prefetch" href="/Sardinary/assets/js/26.6879f189.js"><link rel="prefetch" href="/Sardinary/assets/js/27.a2713265.js"><link rel="prefetch" href="/Sardinary/assets/js/28.0e7ec6a5.js"><link rel="prefetch" href="/Sardinary/assets/js/29.b33743d7.js"><link rel="prefetch" href="/Sardinary/assets/js/3.5b666661.js"><link rel="prefetch" href="/Sardinary/assets/js/30.3b66f6c0.js"><link rel="prefetch" href="/Sardinary/assets/js/31.a9a2ab1e.js"><link rel="prefetch" href="/Sardinary/assets/js/32.14ad86fd.js"><link rel="prefetch" href="/Sardinary/assets/js/33.1afd794c.js"><link rel="prefetch" href="/Sardinary/assets/js/34.31730445.js"><link rel="prefetch" href="/Sardinary/assets/js/35.acb79716.js"><link rel="prefetch" href="/Sardinary/assets/js/36.f161e3da.js"><link rel="prefetch" href="/Sardinary/assets/js/37.164bb569.js"><link rel="prefetch" href="/Sardinary/assets/js/38.0e4326d9.js"><link rel="prefetch" href="/Sardinary/assets/js/39.c0cdc477.js"><link rel="prefetch" href="/Sardinary/assets/js/4.95ecc938.js"><link rel="prefetch" href="/Sardinary/assets/js/40.4c8a03a6.js"><link rel="prefetch" href="/Sardinary/assets/js/41.b3e26267.js"><link rel="prefetch" href="/Sardinary/assets/js/42.6526990c.js"><link rel="prefetch" href="/Sardinary/assets/js/43.237a07a2.js"><link rel="prefetch" href="/Sardinary/assets/js/44.20a80a6c.js"><link rel="prefetch" href="/Sardinary/assets/js/45.ee53ec88.js"><link rel="prefetch" href="/Sardinary/assets/js/46.55f62d10.js"><link rel="prefetch" href="/Sardinary/assets/js/47.2a4b0a3b.js"><link rel="prefetch" href="/Sardinary/assets/js/48.d2f40143.js"><link rel="prefetch" href="/Sardinary/assets/js/49.6f809adc.js"><link rel="prefetch" href="/Sardinary/assets/js/5.c87bfc3b.js"><link rel="prefetch" href="/Sardinary/assets/js/50.e8110b40.js"><link rel="prefetch" href="/Sardinary/assets/js/51.e5d33d8f.js"><link rel="prefetch" href="/Sardinary/assets/js/52.35081e55.js"><link rel="prefetch" href="/Sardinary/assets/js/53.f148b50f.js"><link rel="prefetch" href="/Sardinary/assets/js/54.c9fddbbe.js"><link rel="prefetch" href="/Sardinary/assets/js/55.3bf482f3.js"><link rel="prefetch" href="/Sardinary/assets/js/56.284247d8.js"><link rel="prefetch" href="/Sardinary/assets/js/57.cd2fa388.js"><link rel="prefetch" href="/Sardinary/assets/js/58.9717d8f3.js"><link rel="prefetch" href="/Sardinary/assets/js/59.387411ca.js"><link rel="prefetch" href="/Sardinary/assets/js/6.363116dc.js"><link rel="prefetch" href="/Sardinary/assets/js/60.10700fc9.js"><link rel="prefetch" href="/Sardinary/assets/js/61.37f12cd5.js"><link rel="prefetch" href="/Sardinary/assets/js/62.1ee2e76e.js"><link rel="prefetch" href="/Sardinary/assets/js/63.05cc0dee.js"><link rel="prefetch" href="/Sardinary/assets/js/64.2eefe5c7.js"><link rel="prefetch" href="/Sardinary/assets/js/65.57aedaf0.js"><link rel="prefetch" href="/Sardinary/assets/js/66.3362b95c.js"><link rel="prefetch" href="/Sardinary/assets/js/67.31c9d9fd.js"><link rel="prefetch" href="/Sardinary/assets/js/68.966d4fa1.js"><link rel="prefetch" href="/Sardinary/assets/js/70.11dd9007.js"><link rel="prefetch" href="/Sardinary/assets/js/71.8006b388.js"><link rel="prefetch" href="/Sardinary/assets/js/72.73f1646b.js"><link rel="prefetch" href="/Sardinary/assets/js/73.f53d7f97.js"><link rel="prefetch" href="/Sardinary/assets/js/74.db2bf712.js"><link rel="prefetch" href="/Sardinary/assets/js/8.1ffd42bb.js"><link rel="prefetch" href="/Sardinary/assets/js/9.8e14a092.js"><link rel="prefetch" href="/Sardinary/assets/js/vendors~docsearch.34a230bb.js">
    <link rel="stylesheet" href="/Sardinary/assets/css/0.styles.cca88062.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Sardinary's Blog</h3> <p class="description" data-v-59e6cb88> </p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Sardinary Chen</span>
        Â Â 
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Sardinary/" class="home-link router-link-active"><img src="/Sardinary/avatar.jpg" alt="Sardinary's Blog" class="logo"> <span class="site-name">Sardinary's Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Sardinary/" class="nav-link"><i class="undefined"></i>
  ğŸ 
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Sardinary/categories/åç«¯/" class="nav-link"><i class="undefined"></i>
  åç«¯
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/ä¸­é—´ä»¶/" class="nav-link"><i class="undefined"></i>
  ä¸­é—´ä»¶
</a></li></ul></div></div><div class="nav-item"><a href="/Sardinary/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Sardinary ğŸˆ
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Xiangyinfly" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/Sardinary/avatar.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    Sardinary Chen
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>36</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>12</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/Sardinary/" class="nav-link"><i class="undefined"></i>
  ğŸ 
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Sardinary/categories/åç«¯/" class="nav-link"><i class="undefined"></i>
  åç«¯
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/ä¸­é—´ä»¶/" class="nav-link"><i class="undefined"></i>
  ä¸­é—´ä»¶
</a></li></ul></div></div><div class="nav-item"><a href="/Sardinary/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Sardinary ğŸˆ
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Xiangyinfly" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>My_Spring</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Sardinary Chen</span>
        Â Â 
        <!---->
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">My_Spring</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>Sardinary Chen</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2/26/2024</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>Spring</span><span class="tag-item" data-v-8a445198>æºç è§£æ</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="ä¸€äº›æ³¨è§£ç±»"><a href="#ä¸€äº›æ³¨è§£ç±»" class="header-anchor">#</a> ä¸€äº›æ³¨è§£ç±»</h2> <p>@ComponentScan</p> <div class="language- extra-class"><pre class="language-text"><code>@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface ComponentScan {
    String value() default &quot;&quot;;
}
</code></pre></div><p>@Component</p> <div class="language- extra-class"><pre class="language-text"><code>@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface Component {
    String value() default &quot;&quot;;
}
</code></pre></div><p>@Scope</p> <div class="language- extra-class"><pre class="language-text"><code>@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface Scope {
    String value() default &quot;&quot;;
}
</code></pre></div><p>@Autowired</p> <div class="language- extra-class"><pre class="language-text"><code>@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
public @interface Autowired {
}
</code></pre></div><h2 id="å»ºç«‹beandefinition"><a href="#å»ºç«‹beandefinition" class="header-anchor">#</a> å»ºç«‹BeanDefinition</h2> <p><em>BeanDefinitionä¸Beançš„å…³ç³», å°±å¥½æ¯”ç±»ä¸å¯¹è±¡çš„å…³ç³».
ç±»åœ¨springçš„æ•°æ®ç»“æ„å°±æ˜¯BeanDefinition.</em></p> <div class="language- extra-class"><pre class="language-text"><code>public class BeanDefinition {
    private Class type;
    private String scope;

    public Class getType() {
        return type;
    }

    public void setType(Class type) {
        this.type = type;
    }

    public String getScope() {
        return scope;
    }

    public void setScope(String scope) {
        this.scope = scope;
    }
}
</code></pre></div><h2 id="myapplicationcontextç±»"><a href="#myapplicationcontextç±»" class="header-anchor">#</a> MyApplicationContextç±»</h2> <div class="language- extra-class"><pre class="language-text"><code>public class MyApplicationContext {
    private Class configClass;
    private ConcurrentHashMap&lt;String,BeanDefinition&gt; beanDefinitionMap = new ConcurrentHashMap&lt;&gt;();
    private ConcurrentHashMap&lt;String,Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;();

    public MyApplicationContext(Class configClass) {
        this.configClass = configClass;

        //æ‰«æç±»çš„æ³¨è§£
        if (configClass.isAnnotationPresent(ComponentScan.class)) {
            ComponentScan componentScanAnnotation = (ComponentScan) configClass.getAnnotation(ComponentScan.class);
            String path = componentScanAnnotation.value();
            path = path.replace(&quot;.&quot;,&quot;/&quot;);

            ClassLoader classLoader = MyApplicationContext.class.getClassLoader();
            URL resource = classLoader.getResource(path);

            File file = new File(resource.getFile());
            System.out.println(file);
            if (file.isDirectory()) {
                File[] files = file.listFiles();
                for (File f : files) {
                    String fileName = f.getAbsolutePath();
                    if (fileName.endsWith(&quot;.class&quot;)) {
                        String className = (path + &quot;/&quot; + f.getName().substring(0,f.getName().indexOf(&quot;.class&quot;))).replace(&quot;/&quot;,&quot;.&quot;);

                        try {
                            Class&lt;?&gt; clazz = classLoader.loadClass(className);

                            if (clazz.isAnnotationPresent(Component.class)) {
                                String beanName = clazz.getAnnotation(Component.class).value();
                                if (&quot;&quot;.equals(beanName)) {
                                    beanName = Introspector.decapitalize(clazz.getSimpleName());
                                }

                                BeanDefinition beanDefinition = new BeanDefinition();
                                beanDefinition.setType(clazz);
                                if (clazz.isAnnotationPresent(Scope.class)) {
                                    Scope scopeAnnotation = clazz.getAnnotation(Scope.class);
                                    beanDefinition.setScope(scopeAnnotation.value());
                                } else {
                                    beanDefinition.setScope(&quot;singleton&quot;);
                                }

                                beanDefinitionMap.put(beanName,beanDefinition);
                            }
                        } catch (ClassNotFoundException e) {
                            throw new RuntimeException(e);
                        }
                    }
                }
            }
        }

        //createæ‰€æœ‰çš„å•ä¾‹bean
        beanDefinitionMap.keySet().forEach(beanName -&gt; {
            BeanDefinition beanDefinition = beanDefinitionMap.get(beanName);
            if (beanDefinition.getScope().equals(&quot;singleton&quot;)) {
                Object bean = createBean(beanName,beanDefinition);
                singletonObjects.put(beanName,bean);
            }
        });
    }
    //åˆ›å»ºbean
    public Object createBean(String beanName,BeanDefinition beanDefinition) {
        Class clazz = beanDefinition.getType();
        try {
            Object instance = clazz.getConstructor().newInstance();

            //ç®€æ˜“DI
            for (Field f : clazz.getDeclaredFields()) {
                if (f.isAnnotationPresent(Autowired.class)) {
                    f.setAccessible(true);
                    //æŠŠå¸¦autowiredæ³¨è§£çš„å­—æ®µçš„å®ä¾‹è®¾ç½®ä¸ºgetBean(f.getName())
                    f.set(instance,getBean(f.getName()));
                }
            }

            return instance;
        } catch (InstantiationException e) {
            throw new RuntimeException(e);
        } catch (IllegalAccessException e) {
            throw new RuntimeException(e);
        } catch (InvocationTargetException e) {
            throw new RuntimeException(e);
        } catch (NoSuchMethodException e) {
            throw new RuntimeException(e);
        }
    }
    //getBeanæ–¹æ³•å®ç°
    public Object getBean(String beanName) {
        BeanDefinition beanDefinition = beanDefinitionMap.get(beanName);
        if (beanDefinition == null) {
            throw new NullPointerException();
        }

        String scope = beanDefinition.getScope();

        //å•ä¾‹
        if (scope.equals(&quot;singleton&quot;)) {
            Object bean = singletonObjects.get(beanName);

            /*
            æ­¤å¤„ç©ºå¤„ç†çš„åŸå› ï¼šæ¯”å¦‚ï¼Œåœ¨åˆ›å»ºUserServiceçš„beançš„æ—¶å€™ï¼ŒcreateBeanæ–¹æ³•ä¸­ä¼šè¿›è¡Œä¾èµ–æ³¨å…¥OrderServiceï¼Œ
            è€Œæ­¤æ—¶ä¼šè°ƒç”¨getBeanæ–¹æ³•ï¼ˆf.set(instance,getBean(f.getName()));ï¼‰ï¼Œä½†è¿™æ—¶å¯èƒ½å•ä¾‹åº“é‡Œè¿˜æ²¡æœ‰OrderServiceï¼Œ
            æ‰€ä»¥è¦è¿›è¡Œç©ºå¤„ç†å¹¶ä¸”å°†å…¶åŠ å…¥å•ä¾‹åº“
             */
            //æœªè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜
            if (bean == null) {
                bean = createBean(beanName,beanDefinition);
            }
            return bean;
        }

        return createBean(beanName,beanDefinition);
    }
}
</code></pre></div><h2 id="awareå›è°ƒ"><a href="#awareå›è°ƒ" class="header-anchor">#</a> Awareå›è°ƒ</h2> <p>åœ¨springæ–‡ä»¶å¤¹ä¸­åˆ›å»ºæ¥å£BeanNameAware</p> <div class="language- extra-class"><pre class="language-text"><code>public interface BeanNameAware {
    void setBeanName(String beanName);
}
</code></pre></div><p>MyApplicationContextä¸­çš„createBeanæ–¹æ³•å†™å…¥</p> <div class="language- extra-class"><pre class="language-text"><code>public Object createBean(String beanName,BeanDefinition beanDefinition) {
    ...
        //beanNameçš„awareå›è°ƒ
        if (instance instanceof BeanNameAware) {
            ((BeanNameAware)instance).setBeanName(beanName);
        }
    ...
}
</code></pre></div><p>serviceç±»è¦å®ç°BeanNameAwareï¼Œæ‰èƒ½è¿›è¡Œawareå›è°ƒ</p> <h2 id="springçš„åˆå§‹åŒ–"><a href="#springçš„åˆå§‹åŒ–" class="header-anchor">#</a> Springçš„åˆå§‹åŒ–</h2> <p>åˆ›å»ºæ¥å£InitializeBeanï¼Œéœ€è¦serviceç±»å®ç°è¯¥æ¥å£</p> <div class="language- extra-class"><pre class="language-text"><code>public interface InitializeBean {
    void afterPropertiesSet();
}
</code></pre></div><p>MyApplicationContextä¸­çš„createBeanæ–¹æ³•å†™å…¥</p> <div class="language- extra-class"><pre class="language-text"><code>
public Object createBean(String beanName,BeanDefinition beanDefinition) {
    ...
        //ç±»çš„åˆå§‹åŒ–
        if (instance instanceof InitializeBean) {
            ((InitializeBean)instance).afterPropertiesSet();
        }
    ...
}

</code></pre></div><h2 id="beanpostprocessoræœºåˆ¶"><a href="#beanpostprocessoræœºåˆ¶" class="header-anchor">#</a> BeanPostProcessoræœºåˆ¶</h2> <p>åˆ›å»ºæ¥å£BeanPostProcessor</p> <div class="language- extra-class"><pre class="language-text"><code>public interface BeanPostProcessor {
    void postProcessorBeforeInitialization(String beanName,Object bean);
    void postProcessorAfterInitialization(String beanName,Object bean);
}
</code></pre></div><p>åˆ›å»ºè‡ªå®šä¹‰çš„MyBeanPostProcessorç±»å®ç°BeanPostProcessoræ¥å£åŠå…¶æ–¹æ³•ï¼Œåœ¨å…¶ä¸­å¯¹serviceç±»å®ç°æ“ä½œï¼Œå¹¶å°†MyBeanPostProcessoråŠ å…¥Springå®¹å™¨ï¼ˆ@Componentï¼‰</p> <div class="language- extra-class"><pre class="language-text"><code>@Component
public class MyBeanPostProcessor implements BeanPostProcessor {
    @Override
    public void postProcessorBeforeInitialization(String beanName, Object bean) {
    //æ ¹æ®beanNameåå­—åˆ¤æ–­/æ ¹æ®beanç±»å‹åˆ¤æ–­
    //æ“ä½œ
    }

    @Override
    public void postProcessorAfterInitialization(String beanName, Object bean) {

    }
}
</code></pre></div><p>åˆ›å»ºBeanPostProcessorçš„listé›†åˆä»¥æ”¾å…¥å®ç°è¯¥æ¥å£çš„å®ä¾‹ã€‚
æ‰«æç±»æ³¨è§£æ—¶åŠ å…¥ï¼ˆåœ¨MyApplicationContextçš„æ„é€ æ–¹æ³•ï¼‰</p> <div class="language- extra-class"><pre class="language-text"><code>...
private ArrayList&lt;BeanPostProcessor&gt; beanPostProcessors = new ArrayList&lt;&gt;();
...
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>if (clazz.isAnnotationPresent(Component.class)) {
    if (BeanPostProcessor.class.isAssignableFrom(clazz)) {  //è¯¥ç±»å®ç°æ¥å£
        BeanPostProcessor instance = (BeanPostProcessor) clazz.newInstance();
        beanPostProcessors.add(instance);

    }

    String beanName = clazz.getAnnotation(Component.class).value();
    if (&quot;&quot;.equals(beanName)) {
        beanName = Introspector.decapitalize(clazz.getSimpleName());
    }
    ...
</code></pre></div><p>åœ¨createBeanæ–¹æ³•ç±»åˆå§‹åŒ–å‰åå®ç°BeanPostProcessorå®ç°ç±»çš„è‡ªå®šä¹‰æ–¹æ³•ä¸­çš„æ“ä½œ</p> <div class="language- extra-class"><pre class="language-text"><code>...
//beanNameçš„awareå›è°ƒ
if (instance instanceof BeanNameAware) {
    ((BeanNameAware)instance).setBeanName(beanName);
}

//å®ç°BeanPostProcessoræ–¹æ³•
for (BeanPostProcessor beanPostProcessor : beanPostProcessors) {
    beanPostProcessor.postProcessorBeforeInitialization(beanName,instance);
}

//ç±»çš„åˆå§‹åŒ–
if (instance instanceof InitializeBean) {
    ((InitializeBean)instance).afterPropertiesSet();
}

//å®ç°BeanPostProcessoræ–¹æ³•
for (BeanPostProcessor beanPostProcessor : beanPostProcessors) {
    beanPostProcessor.postProcessorAfterInitialization(beanName,instance);
}
...
</code></pre></div><h2 id="aopæœºåˆ¶"><a href="#aopæœºåˆ¶" class="header-anchor">#</a> AOPæœºåˆ¶</h2> <p>ç°åœ¨createBeanæ–¹æ³•returnçš„æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œè€ŒAOPè¦æ±‚è¿”å›çš„å¯¹è±¡æ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡</p> <p>ä½¿ç”¨jdkä»£ç†ï¼ˆserviceç±»éœ€è¦æ¥å£ï¼‰
ç›®æ ‡ï¼šcreateBeanæ–¹æ³•ç»è¿‡BeanPostProcessorå®ç°ç±»çš„æ–¹æ³•åè¿”å›ä»£ç†å¯¹è±¡</p> <p>ä¿®æ”¹æ¥å£BeanPostProcessorè¿”å›å€¼</p> <div class="language- extra-class"><pre class="language-text"><code>public interface BeanPostProcessor {
    Object postProcessorBeforeInitialization(String beanName,Object bean);
    Object postProcessorAfterInitialization(String beanName,Object bean);
}
</code></pre></div><p>ä¿®æ”¹MyBeanPostProcessorç±» ä»£ç†é€»è¾‘ä¸­å®ç°åˆ‡é¢æ–¹æ³•</p> <div class="language- extra-class"><pre class="language-text"><code>@Component
public class MyBeanPostProcessor implements BeanPostProcessor {
    @Override
    public Object postProcessorBeforeInitialization(String beanName, Object bean) {
        return bean;
    }

    @Override
    public Object postProcessorAfterInitialization(String beanName, Object bean) {
        if (beanName.equals(&quot;userService&quot;)) {
            Object proxyInstance = Proxy.newProxyInstance(MyBeanPostProcessor.class.getClassLoader(), bean.getClass().getInterfaces(), new InvocationHandler() {
                @Override
                public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                    //åˆ‡é¢é€»è¾‘
                    return method.invoke(bean,args);
                }
            });

            return proxyInstance;  //returnä¸€ä¸ªä»£ç†å¯¹è±¡
        }
        return bean;
    }
}
</code></pre></div><p>ä¿®æ”¹createBeanæ–¹æ³•</p> <div class="language- extra-class"><pre class="language-text"><code>//beanNameçš„awareå›è°ƒ
if (instance instanceof BeanNameAware) {
    ((BeanNameAware)instance).setBeanName(beanName);
}

//å®ç°BeanPostProcessoræ–¹æ³•
for (BeanPostProcessor beanPostProcessor : beanPostProcessors) {
    instance = beanPostProcessor.postProcessorBeforeInitialization(beanName,instance);
}

//ç±»çš„åˆå§‹åŒ–
if (instance instanceof InitializeBean) {
    ((InitializeBean)instance).afterPropertiesSet();
}

//å®ç°BeanPostProcessoræ–¹æ³•
for (BeanPostProcessor beanPostProcessor : beanPostProcessors) {
    instance = beanPostProcessor.postProcessorAfterInitialization(beanName,instance);
}

return instance;
</code></pre></div><p>å¦‚æœç»è¿‡BeanPostProcessoræ–¹æ³•ï¼Œæ­¤æ—¶returnçš„instanceå°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ä»£ç†å¯¹è±¡</p> <h2 id="beançš„ç”Ÿå‘½å‘¨æœŸ"><a href="#beançš„ç”Ÿå‘½å‘¨æœŸ" class="header-anchor">#</a> Beançš„ç”Ÿå‘½å‘¨æœŸ</h2> <h3 id="beanåˆ›å»ºçš„ç”Ÿå‘½å‘¨æœŸ"><a href="#beanåˆ›å»ºçš„ç”Ÿå‘½å‘¨æœŸ" class="header-anchor">#</a> beanåˆ›å»ºçš„ç”Ÿå‘½å‘¨æœŸ</h3> <blockquote><p>service.class -&gt; æ¨æ–­æ„é€ æ–¹æ³• -&gt; å¯¹è±¡ -&gt; DI -&gt;
åˆå§‹åŒ–å‰ï¼ˆ@PostConstructï¼‰ -&gt; åˆå§‹åŒ–
ï¼ˆafterPropertiesSetæ–¹æ³•ï¼‰ -&gt; åˆå§‹åŒ–å ï¼ˆAOPï¼‰ -&gt; ï¼ˆä»£ç†å¯¹è±¡ï¼‰
-&gt; æ”¾å…¥å•ä¾‹æ±  -&gt; beanå¯¹è±¡</p></blockquote> <h3 id="åˆå§‹åŒ–å‰å’Œåˆå§‹åŒ–æ—¶"><a href="#åˆå§‹åŒ–å‰å’Œåˆå§‹åŒ–æ—¶" class="header-anchor">#</a> åˆå§‹åŒ–å‰å’Œåˆå§‹åŒ–æ—¶</h3> <p>å‡è®¾serviceç±»ä¸­æœ‰ä¸€ä¸ªå±æ€§private User
adminï¼Œå¦‚ä½•ç»™åœ¨beanåˆ›å»ºçš„æ—¶å€™ç»™è¿™ä¸ªå±æ€§èµ‹å€¼ï¼Ÿ
å¦‚æœåˆ©ç”¨Autowiredï¼Œspringå¹¶ä¸çŸ¥é“è¯¥ç»™adminèµ‹å€¼ä¸ºä»€ä¹ˆï¼ˆæ¯”å¦‚æŸ¥è¯¢æ•°æ®åº“å¾—åˆ°èµ‹å€¼ï¼‰ï¼Œæ‰€ä»¥è¦è‡ªå®šä¹‰æ–¹æ³•æ¥ç»™adminèµ‹å€¼ã€‚</p> <blockquote><p>å®ç°1:
æ­¤æ—¶å¯ä»¥å†™ä¸€ä¸ªæ–¹æ³•fï¼Œåœ¨fä¸­å®ç°adminçš„èµ‹å€¼é€»è¾‘ï¼Œå¹¶åœ¨åˆå§‹åŒ–å‰è¿›è¡Œfçš„è°ƒç”¨ã€‚
å¦‚ä½•è¿›è¡Œåˆå§‹åŒ–å‰è°ƒç”¨ï¼Ÿåœ¨æ–¹æ³•ä¸Šä½¿ç”¨@PostConstructæ³¨è§£</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>é€»è¾‘å¦‚ä¸‹ï¼š
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>for(Method method: Service. getClass). getDeclaredMethods()) {
        if (method.isAnnotationPresent(PostConstruct.class)) {
            method.invoke(userService1,null);
    }
</code></pre></div><blockquote><p>å®ç°2:
serviceç±»å®ç°InitializingBeanæ¥å£ï¼Œé‡å†™å…¶ä¸­çš„afterPropertiesSetæ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­å®ç°é€»è¾‘èµ‹å€¼
è¯¥æ–¹æ³•ä¼šåœ¨springåˆå§‹åŒ–çš„æ—¶å€™è¢«è°ƒç”¨</p></blockquote> <blockquote><p>è¯¥æ–¹æ³•çš„å®ç°é€»è¾‘ï¼š
è¿›å…¥AbstractAutowiredCapableBeanFactoryç±»çš„doCreateBeanæ–¹æ³•ï¼Œ
ç”¨æ„é€ æ–¹æ³•å¾—åˆ°å¯¹è±¡å®ä¾‹ï¼Œ è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œ populatedBeanæ–¹æ³•å±æ€§å¡«å……ï¼Œ
initializeBeanæ–¹æ³• { awareå›è°ƒï¼Œ åˆå§‹åŒ–å‰ï¼Œ
åˆå§‹åŒ–ï¼šåˆ¤æ–­æœ‰æ²¡æœ‰å®ç°InitializingBeanï¼Œæ‰§è¡ŒafterPropertiesSetæ–¹æ³•ï¼Œ
åˆå§‹åŒ–å }ï¼Œ â€¦â€¦</p></blockquote> <h3 id="æ¨æ–­æ„é€ æ–¹æ³•"><a href="#æ¨æ–­æ„é€ æ–¹æ³•" class="header-anchor">#</a> æ¨æ–­æ„é€ æ–¹æ³•</h3> <p>æ¨æ–­æ„é€ æ–¹æ³•çš„åº•å±‚åŸç†ï¼Ÿ</p> <blockquote><p>Q1ï¼šprivate OrderService
orderServiceå¹¶æœªåŠ @Autowiredæ³¨è§£ã€‚å¦‚æœæœ‰1ï¼Œè¾“å‡ºä»€ä¹ˆï¼Ÿå¦‚æœæœ‰1ã€2ï¼Œè¾“å‡ºä»€ä¹ˆï¼Ÿå¦‚æœæœ‰2ã€3ï¼Œè¾“å‡ºä»€ä¹ˆï¼Ÿ</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>@Component
public class UserService {
    private OrderService orderService;
    1ï¸âƒ£public UserService() {
        System.out.println(0);
    ï½
    2ï¸âƒ£public UserService(OrderService orderService) {
        this.orderService = orderService;
        System.out.println(1);
    }
    3ï¸âƒ£public UserService(OrderService orderService, OrderService orderService1) {
        this.orderService = orderService;
        System.out.println(2);
    }
    ...
</code></pre></div><blockquote><p>ç»“æœï¼š 1.è¾“å‡º0ï¼Œå¹¶ä¸”å±æ€§orderServiceä¸ºnullã€‚
2.è¾“å‡º1ï¼Œå¹¶ä¸”å±æ€§orderServiceä¸ä¸ºç©ºã€‚ 3.æŠ¥é”™</p></blockquote> <blockquote><p>åŸå› åˆ†æï¼š å¦‚è¿‡ä»…å­˜åœ¨ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œåˆ™springä¼šè°ƒç”¨è¯¥æ„é€ æ–¹æ³•ï¼›
å¦‚æœå­˜åœ¨å¤šä¸ªæ„é€ æ–¹æ³•ï¼Œåˆ™springä¼šåœ¨è¿™äº›æ„é€ æ–¹æ³•ä¸­å¯»æ‰¾æ— å‚æ„é€ æ–¹æ³•ã€‚å¦‚æœæ‰¾åˆ°å°±ä¼šè°ƒç”¨ï¼Œæ‰¾ä¸åˆ°å°±ä¼šæŠ¥é”™ã€‚</p></blockquote> <blockquote><p>Q2ï¼šå¦‚ä½•è®©springè°ƒç”¨æŒ‡å®šçš„æ„é€ æ–¹æ³•ï¼Ÿ
åœ¨æƒ³è¢«è°ƒç”¨çš„æ„é€ æ–¹æ³•åŠ ä¸Š@Autowiredæ³¨è§£</p></blockquote> <blockquote><p>Q3ï¼šå‰é¢ç»“æœ2å±æ€§orderServiceä¸ä¸ºnullï¼Œspringå¦‚ä½•ä¸ºå±æ€§èµ‹å€¼ï¼Ÿ
å±æ€§å¦‚æœä¸æ˜¯beanï¼Œåˆ™ä¼šæŠ¥é”™ï¼›
å±æ€§å¦‚æœæ˜¯å•ä¾‹beanï¼Œå°±ä¼šå»å•ä¾‹æ± é‡Œå¯»æ‰¾ï¼Œå¦‚æœæœ‰å°±ä¼šèµ‹å€¼ï¼Œæ²¡æœ‰ä¼šåˆ›å»ºbeanï¼›
å±æ€§å¦‚æœä¸æ˜¯å•ä¾‹beanï¼Œå°±ä¼šç›´æ¥åˆ›å»ºbean</p></blockquote> <blockquote><p>Q4ï¼šåœ¨map&lt;beanName,Beanå¯¹è±¡&gt;å•ä¾‹æ± ä¸­å¯»æ‰¾beançš„æ—¶å€™ï¼Œå¦‚æœæ ¹æ®beanNameæŸ¥æ‰¾ä¸å¯è¡Œï¼Œå› ä¸ºpublic
UserService(OrderService
orderService)ä¸­å½¢å‚åå­—å¯ä»¥éšä¾¿å–ã€‚æ‰€ä»¥æ ¹æ®ç±»å‹æ¥å–å¾—ã€‚ä½†æ˜¯æ ¹æ®ç±»å‹è·å–ä¼šå‡ºç°ä¸€ä¸ªvalueå¯¹åº”å¤šä¸ªkeyçš„æƒ…å†µï¼Œæˆ–è€…å¤šä¸ªvalueéƒ½æ˜¯åŒä¸€ç±»å‹ã€‚å¦‚ä½•è§£å†³ï¼Ÿ</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>@Component
public class OrderService {}

@Bean
public OrderService orderService1(){return new OrderService();}
@Bean
public OrderService orderService2(){return new OrderService();}

//è¿™ä¸‰ä¸ªorderServiceä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯ç±»å‹ç›¸åŒï¼ˆå³å¤šä¸ªvalueéƒ½æ˜¯åŒä¸€ç±»å‹ï¼‰
</code></pre></div><blockquote><p>è§£å†³æ–¹æ³•ï¼šå…ˆæ ¹æ®typeæŸ¥æ‰¾ã€‚å¦‚æœtypeæŸ¥åˆ°æœ‰å¤šä¸ªï¼Œå°±æ ¹æ®nameç­›é€‰ï¼›å¦‚æœåªæŸ¥åˆ°ä¸€ä¸ªï¼Œå°±ç›´æ¥èµ‹å€¼ã€‚</p></blockquote> <blockquote><p>å› æ­¤ï¼Œæ¨æ–­æ„é€ æ–¹æ³•æœ‰ä¸¤æ­¥ï¼š 1.é€‰æ‹©æ„é€ æ–¹æ³•
2.å®ç°æ„é€ æ–¹æ³•å…¥å‚å±æ€§èµ‹å€¼</p></blockquote> <h3 id="ä¾èµ–æ³¨å…¥"><a href="#ä¾èµ–æ³¨å…¥" class="header-anchor">#</a> ä¾èµ–æ³¨å…¥</h3> <p>ä¾èµ–æ³¨å…¥çš„åŸç†ï¼Ÿ</p> <blockquote><p>1.æŸ¥æ‰¾å±æ€§ 2.ä¸æ„é€ æ–¹æ³•å…¥å‚ç›¸åŒçš„æ–¹æ³•è¿›è¡Œå±æ€§èµ‹å€¼</p></blockquote> <h3 id="ä»£ç†å¯¹è±¡"><a href="#ä»£ç†å¯¹è±¡" class="header-anchor">#</a> ä»£ç†å¯¹è±¡</h3> <p>Q1ï¼šæ”¾å…¥å•ä¾‹æ± çš„æ˜¯åŸå¯¹è±¡è¿˜æ˜¯ä»£ç†å¯¹è±¡ï¼Ÿ</p> <blockquote><p>å¦‚æœéœ€è¦å®ç°AOPï¼Œåˆ™æ”¾å…¥çš„æ˜¯ä»£ç†å¯¹è±¡ï¼›
å¦‚æœä¸éœ€è¦ï¼Œåˆ™æ”¾å…¥çš„æ˜¯åŸå¯¹è±¡</p></blockquote> <p>Q2ï¼šä»£ç†å¯¹è±¡è¢«æ ‡è®°@Autowiredçš„å±æ€§çš„å€¼æ˜¯å¦ä¸ºç©ºï¼Ÿ</p> <blockquote><p>å±æ€§å€¼ä¸ºç©ºï¼Œå› ä¸ºä»£ç†å¯¹è±¡äº§ç”Ÿåå¹¶æœªè¿›è¡ŒDIå°±åŠ å…¥äº†å•ä¾‹æ± ã€‚</p></blockquote> <p>Q3ï¼šå¦‚æœä¸ºç©ºï¼Œé‚£ä¸ºä»€ä¹ˆæ‰“å°è¾“å‡ºè¯¥å±æ€§çš„æ—¶å€™å¹¶ä¸ä¸ºç©ºï¼Ÿ &gt;
ä»£ç†ç±»åˆ›å»ºæ—¶æœ‰ä¸€ä¸ªtargetå±æ€§ï¼Œå¹¶å°†ä»£ç†ç±»çš„æ™®é€šç±»èµ‹å€¼ç»™è¯¥targetå±æ€§ã€‚è°ƒç”¨testæ–¹æ³•æ—¶ï¼Œæ‰§è¡Œçš„æ˜¯ä»£ç†ç±»çš„testæ–¹æ³•ã€‚ä»£ç†ç±»çš„testæ–¹æ³•å…ˆè¿›è¡ŒAOPï¼Œç„¶åè°ƒç”¨target.test()ï¼Œå³è°ƒç”¨æ™®é€šç±»çš„testæ–¹æ³•ã€‚targetæ˜¯æ™®é€šç±»è¿›è¡Œäº†DIï¼Œå› æ­¤é¿å…äº†å±æ€§ä¸ºç©ºçš„é—®é¢˜ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>class UserServiceProxy extends UserService {
    UserService target;
    public void test(){
        //åˆ‡é¢é€»è¾‘@Before
        //target.test();//æ™®é€šå¯¹è±¡.test()
    }
}
</code></pre></div><p>Q4ï¼šQ3ä¸ºä»€ä¹ˆé€šè¿‡å»ºç«‹targetå±æ€§æ¥è§£å†³è€Œä¸æ˜¯ç›´æ¥è°ƒç”¨super.test()ï¼Ÿ &gt;
ï¼Ÿï¼Ÿæˆ‘ä¹Ÿä¸æ¸…æ¥š</p> <p>Q5ï¼šä»£ç†ç±»å¯ä»¥ä¸ç»§æ‰¿æ™®é€šç±»å—ï¼Ÿï¼ˆcglibä»£ç†ï¼‰ &gt;
ä¸å¯ä»¥ã€‚ä¸ç»§æ‰¿å°±ä¸èƒ½å°†ä»£ç†ç±»å¼ºåˆ¶è½¬æ¢ä¸ºæ™®é€šç±»äº†ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>UserService userService = (UserService) applicationContext.getBean(&quot;userService&quot;)
</code></pre></div><h2 id="äº‹åŠ¡ç®¡ç†"><a href="#äº‹åŠ¡ç®¡ç†" class="header-anchor">#</a> äº‹åŠ¡ç®¡ç†</h2> <p>äº‹åŠ¡åˆ‡é¢é€»è¾‘ï¼š</p> <blockquote><p>æ·»åŠ @Transactionæ³¨è§£å¼€å¯äº‹åŠ¡ -&gt; äº‹åŠ¡ç®¡ç†å™¨
æ–°å»ºæ•°æ®åº“è¿æ¥connection -&gt; connection.autocommit = false -&gt;
target.test() -&gt; connection.commit()/rollback()</p></blockquote> <p>Q1ï¼šä¸ºä»€ä¹ˆspringä¼šè®©äº‹åŠ¡ç®¡ç†å™¨å»ºç«‹è¿æ¥ï¼Œè€Œä¸ç›´æ¥è®©jdbcTemplateå»ºç«‹è¿æ¥ï¼Ÿ</p> <blockquote><p>å› ä¸ºjdbcTemplateå»ºç«‹çš„è¿æ¥é»˜è®¤autocommit =
trueï¼Œä¼šç›´æ¥æäº¤ï¼Œèµ·ä¸åˆ°äº‹åŠ¡ç®¡ç†çš„ä½œç”¨</p></blockquote> <p>Q2ï¼šåœ¨serviceç±»ä¸­æ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼Œè°ƒç”¨testæ–¹æ³•ï¼Œaæ–¹æ³•çš„@Transactionalæ³¨è§£ä¼šä¸ä¼šèµ·ä½œç”¨ï¼Ÿ</p> <div class="language- extra-class"><pre class="language-text"><code>@Transactional
public void test() {
    jdbcTemplate.execute(&quot;...&quot;);
    a();
}

@Transactional(propagation = Propagation.NEVER)
public void a {
    jdbcTemplate.execute(&quot;...&quot;);
}
...

</code></pre></div><blockquote><p>ä¸ä¼šã€‚ -&gt; è°ƒç”¨service.test() -&gt; è¿›å…¥ä»£ç†ç±»çš„testæ–¹æ³• -&gt;
ä»£ç†äº†æ‰§è¡Œtarget.test() -&gt; ç”±äºtargetä¸ºæ™®é€šserviceç±»ï¼Œ@Transactionalæ³¨è§£ä¸èµ·ä½œç”¨
-&gt; ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼ˆæ­£å¸¸æƒ…å†µä¸‹@Transactional(propagation =
Propagation.NEVER)ä¼šå¯¼è‡´æŠ›å‡ºå¼‚å¸¸ï¼‰</p> <p>ä¸ºä»€ä¹ˆtestæ–¹æ³•çš„@Transactionalæ³¨è§£æœ‰ç”¨ï¼Ÿ
å› ä¸ºè°ƒç”¨service.test()æ—¶æ‰§è¡Œæ–¹æ³•çš„æ˜¯ä»£ç†ç±»ï¼Œä¼šå»å¤„ç†@Transactionalæ³¨è§£ã€‚è€Œæ‰§è¡Œaæ–¹æ³•çš„æ—¶å€™åªæ˜¯æ™®é€šç±»ã€‚</p></blockquote> <p>Q3ï¼šå¦‚ä½•è§£å†³Q2çš„é—®é¢˜ï¼Ÿ</p> <blockquote><p>1.æ‹†åˆ†ç±»ï¼šæ‹†åˆ†å‡ºå¦å¤–ä¸€ä¸ªç±»s1ï¼Œåœ¨s1ä¸­å†™aæ–¹æ³•ï¼Œå†å°†sç±»æ³¨å…¥åŸservice(s)ç±»ï¼Œåœ¨testæ–¹æ³•ä¸­è°ƒç”¨s.a()å³å¯
2.è‡ªå·±æ³¨å…¥è‡ªå·±
3.å…¶ä»–æ–¹æ³•æ‹¿åˆ°å½“å‰ç±»ä»£ç†å¯¹è±¡ï¼Œä¾‹å¦‚AopContext.currentProxy()</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>@Autowired
private Service s1;

@Transactional
public void test() {
    jdbcTemplate.execute(&quot;...&quot;);
    s1.a();
}

=================================

@Autowired
private Service s;

@Transactional
public void test() {
    jdbcTemplate.execute(&quot;...&quot;);
    s.a();
}
</code></pre></div><p>Q4ï¼š@Configurationæ³¨è§£å¯¹äº‹åŠ¡ç®¡ç†çš„å½±å“ï¼ˆconfigç±»ä¸åŠ @Configurationæ³¨è§£é”™è¯¯é—®é¢˜ï¼‰</p> <blockquote><p>æˆ‘ä»¬çŸ¥é“ï¼Œ 1ï¸âƒ£
springçš„äº‹åŠ¡ç®¡ç†å™¨åˆ›å»ºconnectionæ”¾åœ¨LocalThread&lt;Map&lt;Datasource,connection&gt;&gt;ä¸­ã€‚
â€œä¸ºä»€ä¹ˆæ³›å½¢é‡Œé¢æ”¾çš„æ˜¯mapè€Œä¸ç›´æ¥æ˜¯connection?
å› ä¸ºç°å®å·¥ç¨‹ä¸­å¯èƒ½ä¼šä½¿ç”¨å¤šç§datasourceã€‚â€ 2ï¸âƒ£
ä¸åŠ @Configurationæ³¨è§£æ—¶ï¼ŒjdbcTemplateå’Œäº‹åŠ¡ç®¡ç†å™¨åˆ›å»ºçš„datasourceå¯¹è±¡ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œåªæœ‰äº‹åŠ¡ç®¡ç†å™¨åˆ›å»ºå‡ºæ¥çš„å¯¹è±¡æ‰æœ‰äº‹åŠ¡å¤„ç†çš„åŠŸèƒ½ï¼ŒjdbcTemplateçš„autocommit
= true</p> <p>å› æ­¤ï¼ŒåŠ ä¸Š@Configurationæ³¨è§£ä¼šä½¿jdbcTemplateè°ƒç”¨çš„æ˜¯äº‹åŠ¡ç®¡ç†å™¨åˆ›å»ºçš„datasourceï¼Œè€Œä¸ä¼šè‡ªå·±å†åˆ›å»ºä¸€ä¸ªæ–°çš„datasourceï¼Œé¿å…äº‹åŠ¡ç®¡ç†çš„å¤±æ•ˆã€‚</p></blockquote> <p>Q5ï¼š@Configurationæ³¨è§£è§£å†³Q4çš„åŸç†ï¼Ÿ</p> <blockquote><p>@Configurationï¼ŒAOPï¼Œ@Lazyéƒ½æ˜¯ä½¿ç”¨çš„åŠ¨æ€ä»£ç†æœºåˆ¶
AppConfigåŠ ä¸Š@Configurationæ³¨è§£ä¹‹åä¼šç”Ÿæˆä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>public classAppConfig {//configç±»
    @Bean
    public IdbcTemplate jdbcTemplate() {
        return new JdbcTemplate(dataSource());
    }
    @Bean
    public PlatformTransactionManager transactionManager() {
        DataSourceTransactionManager transactionManager = new DataSourceTransactionManager();
        transactionManager.setDataSource(dataSource());
        return transactionManager;
    }
    @Bean
    public void datasource() {
        ...
    }

    ...
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>class UserServiceProxy extends AppConfigï½›//configä»£ç†ç±»
    UserService target;
    public void jdbcTemplate(){
        //ä»£ç†é€»è¾‘
        super.jdbcTemplate();
    }
    public void datasource(){
        //ä»£ç†é€»è¾‘
    }
ï½
</code></pre></div><blockquote><p>configç±»ä¸­jdbcTemplate()å’ŒtransactionManager()æ–¹æ³•ä¸­çš„datasource()æ–¹æ³•éƒ½æ˜¯ä»£ç†ç±»è°ƒç”¨çš„</p></blockquote> <blockquote><p>ä»£ç†ç±»æ¥è°ƒç”¨jdbcTemplate()å’Œdatasource()æ–¹æ³•ã€‚
ä»£ç†ç±»åœ¨è°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•æ—¶ï¼Œä¼šé¦–å…ˆæ‰§è¡Œä»£ç†é€»è¾‘ã€‚å³ï¼šåœ¨æ‰§è¡ŒjdbcTemplate()æ–¹æ³•æ—¶ï¼Œå…ˆæ£€æµ‹springå®¹å™¨é‡Œé¢æœ‰æ²¡æœ‰datasourceï¼Œå¦‚æœæœ‰å°±ç›´æ¥è¿”å›springå®¹å™¨ä¸­çš„datasourceï¼›å¦‚æœæ²¡æœ‰å°±è°ƒç”¨datasource()æ–¹æ³•å»åˆ›å»ºä¸€ä¸ªdatasourceå¹¶æ”¾å…¥springå®¹å™¨ã€‚
é€šè¿‡è¿™ç§æ–¹å¼æ¥ä¿è¯jdbcTemplate()å’Œdatasource()å¾—åˆ°çš„æ˜¯åŒä¸€ä¸ªdatasource</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>//åœ¨configç±»ä¸­

@Bean
public JdbcTemplate jdbcTemplate() {
    return new JdbcTemplate (dataSource)());
}
@Bean
public PlatformTransactionManager transactionManager() {
    DataSourceTransactionManager transactionManager = new DataSourceTransactionManager();
    transactionManager.setDataSource(dataSource1());
    return transactionManager;
}
</code></pre></div><blockquote><p>ä¸Šè¿°ä»£ç çš„æƒ…å†µï¼šå¦‚æœjdbcTemplate()å’ŒtransactionManager()æ–¹æ³•ä¸­çš„datasourceä¸æ˜¯åŒä¸€ä¸ªï¼Œå³ä½¿åŠ @Configurationæ³¨è§£ä¹Ÿä¼šå‡ºç°Q4é”™è¯¯</p></blockquote> <h2 id="å¾ªç¯ä¾èµ–"><a href="#å¾ªç¯ä¾èµ–" class="header-anchor">#</a> å¾ªç¯ä¾èµ–</h2> <blockquote><p>ä¸‰çº§ç¼“å­˜(ä¸‰ä¸ªmap) singletonobjects(å³å•ä¾‹æ± ) -&gt;
ä¿å­˜æ‹¥æœ‰å®Œæ•´ç”Ÿå‘½å‘¨æœŸçš„bean earlySingletonobjects -&gt;
beanè¢«å¾ªç¯ä¾èµ–ï¼Œæå‰äº§ç”Ÿä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œä¿å­˜åˆ°äºŒçº§ç¼“å­˜ï¼Œä¿è¯å•ä¾‹
singletonFactories -&gt;
æ‰“ç ´å¾ªç¯ï¼Œå…ˆå­˜åˆ°ä¸‰çº§ç¼“å­˜ï¼Œå‡ºç°å¾ªç¯ä¾èµ–çš„æƒ…å†µä¸‹æ‰èƒ½æ‹¿åˆ°è¢«ä¾èµ–çš„å¯¹è±¡</p></blockquote> <h3 id="å¼•å…¥"><a href="#å¼•å…¥" class="header-anchor">#</a> å¼•å…¥</h3> <blockquote><p>èƒŒæ™¯ï¼šAServiceç±»æ³¨å…¥äº†BServiceç±»å±æ€§ï¼ŒBServiceç±»æ³¨å…¥äº†AServiceç±»å±æ€§</p></blockquote> <blockquote><p>è§£å†³æ–¹æ³•ï¼šåˆ©ç”¨ä¸€ä¸ªmapè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜</p></blockquote> <p>AServiceçš„Beançš„ç”Ÿå‘½å‘¨æœŸï¼š 1.
ï»¿ï»¿å®ä¾‹åŒ–â€”&gt;AServiceæ™®é€šå¯¹è±¡â€”&gt;map.put(â€œAServiceâ€,AServiceæ™®é€šå¯¹è±¡ï¼‰ 2.
ï»¿ï»¿ï»¿å¡«å……bServiceâ€”&gt;å•ä¾‹æ± Mapâ€”&gt;åˆ›å»ºBService BServiceçš„Beançš„ç”Ÿå‘½å‘¨æœŸï¼š</p> <ol><li>å®ä¾‹åŒ–â€”&gt;æ™®é€šå¯¹è±¡ 2.
ï»¿ï»¿å¡«å……aServiceâ€”&gt;å•ä¾‹æ± Mapâ€”&gt;mapâ€”&gt;AServiceæ™®é€šå¯¹è±¡ 3. ï»¿ï»¿å¡«å……å…¶ä»–å±æ€§</li> <li>åšä¸€äº›å…¶ä»–çš„äº‹æƒ…ï¼ˆAOPï¼‰â€”&gt; AServiceçš„ä»£ç†å¯¹è±¡ 5. ï»¿ï»¿ï»¿æ·»åŠ åˆ°å•ä¾‹æ±  3.
ï»¿ï»¿å¡«å……å…¶ä»–å±æ€§ 4. ï»¿ï»¿ï»¿åšä¸€äº›å…¶ä»–çš„äº‹æƒ… 5. ï»¿ï»¿æ·»åŠ åˆ°å•ä¾‹æ± </li></ol> <blockquote><p>å‡ºç°é—®é¢˜ï¼šæ³¨å…¥bServiceçš„AServiceå±æ€§æ˜¯AServiceçš„æ™®é€šå¯¹è±¡ï¼Œè€ŒåŠ å…¥å•ä¾‹æ± æ˜¯AServiceçš„ä»£ç†å¯¹è±¡</p></blockquote> <blockquote><p>è§£å†³æ–¹æ³•ï¼šæœªå‡ºç°å¾ªç¯ä¾èµ–çš„beanä¸æå‰è¿›è¡ŒAOPï¼Œåªæœ‰å‡ºç°å¾ªç¯ä¾èµ–çš„beanæå‰è¿›è¡ŒAOPã€‚åŠ å…¥ï»¿creatingSetå­˜æ”¾æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–çš„beanï¼Œåœ¨ç¬¬2.2é€šè¿‡æ£€æŸ¥creatingSetåˆ¤æ–­å¾ªç¯ä¾èµ–ï¼Œå†³å®šæ˜¯å¦æå‰è¿›è¡ŒAOPã€‚</p></blockquote> <ol><li>creatingSet&lt;AServiceâ€º</li> <li>å®ä¾‹åŒ–â€“&gt;AServiceæ™®é€šå¯¹è±¡</li> <li>å¡«å……bServiceâ€”&gt;å•ä¾‹æ± Mapâ€”&gt;åˆ›å»ºBService
BServiceçš„Beançš„ç”Ÿå‘½å‘¨æœŸï¼š 2.1 å®ä¾‹åŒ–â€“&gt;æ™®é€šå¯¹è±¡ 2.2
å¡«å……aServiceâ€”&gt;å•ä¾‹æ± Mapâ€”&gt;creatingSetâ€”&gt;AServiceå‡ºç°äº†å¾ªç¯ä¾èµ–â€”&gt;<em>AOPâ€”&gt;
aServiceä»£ç†å¯¹è±¡â€”&gt;æ·»åŠ åˆ°å•ä¾‹æ± </em> 2.3 å¡«å……å…¶ä»–å±æ€§ 2.4
åšä¸€äº›å…¶ä»–çš„äº‹æƒ…ï¼ˆAOPï¼‰ 2.5 æ·»åŠ åˆ°å•ä¾‹æ± </li> <li>å¡«å……å…¶ä»–å±æ€§ *5.ï»¿åšä¸€äº›å…¶ä»–çš„äº‹æƒ…ï¼ˆAOPï¼‰â€”&gt;AServiceä»£ç†å¯¹è±¡</li> <li>æ·»åŠ åˆ°å•ä¾‹æ± *</li> <li>creatingSet.remove&lt;â€˜AServiceâ€™&gt;</li></ol> <blockquote><p>å‡ºç°é—®é¢˜ï¼šæ˜¯å¦åº”è¯¥å°†5ã€6æå‰åˆ°2.2æ–œä½“éƒ¨åˆ†ï¼Ÿ</p></blockquote> <blockquote><p>ç­”æ¡ˆï¼šä¸åº”è¯¥åœ¨2.2æ–œä½“éƒ¨åˆ†åŠ å…¥å•ä¾‹æ± ã€‚ å› ä¸ºå­˜åœ¨ä¸€äº›æ½œåœ¨çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼š</p></blockquote> <ol><li></li></ol> <p>æ­¤æ—¶aServiceæ™®é€šå¯¹è±¡è¿˜æœªåˆå§‹åŒ–å®Œæˆï¼Œä»£ç†å¯¹è±¡åˆ›å»ºè¿‡ç¨‹ä¸­å¯èƒ½æ‹¿ä¸åˆ°æ™®é€šå¯¹è±¡
2.
æ­¤æ—¶aServiceæ™®é€šå¯¹è±¡è¿˜æœªåˆå§‹åŒ–å®Œæˆï¼Œå› æ­¤aServiceä»£ç†å¯¹è±¡ä¸­çš„targetå±æ€§ä¸ºç©ºæˆ–ä¸å®Œæ•´ã€‚æ­¤æ—¶å¦‚æœæœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨å•ä¾‹æ± ä¸­çš„aServiceä»£ç†å¯¹è±¡ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚</p> <blockquote></blockquote> <h3 id="äºŒçº§ç¼“å­˜"><a href="#äºŒçº§ç¼“å­˜" class="header-anchor">#</a> äºŒçº§ç¼“å­˜</h3> <blockquote><p>å‡ºç°é—®é¢˜ï¼š
èƒŒæ™¯ï¼šå¦‚æœaServiceä¾èµ–bServiceå’ŒcServiceï¼Œè€ŒbServiceå’ŒcServiceéƒ½ä¾èµ–aServiceï¼Œé‚£bServiceå’ŒcServiceåœ¨åˆå§‹åŒ–çš„æ—¶å€™éƒ½éœ€è¦åˆ›å»ºaServiceçš„ä»£ç†å¯¹è±¡ï¼Œä¸å•ä¾‹æ¨¡å¼äº§ç”ŸçŸ›ç›¾ã€‚</p></blockquote> <blockquote><p>è§£å†³æ–¹æ³•ï¼šåˆ©ç”¨ç¬¬äºŒçº§ç¼“å­˜earlySingletonobjectsï¼Œåœ¨béœ€è¦açš„æ—¶å€™åˆ›å»ºaçš„ä»£ç†å¯¹è±¡å¹¶å°†å…¶åŠ å…¥earlySingletonobjectsï¼Œcåœ¨éœ€è¦açš„æ—¶å€™ç›´æ¥ä»äºŒçº§ç¼“å­˜é‡Œé¢æ‹¿ã€‚</p></blockquote> <p><em>äºŒçº§ç¼“å­˜çš„ä½œç”¨ï¼šå­˜å‚¨å‡ºç°å¾ªç¯ä¾èµ–é—®é¢˜æ—¶è¿˜æœªå®Œæˆå®Œæ•´ç”Ÿå‘½å‘¨æœŸçš„æ—©æœŸçš„beanå¯¹è±¡ï¼Œä¿æŒå•ä¾‹æ€§</em></p> <blockquote><p>é—®é¢˜ï¼šä»€ä¹ˆæ—¶å€™å°†aServiceä»£ç†å¯¹è±¡åŠ å…¥å•ä¾‹æ± ï¼Ÿ</p></blockquote> <blockquote><p>ç­”æ¡ˆï¼šåœ¨aServiceå¡«å……å®Œæ‰€æœ‰å±æ€§å¹¶è¿›è¡Œå®Œå…¶ä»–çš„äº‹æƒ…ï¼ˆå¦‚AOPï¼‰ä¹‹åï¼ŒearlySingletonobjects.get(AService)å¾—åˆ°açš„ä»£ç†å¯¹è±¡ï¼ŒåŠ å…¥å•ä¾‹æ± </p></blockquote> <blockquote><p>é—®é¢˜ï¼šç¬¬å››æ­¥â€œå¡«å……å…¶ä»–å±æ€§â€æ˜¯aServiceæ™®é€šå¯¹è±¡è¿˜æ˜¯ä»£ç†å¯¹è±¡ï¼Ÿ</p></blockquote> <blockquote><p>ç­”æ¡ˆï¼šæ™®é€šå¯¹è±¡ã€‚ä»£ç†å¯¹è±¡å­˜åœ¨çš„æ„ä¹‰ä»…ä»…æ˜¯æ‰§è¡Œåˆ‡é¢é€»è¾‘ã€‚</p></blockquote> <h3 id="ä¸‰çº§ç¼“å­˜"><a href="#ä¸‰çº§ç¼“å­˜" class="header-anchor">#</a> ä¸‰çº§ç¼“å­˜</h3> <p><em>ä¸‰çº§ç¼“å­˜çš„ä½œç”¨æ˜¯æ‰“ç ´å¾ªç¯ã€‚</em></p> <p>singletonFactoriesé‡Œå­˜æ”¾çš„æ˜¯(beanNameï¼Œlambdaè¡¨è¾¾å¼)ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>singletonFactories.put('AService',()-&gt; getEarlyBeanReference(beanName,mbd,AServiceæ™®é€šå¯¹è±¡))
</code></pre></div><p>æºç ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>//åˆ¤æ–­æ˜¯å¦æ˜¯å•ä¾‹ï¼Œæ˜¯å¦æ”¯æŒå¾ªç¯ä¾èµ–ï¼ˆé»˜è®¤trueï¼‰ï¼Œæ˜¯å¦æ­£åœ¨è¢«åˆ›å»º
boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName));

//å¦‚æœéƒ½æ˜¯
if(earlySingletonExposure) {
    if(logger.isTraceEnabled()) {
        Logger.trace(&quot;Eagerly caching bean '&quot; + beanName + &quot;'to allow for resolving potential circular references&quot;);
    }
    //åŠ å…¥ä¸‰çº§ç¼“å­˜
    addSingletonFactory(beanName,() -&gt; getEarlyBeanReference(beanName, mbd,
bean));
}
</code></pre></div><p>å¦‚æœåœ¨ä¸€äºŒçº§ç¼“å­˜é‡Œé¢éƒ½æ²¡æ‰¾åˆ°ï¼Œå°±å»ç¬¬ä¸‰çº§ç¼“å­˜æ‰¾ï¼Œæ‰§è¡Œ()-&gt;
getEarlyBeanReference(beanName,mbd,AServiceæ™®é€šå¯¹è±¡)ã€‚
å¦‚æœè¯¥beanéœ€è¦è¿›è¡ŒAOPï¼Œé‚£æ‰§è¡Œçš„ç»“æœæ˜¯è¿›è¡ŒAOPï¼Œåˆ›å»ºä»£ç†å¯¹è±¡ã€‚
å¦‚æœä¸éœ€è¦ï¼Œé‚£æ‰§è¡Œçš„ç»“æœæ˜¯è¿”å›æ™®é€šå¯¹è±¡ã€‚
æœ€åå°†ä»£ç†/æ™®é€šå¯¹è±¡æ”¾å…¥äºŒçº§ç¼“å­˜ã€‚</p> <p>aå¡«å……bçš„å±æ€§æ—¶ï¼Œä¼šè°ƒç”¨getSingletonæ–¹æ³•ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>protected Object getSingleton(String beanName, boolean allowEarlyReference) {
    Object singletonobject = this. singletonobjects.get (beanName);
    if(singletonObject == null &amp;d isSingletonCurrentlyInCreation(beanName)) {//å½“å‰ç´¢è¦çš„å¯¹è±¡ä¸ºç©ºä¸”æ­£åœ¨åˆ›å»ºä¸­ï¼Œå³å‡ºç°äº†å¾ªç¯ä¾èµ–
        singletonObject = this. earlySingletonobjects. get (beanName);
        if (singletonobject == null &amp;&amp; allowEarlyReference) {
            synchronized (this. singletonObjects) {
            // Consistent creation of early reference within full singleton lock
                singletonobject = this. singletonobjects.get (beanName);
                if (singletonobject == null) {
                    singletonobject = this. earlySingletonobjects.get (beanName);
                        if (singletonObject == null) {//äºŒçº§ç¼“å­˜æ²¡æœ‰
                            ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName);
                                if (singletonFactory != null) {//å»ä¸‰çº§ç¼“å­˜æ‰¾
                                    singletonobject = singletonFactory.getobject;
                                    this. earlySingletonobjects. put (beanName, singLetonobject);//åŠ å…¥äºŒçº§ç¼“å­˜ä¸­
                                    this. singletonFactories. remove (beanName);//ä»ä¸‰çº§ç¼“å­˜ä¸­ç§»é™¤ï¼Œå³ç§»é™¤lambdaè¡¨è¾¾å¼
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    return singletonObject;
}
</code></pre></div><blockquote><p>ä¸ºä»€ä¹ˆè¦ä»ä¸‰çº§ç¼“å­˜ä¸­ç§»é™¤ï¼Ÿ</p></blockquote> <blockquote><p>å› ä¸ºå¯¹è±¡æ˜¯å•ä¾‹çš„ï¼Œlambdaè¡¨è¾¾å¼ï¼ˆ()-&gt;
getEarlyBeanReference(beanName,mbd,AServiceæ™®é€šå¯¹è±¡)ï¼‰åªéœ€è¦æ‰§è¡Œä¸€æ¬¡ï¼Œä¿è¯å•ä¾‹ã€‚
åŒç†ï¼Œå½“éœ€è¦å»ä¸‰çº§ç¼“å­˜ä¸­å­˜çš„æ—¶å€™ï¼ŒäºŒçº§ç¼“å­˜ä¸­ä¹Ÿä¼šæ‰§è¡Œç§»é™¤ ä¾‹å¦‚ï¼š</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>protected void addSingletonFactory(String beanName, ObjectFactory&lt;?&gt; singletonFactory) {
    Assert. notNull(singletonFactory, &quot;Singleton factory must not be null&quot;);
    synchronized (this.singletonObjects) {
        if (!this. singletonobjects. containsKey(beanName)) {
            this. singletonFactories put(beanName, singletonFactory);
            this.earlySingleton0bjects.remove(beanName);
            this.registeredSingletons.add (beanName);
        }
    }
}
</code></pre></div><blockquote><p>5ã€6æ­¥ä¹‹é—´è¿˜ä¼šè°ƒç”¨getSingletonæ–¹æ³•ï¼Œä»äºŒçº§ç¼“å­˜ä¸­æ‹¿åˆ°ä»£ç†å¯¹è±¡</p></blockquote> <blockquote><p>æ€»ç»“ï¼š
å¯¹è±¡åˆ›å»ºæ—¶ï¼Œå…ˆå­˜åœ¨ä¸‰çº§ç¼“å­˜ä¸­ï¼Œåœ¨å‡ºç°å¾ªç¯ä¾èµ–çš„æ—¶å€™å»ä¸‰çº§ç¼“å­˜å–ï¼Œç„¶åæ‰§è¡Œå–åˆ°çš„lambdaè¡¨è¾¾å¼å¹¶æ‰§è¡Œï¼Œè¿›è¡ŒAOPå¾—åˆ°ä»£ç†å¯¹è±¡ï¼Œç„¶åå°†ä»£ç†å¯¹è±¡å­˜è¿›äºŒçº§ç¼“å­˜ï¼Œç„¶åæ‰§è¡Œæ¥ä¸‹æ¥çš„åˆ›å»ºæ­¥éª¤ï¼Œåˆ›å»ºå®Œæˆåæ”¾å…¥ä¸€çº§ç¼“å­˜ã€‚</p></blockquote> <h3 id="map-earlyproxyreferences"><a href="#map-earlyproxyreferences" class="header-anchor">#</a> Map:earlyProxyReferences</h3> <blockquote><p>å¦‚æœåœ¨2.2æå‰è¿›è¡ŒAOPï¼Œé‚£åŸæœ¬è¯¥è¿›è¡ŒAOPçš„æ—¶å€™ï¼ˆç¬¬5æ­¥ï¼‰å¦‚ä½•è¿›è¡Œï¼Ÿ</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>@Override
public Object postProcessAfterInitialization (Nullable Object bean, String beanName) {
    if (bean != null) {
        Object cacheKey = getCacheKey (bean. getClass), beanName);
        if (this.earlyProxyReferences.remove(cacheKey) != bean) {
            return wrapIfNecessary(bean, beanName, cacheKey);
        }
    }
    return bean;
ï½
@Override
public Object getEarlyBeanReference(Object bean, String beanName) {
    Object cacheKey = getCacheKey(bean. getClass), beanName);
    this.earlyProxyReferences.put(cacheKey, bean);
    return wrapIfNecessary(bean, beanName, cachekey);
}
</code></pre></div><blockquote><p>é€šè¿‡ä¸€ä¸ªmap â€œearlyProxyReferencesâ€æ¥åŒºåˆ†beanæ˜¯å¦è¿›è¡Œè¿‡AOPã€‚
getEarlyBeanReferenceæ–¹æ³•æ˜¯lambdaè¡¨è¾¾å¼è°ƒç”¨çš„æ–¹æ³•ã€‚å¦‚æœæå‰è¿›è¡ŒAOPï¼Œè¯¥æ–¹æ³•è¢«è°ƒç”¨ï¼Œå¯¹è¯¥beanäº§ç”Ÿä¸€ä¸ªcacheKeyæ”¾å…¥earlyProxyReferencesä¸­ï¼Œå¹¶ä¸”è°ƒç”¨wrapIfNecessaryæ–¹æ³•ã€‚
postProcessAfterInitializationæ˜¯æ­£å¸¸AOPè°ƒç”¨çš„æ–¹æ³•ã€‚ifçš„æ„ä¹‰åœ¨äºåˆ¤æ–­earlyProxyReferencesä¸­æ˜¯å¦æœ‰è¯¥beançš„cacheKeyã€‚å¦‚æœæœ‰ï¼Œå°±ç›´æ¥è¿”å›æ™®é€šå¯¹è±¡ï¼ˆæ­¤å¤„ä¸å¿…ç€æ€¥è¿”å›ä»£ç†å¯¹è±¡ï¼Œå› ä¸º5ã€6æ­¥ä¹‹é—´è¿˜ä¼šè°ƒç”¨getSingletonæ–¹æ³•ï¼Œä»äºŒçº§ç¼“å­˜ä¸­æ‹¿åˆ°ä»£ç†å¯¹è±¡ï¼‰ï¼›å¦‚æœæ²¡æœ‰ï¼Œå³this.earlyProxyReferences.
remove(cacheKey) == nullï¼Œå°±è°ƒç”¨wrapIfNecessaryæ–¹æ³•ã€‚</p></blockquote> <h3 id="lazy"><a href="#lazy" class="header-anchor">#</a> @Lazy</h3> <blockquote><p>é—®é¢˜ï¼šå¦‚æœåœ¨aæ„é€ æ–¹æ³•é‡Œï¼ˆaåˆå§‹åŒ–çš„æ—¶å€™ï¼‰åŠ å…¥this.bService =
bServiceï¼Œåˆ™æ ¹æœ¬åˆ›å»ºä¸å‡ºæ¥açš„æ™®é€šå¯¹è±¡ï¼Œå› æ­¤springè§£å†³ä¸äº†å¾ªç¯ä¾èµ–é—®é¢˜ã€‚</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>@Component
public class AService {
    private BService bService;

    @Lazy
    public AService(BService bService) {
        this.bService = bService;
    }
    public void test() {
        bService.toString();
    }
    ...
</code></pre></div><blockquote><p>è§£å†³æ–¹æ³•ï¼šåŠ ä¸Š@Lazyæ³¨è§£ã€‚åŠ æ³¨è§£åï¼Œåœ¨åˆ›å»ºaçš„beançš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ªbçš„ä»£ç†å¯¹è±¡æ³¨å…¥aï¼Œä¸ä¼šå‡ºç°å¾ªç¯ä¾èµ–é—®é¢˜ã€‚ç­‰åˆ°çœŸæ­£è°ƒç”¨å…³äºbçš„æ–¹æ³•ï¼ˆä¾‹å¦‚testæ–¹æ³•ï¼‰çš„æ—¶å€™ï¼Œbæ‰ä¼šçœŸæ­£è¢«åˆ›å»ºå‡ºæ¥ã€‚
*ä¹Ÿå¯ä»¥è§£å†³@AsyncæŠ¥é”™é—®é¢˜ã€‚</p></blockquote></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#ä¸€äº›æ³¨è§£ç±»" class="sidebar-link reco-side-ä¸€äº›æ³¨è§£ç±»" data-v-b57cc07c>ä¸€äº›æ³¨è§£ç±»</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#å»ºç«‹beandefinition" class="sidebar-link reco-side-å»ºç«‹beandefinition" data-v-b57cc07c>å»ºç«‹BeanDefinition</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#myapplicationcontextç±»" class="sidebar-link reco-side-myapplicationcontextç±»" data-v-b57cc07c>MyApplicationContextç±»</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#awareå›è°ƒ" class="sidebar-link reco-side-awareå›è°ƒ" data-v-b57cc07c>Awareå›è°ƒ</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#springçš„åˆå§‹åŒ–" class="sidebar-link reco-side-springçš„åˆå§‹åŒ–" data-v-b57cc07c>Springçš„åˆå§‹åŒ–</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#beanpostprocessoræœºåˆ¶" class="sidebar-link reco-side-beanpostprocessoræœºåˆ¶" data-v-b57cc07c>BeanPostProcessoræœºåˆ¶</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#aopæœºåˆ¶" class="sidebar-link reco-side-aopæœºåˆ¶" data-v-b57cc07c>AOPæœºåˆ¶</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#beançš„ç”Ÿå‘½å‘¨æœŸ" class="sidebar-link reco-side-beançš„ç”Ÿå‘½å‘¨æœŸ" data-v-b57cc07c>Beançš„ç”Ÿå‘½å‘¨æœŸ</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#beanåˆ›å»ºçš„ç”Ÿå‘½å‘¨æœŸ" class="sidebar-link reco-side-beanåˆ›å»ºçš„ç”Ÿå‘½å‘¨æœŸ" data-v-b57cc07c>beanåˆ›å»ºçš„ç”Ÿå‘½å‘¨æœŸ</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#åˆå§‹åŒ–å‰å’Œåˆå§‹åŒ–æ—¶" class="sidebar-link reco-side-åˆå§‹åŒ–å‰å’Œåˆå§‹åŒ–æ—¶" data-v-b57cc07c>åˆå§‹åŒ–å‰å’Œåˆå§‹åŒ–æ—¶</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#æ¨æ–­æ„é€ æ–¹æ³•" class="sidebar-link reco-side-æ¨æ–­æ„é€ æ–¹æ³•" data-v-b57cc07c>æ¨æ–­æ„é€ æ–¹æ³•</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#ä¾èµ–æ³¨å…¥" class="sidebar-link reco-side-ä¾èµ–æ³¨å…¥" data-v-b57cc07c>ä¾èµ–æ³¨å…¥</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#ä»£ç†å¯¹è±¡" class="sidebar-link reco-side-ä»£ç†å¯¹è±¡" data-v-b57cc07c>ä»£ç†å¯¹è±¡</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#äº‹åŠ¡ç®¡ç†" class="sidebar-link reco-side-äº‹åŠ¡ç®¡ç†" data-v-b57cc07c>äº‹åŠ¡ç®¡ç†</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#å¾ªç¯ä¾èµ–" class="sidebar-link reco-side-å¾ªç¯ä¾èµ–" data-v-b57cc07c>å¾ªç¯ä¾èµ–</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#å¼•å…¥" class="sidebar-link reco-side-å¼•å…¥" data-v-b57cc07c>å¼•å…¥</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#äºŒçº§ç¼“å­˜" class="sidebar-link reco-side-äºŒçº§ç¼“å­˜" data-v-b57cc07c>äºŒçº§ç¼“å­˜</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#ä¸‰çº§ç¼“å­˜" class="sidebar-link reco-side-ä¸‰çº§ç¼“å­˜" data-v-b57cc07c>ä¸‰çº§ç¼“å­˜</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#map-earlyproxyreferences" class="sidebar-link reco-side-map-earlyproxyreferences" data-v-b57cc07c>Map:earlyProxyReferences</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/Spring/My_Spring%2063bc4e38f21f4b229c834e9be6a2fc9b.html#lazy" class="sidebar-link reco-side-lazy" data-v-b57cc07c>@Lazy</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:0;" data-v-248d85d6></canvas></div><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="/Sardinary/assets/js/app.b4352b80.js" defer></script><script src="/Sardinary/assets/js/7.1de0e771.js" defer></script><script src="/Sardinary/assets/js/2.32e86603.js" defer></script><script src="/Sardinary/assets/js/1.87af8fda.js" defer></script><script src="/Sardinary/assets/js/69.a33abe62.js" defer></script>
  </body>
</html>
