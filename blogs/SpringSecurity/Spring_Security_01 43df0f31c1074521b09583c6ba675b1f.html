<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SpringSecurity源码解析-1 | Sardinary&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content=" ">
    
    <link rel="preload" href="/Sardinary/assets/css/0.styles.cca88062.css" as="style"><link rel="preload" href="/Sardinary/assets/js/app.b4352b80.js" as="script"><link rel="preload" href="/Sardinary/assets/js/7.1de0e771.js" as="script"><link rel="preload" href="/Sardinary/assets/js/2.32e86603.js" as="script"><link rel="preload" href="/Sardinary/assets/js/1.87af8fda.js" as="script"><link rel="preload" href="/Sardinary/assets/js/19.73412c71.js" as="script"><link rel="prefetch" href="/Sardinary/assets/js/10.49a810cd.js"><link rel="prefetch" href="/Sardinary/assets/js/11.7175f7e3.js"><link rel="prefetch" href="/Sardinary/assets/js/14.a5477566.js"><link rel="prefetch" href="/Sardinary/assets/js/15.439772b1.js"><link rel="prefetch" href="/Sardinary/assets/js/16.16e886bc.js"><link rel="prefetch" href="/Sardinary/assets/js/17.0e6e36bb.js"><link rel="prefetch" href="/Sardinary/assets/js/18.5e148afa.js"><link rel="prefetch" href="/Sardinary/assets/js/20.e6e484b2.js"><link rel="prefetch" href="/Sardinary/assets/js/21.7c59eb62.js"><link rel="prefetch" href="/Sardinary/assets/js/22.1a4515f8.js"><link rel="prefetch" href="/Sardinary/assets/js/23.77f49651.js"><link rel="prefetch" href="/Sardinary/assets/js/24.2978efd9.js"><link rel="prefetch" href="/Sardinary/assets/js/25.c67021f4.js"><link rel="prefetch" href="/Sardinary/assets/js/26.6879f189.js"><link rel="prefetch" href="/Sardinary/assets/js/27.a2713265.js"><link rel="prefetch" href="/Sardinary/assets/js/28.0e7ec6a5.js"><link rel="prefetch" href="/Sardinary/assets/js/29.b33743d7.js"><link rel="prefetch" href="/Sardinary/assets/js/3.5b666661.js"><link rel="prefetch" href="/Sardinary/assets/js/30.3b66f6c0.js"><link rel="prefetch" href="/Sardinary/assets/js/31.a9a2ab1e.js"><link rel="prefetch" href="/Sardinary/assets/js/32.14ad86fd.js"><link rel="prefetch" href="/Sardinary/assets/js/33.1afd794c.js"><link rel="prefetch" href="/Sardinary/assets/js/34.31730445.js"><link rel="prefetch" href="/Sardinary/assets/js/35.acb79716.js"><link rel="prefetch" href="/Sardinary/assets/js/36.f161e3da.js"><link rel="prefetch" href="/Sardinary/assets/js/37.164bb569.js"><link rel="prefetch" href="/Sardinary/assets/js/38.0e4326d9.js"><link rel="prefetch" href="/Sardinary/assets/js/39.c0cdc477.js"><link rel="prefetch" href="/Sardinary/assets/js/4.95ecc938.js"><link rel="prefetch" href="/Sardinary/assets/js/40.4c8a03a6.js"><link rel="prefetch" href="/Sardinary/assets/js/41.b3e26267.js"><link rel="prefetch" href="/Sardinary/assets/js/42.6526990c.js"><link rel="prefetch" href="/Sardinary/assets/js/43.237a07a2.js"><link rel="prefetch" href="/Sardinary/assets/js/44.20a80a6c.js"><link rel="prefetch" href="/Sardinary/assets/js/45.ee53ec88.js"><link rel="prefetch" href="/Sardinary/assets/js/46.55f62d10.js"><link rel="prefetch" href="/Sardinary/assets/js/47.2a4b0a3b.js"><link rel="prefetch" href="/Sardinary/assets/js/48.d2f40143.js"><link rel="prefetch" href="/Sardinary/assets/js/49.6f809adc.js"><link rel="prefetch" href="/Sardinary/assets/js/5.c87bfc3b.js"><link rel="prefetch" href="/Sardinary/assets/js/50.e8110b40.js"><link rel="prefetch" href="/Sardinary/assets/js/51.e5d33d8f.js"><link rel="prefetch" href="/Sardinary/assets/js/52.35081e55.js"><link rel="prefetch" href="/Sardinary/assets/js/53.f148b50f.js"><link rel="prefetch" href="/Sardinary/assets/js/54.c9fddbbe.js"><link rel="prefetch" href="/Sardinary/assets/js/55.3bf482f3.js"><link rel="prefetch" href="/Sardinary/assets/js/56.284247d8.js"><link rel="prefetch" href="/Sardinary/assets/js/57.cd2fa388.js"><link rel="prefetch" href="/Sardinary/assets/js/58.9717d8f3.js"><link rel="prefetch" href="/Sardinary/assets/js/59.387411ca.js"><link rel="prefetch" href="/Sardinary/assets/js/6.363116dc.js"><link rel="prefetch" href="/Sardinary/assets/js/60.10700fc9.js"><link rel="prefetch" href="/Sardinary/assets/js/61.37f12cd5.js"><link rel="prefetch" href="/Sardinary/assets/js/62.1ee2e76e.js"><link rel="prefetch" href="/Sardinary/assets/js/63.05cc0dee.js"><link rel="prefetch" href="/Sardinary/assets/js/64.2eefe5c7.js"><link rel="prefetch" href="/Sardinary/assets/js/65.57aedaf0.js"><link rel="prefetch" href="/Sardinary/assets/js/66.3362b95c.js"><link rel="prefetch" href="/Sardinary/assets/js/67.31c9d9fd.js"><link rel="prefetch" href="/Sardinary/assets/js/68.966d4fa1.js"><link rel="prefetch" href="/Sardinary/assets/js/69.a33abe62.js"><link rel="prefetch" href="/Sardinary/assets/js/70.11dd9007.js"><link rel="prefetch" href="/Sardinary/assets/js/71.8006b388.js"><link rel="prefetch" href="/Sardinary/assets/js/72.73f1646b.js"><link rel="prefetch" href="/Sardinary/assets/js/73.f53d7f97.js"><link rel="prefetch" href="/Sardinary/assets/js/74.db2bf712.js"><link rel="prefetch" href="/Sardinary/assets/js/8.1ffd42bb.js"><link rel="prefetch" href="/Sardinary/assets/js/9.8e14a092.js"><link rel="prefetch" href="/Sardinary/assets/js/vendors~docsearch.34a230bb.js">
    <link rel="stylesheet" href="/Sardinary/assets/css/0.styles.cca88062.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Sardinary's Blog</h3> <p class="description" data-v-59e6cb88> </p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Sardinary Chen</span>
          
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Sardinary/" class="home-link router-link-active"><img src="/Sardinary/avatar.jpg" alt="Sardinary's Blog" class="logo"> <span class="site-name">Sardinary's Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Sardinary/" class="nav-link"><i class="undefined"></i>
  🏠
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Sardinary/categories/后端/" class="nav-link"><i class="undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/Sardinary/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Sardinary 🎈
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Xiangyinfly" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/Sardinary/avatar.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    Sardinary Chen
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>36</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>12</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/Sardinary/" class="nav-link"><i class="undefined"></i>
  🏠
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Sardinary/categories/后端/" class="nav-link"><i class="undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/Sardinary/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Sardinary 🎈
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Xiangyinfly" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>SpringSecurity源码解析-1</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Sardinary Chen</span>
          
        <!---->
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">SpringSecurity源码解析-1</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>Sardinary Chen</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2/26/2024</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>SpringSecurity</span><span class="tag-item" data-v-8a445198>源码解析</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="spring-security-01"><a href="#spring-security-01" class="header-anchor">#</a> Spring_Security_01</h1> <h1 id="springsecurity的顶层脉络以及几个核心的类"><a href="#springsecurity的顶层脉络以及几个核心的类" class="header-anchor">#</a> SpringSecurity的顶层脉络以及几个核心的类</h1> <ul><li>SecurityBuilder</li> <li>HttpSecurity</li> <li>WebSecurity</li> <li>SecurityFilterChain</li> <li>FilterChainProxy</li></ul> <h2 id="引入"><a href="#引入" class="header-anchor">#</a> 引入</h2> <p>WebSecurityConfigurerAdapter弃用，通过配置bean来配置HttpSecurity和WebSecurity</p> <div class="language- extra-class"><pre class="language-text"><code>Use a org.springframework.security.web.SecurityFilterChain Bean to configure HttpSecurity or a WebSecurityCustomizer Bean to configure WebSecurity

</code></pre></div><p>HttpSecurity和WebSecurity都实现了SecurityBuilder，用来构建对象</p> <div class="language- extra-class"><pre class="language-text"><code>public interface SecurityBuilder&lt;O&gt; {
	O build() throws Exception;
}

</code></pre></div><h2 id="httpsecurity"><a href="#httpsecurity" class="header-anchor">#</a> HttpSecurity</h2> <p><img src="/Sardinary/assets/img/Untitled.187f63dc.png" alt="Untitled"></p> <div class="language- extra-class"><pre class="language-text"><code>public final class HttpSecurity
	extends AbstractConfiguredSecurityBuilder&lt;DefaultSecurityFilterChain, HttpSecurity&gt;
	implements SecurityBuilder&lt;DefaultSecurityFilterChain&gt;,HttpSecurityBuilder&lt;HttpSecurity&gt;{}

</code></pre></div><blockquote><p><code>implements SecurityBuilder&lt;DefaultSecurityFilterChain&gt;</code>：</p> <p>HttpSecurity的泛型O为DefaultSecurityFilterChain，即为了构建DefaultSecurityFilterChain</p></blockquote> <h3 id="securityfilterchain"><a href="#securityfilterchain" class="header-anchor">#</a> SecurityFilterChain</h3> <div class="language- extra-class"><pre class="language-text"><code>public interface SecurityFilterChain {
	//如果返回true，就会对request应用list里的过滤器
    boolean matches(HttpServletRequest request);

    List&lt;Filter&gt; getFilters();

}

</code></pre></div><h3 id="实现类defaultsecurityfilterchain"><a href="#实现类defaultsecurityfilterchain" class="header-anchor">#</a> 实现类DefaultSecurityFilterChain</h3> <p><img src="/Sardinary/assets/img/Untitled1.7ee65abb.png" alt="Untitled"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">DefaultSecurityFilterChain</span> <span class="token keyword">implements</span> <span class="token class-name">SecurityFilterChain</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> logger <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RequestMatcher</span> requestMatcher<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> filters<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> requestMatcher<span class="token punctuation">,</span> <span class="token class-name">Filter</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> filters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">(</span>requestMatcher<span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>filters<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> requestMatcher<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> filters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>filters<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Will not secure %s&quot;</span><span class="token punctuation">,</span> requestMatcher<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">else</span> <span class="token punctuation">{</span>
          logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Will secure %s with %s&quot;</span><span class="token punctuation">,</span> requestMatcher<span class="token punctuation">,</span> filters<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>requestMatcher <span class="token operator">=</span> requestMatcher<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>filters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>filters<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">RequestMatcher</span> <span class="token function">getRequestMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestMatcher<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>filters<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//匹配成功就会应用filters里的过滤器</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; [RequestMatcher=&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestMatcher <span class="token operator">+</span> <span class="token string">&quot;, Filters=&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>filters
             <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h2 id="websecurity"><a href="#websecurity" class="header-anchor">#</a> WebSecurity</h2> <p><img src="/Sardinary/assets/img/Untitled2.d23f9224.png" alt="Untitled"></p> <div class="language- extra-class"><pre class="language-text"><code>public final class WebSecurity
	extends AbstractConfiguredSecurityBuilder&lt;Filter, WebSecurity&gt;
	implements SecurityBuilder&lt;Filter&gt;, ApplicationContextAware, ServletContextAware {}

</code></pre></div><p><code>implements SecurityBuilder&lt;Filter&gt;</code>:WebSecurity的泛型O为Filter，即为了构建Filter</p> <h3 id="securitybuilder的build方法-dobuild方法"><a href="#securitybuilder的build方法-dobuild方法" class="header-anchor">#</a> SecurityBuilder的build方法 -&gt; doBuild方法</h3> <div class="language- extra-class"><pre class="language-text"><code>protected final O doBuild() throws Exception {
    synchronized (this.configurers) {
       this.buildState = BuildState.INITIALIZING;
       beforeInit();
       init();
       this.buildState = BuildState.CONFIGURING;
       beforeConfigure();
       configure();
       this.buildState = BuildState.BUILDING;
       O result = performBuild();
       this.buildState = BuildState.BUILT;
       return result;
    }
}

</code></pre></div><p>其中有些方法不是abstract，说明这些方法不重要，子类不需要重写（abstract的方法必须实现）</p> <p>由代码可见通过<strong>performBuild</strong>方法构建了result对象</p> <p>performBuild方法有三个实现类，其中包括熟悉的HttpSecurity和WebSecurity</p> <blockquote><p>在HttpSecurity中，该方法 return new DefaultSecurityFilterChain(this.requestMatcher, sortedFilters);</p></blockquote> <blockquote><p>在WebSecurity中，该方法返回了一个 FilterChainProxy</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Filter</span> <span class="token function">performBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityFilterChainBuilders<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;At least one SecurityBuilder&lt;? extends SecurityFilterChain&gt; needs to be specified. &quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;Typically this is done by exposing a SecurityFilterChain bean. &quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;More advanced users can invoke &quot;</span> <span class="token operator">+</span> <span class="token class-name">WebSecurity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token string">&quot;.addSecurityFilterChainBuilder directly&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> chainSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ignoredRequests<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityFilterChainBuilders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityFilterChain</span><span class="token punctuation">&gt;</span></span> securityFilterChains <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>chainSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcherEntry</span><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">WebInvocationPrivilegeEvaluator</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> requestMatcherPrivilegeEvaluatorsEntries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> ignoredRequest <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ignoredRequests<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">WebSecurity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;You are asking Spring Security to ignore &quot;</span> <span class="token operator">+</span> ignoredRequest
             <span class="token operator">+</span> <span class="token string">&quot;. This is not recommended -- please use permitAll via HttpSecurity#authorizeHttpRequests instead.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">SecurityFilterChain</span> securityFilterChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">(</span>ignoredRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
       securityFilterChains<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>securityFilterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
       requestMatcherPrivilegeEvaluatorsEntries
          <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getRequestMatcherPrivilegeEvaluatorsEntry</span><span class="token punctuation">(</span>securityFilterChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityFilterChain</span><span class="token punctuation">&gt;</span></span> securityFilterChainBuilder <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityFilterChainBuilders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">SecurityFilterChain</span> securityFilterChain <span class="token operator">=</span> securityFilterChainBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       securityFilterChains<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>securityFilterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
       requestMatcherPrivilegeEvaluatorsEntries
          <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getRequestMatcherPrivilegeEvaluatorsEntry</span><span class="token punctuation">(</span>securityFilterChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>privilegeEvaluator <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>privilegeEvaluator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestMatcherDelegatingWebInvocationPrivilegeEvaluator</span><span class="token punctuation">(</span>
             requestMatcherPrivilegeEvaluatorsEntries<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">FilterChainProxy</span> filterChainProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterChainProxy</span><span class="token punctuation">(</span>securityFilterChains<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>httpFirewall <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       filterChainProxy<span class="token punctuation">.</span><span class="token function">setFirewall</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>httpFirewall<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestRejectedHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       filterChainProxy<span class="token punctuation">.</span><span class="token function">setRequestRejectedHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestRejectedHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>observationRegistry<span class="token punctuation">.</span><span class="token function">isNoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">CompositeRequestRejectedHandler</span> requestRejectedHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompositeRequestRejectedHandler</span><span class="token punctuation">(</span>
             <span class="token keyword">new</span> <span class="token class-name">ObservationMarkingRequestRejectedHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>observationRegistry<span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token keyword">new</span> <span class="token class-name">HttpStatusRequestRejectedHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       filterChainProxy<span class="token punctuation">.</span><span class="token function">setRequestRejectedHandler</span><span class="token punctuation">(</span>requestRejectedHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    filterChainProxy<span class="token punctuation">.</span><span class="token function">setFilterChainDecorator</span><span class="token punctuation">(</span><span class="token function">getFilterChainDecorator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    filterChainProxy<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Filter</span> result <span class="token operator">=</span> filterChainProxy<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>debugEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;\n\n&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;********************************************************************\n&quot;</span>
             <span class="token operator">+</span> <span class="token string">&quot;**********        Security debugging is enabled.       *************\n&quot;</span>
             <span class="token operator">+</span> <span class="token string">&quot;**********    This may include sensitive information.  *************\n&quot;</span>
             <span class="token operator">+</span> <span class="token string">&quot;**********      Do not use in a production system!     *************\n&quot;</span>
             <span class="token operator">+</span> <span class="token string">&quot;********************************************************************\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DebugFilter</span><span class="token punctuation">(</span>filterChainProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>postBuildAction<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>WebSecurity的build方法由<a href="https://sardinary.vercel.app/spring/spring-security-02/#web-security-configuration" target="_blank" rel="noopener noreferrer">WebSecurityConfiguration<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>调用</p> <h3 id="filterchainproxy"><a href="#filterchainproxy" class="header-anchor">#</a> FilterChainProxy</h3> <p><img src="/Sardinary/assets/img/Untitled3.e5f486af.png" alt="Untitled"></p> <p>其构造方法传入了<a href="https://sardinary.vercel.app/spring/spring-security-01/#security-filter-chain" target="_blank" rel="noopener noreferrer">SecurityFilterChain<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的集合</p> <div class="language- extra-class"><pre class="language-text"><code>public FilterChainProxy(List&lt;SecurityFilterChain&gt; filterChains) {
    this.filterChains = filterChains;
}

</code></pre></div><p>其中doFilter方法 -&gt; doFilterInternal方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
       <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> clearContext <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clearContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">doFilterInternal</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
       request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">doFilterInternal</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Throwable</span><span class="token punctuation">[</span><span class="token punctuation">]</span> causeChain <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>throwableAnalyzer<span class="token punctuation">.</span><span class="token function">determineCauseChain</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Throwable</span> requestRejectedException <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>throwableAnalyzer
          <span class="token punctuation">.</span><span class="token function">getFirstThrowableOfType</span><span class="token punctuation">(</span><span class="token class-name">RequestRejectedException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> causeChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>requestRejectedException <span class="token keyword">instanceof</span> <span class="token class-name">RequestRejectedException</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>requestRejectedHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">,</span>
             <span class="token punctuation">(</span><span class="token class-name">RequestRejectedException</span><span class="token punctuation">)</span> requestRejectedException<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       request<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>  <span class="token comment">//FilterChain：最顶层的filter，例如tomcat中的</span>
    <span class="token class-name">FirewalledRequest</span> firewallRequest <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>firewall<span class="token punctuation">.</span><span class="token function">getFirewalledRequest</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HttpServletResponse</span> firewallResponse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>firewall<span class="token punctuation">.</span><span class="token function">getFirewalledResponse</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//得到filters</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> filters <span class="token operator">=</span> <span class="token number">1</span>️⃣<span class="token function">getFilters</span><span class="token punctuation">(</span>firewallRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filters <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> filters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;No security for &quot;</span> <span class="token operator">+</span> <span class="token function">requestLine</span><span class="token punctuation">(</span>firewallRequest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       firewallRequest<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">this</span><span class="token number">.2</span>️⃣filterChainDecorator<span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>chain<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>firewallRequest<span class="token punctuation">,</span> firewallResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Securing &quot;</span> <span class="token operator">+</span> <span class="token function">requestLine</span><span class="token punctuation">(</span>firewallRequest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">FilterChain</span> reset <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Secured &quot;</span> <span class="token operator">+</span> <span class="token function">requestLine</span><span class="token punctuation">(</span>firewallRequest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment">// Deactivate path stripping as we exit the security filter chain</span>
       firewallRequest<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>filterChainDecorator<span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>reset<span class="token punctuation">,</span> filters<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>firewallRequest<span class="token punctuation">,</span> firewallResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//调用doFilter</span>
<span class="token punctuation">}</span>

</code></pre></div><blockquote><p>该方法使<code>filters(List&lt;Filter&gt; filters = getFilters(firewallRequest); )</code>中的过滤器得到应用</p> <p>filters通过filterChainProxy构造方法传入</p></blockquote> <p>1️⃣getFilters(HttpServletRequest request)</p> <div class="language- extra-class"><pre class="language-text"><code>private List&lt;Filter&gt; getFilters(HttpServletRequest request) {
    int count = 0;
    for (SecurityFilterChain chain : this.filterChains) {
       if (logger.isTraceEnabled()) {
          logger.trace(LogMessage.format(&quot;Trying to match request against %s (%d/%d)&quot;, chain, ++count,
                this.filterChains.size()));
       }

		//🌟只会执行filterChains中第一个匹配的SecurityFilterChain
       if (chain.matches(request)) {
          return chain.getFilters();  //得到SecurityFilterChain中所有的过滤器
       }
    }
    return null;
}

</code></pre></div><p>2️⃣关于spring6.1中的VirtualFilterChain：</p> <div class="language- extra-class"><pre class="language-text"><code>private FilterChainProxy.FilterChainDecorator filterChainDecorator
    = new FilterChainProxy.VirtualFilterChainDecorator()

</code></pre></div><h2 id="springsecurity流程"><a href="#springsecurity流程" class="header-anchor">#</a> SpringSecurity流程</h2> <blockquote><p>一个FilterChainProxy，其中有一堆SecurityFilterChain，每个传过来的请求都要经过requestMatcher来匹配，如果匹配就应用SecurityFilterChain其中的一堆过滤器。</p> <p>程序一般只有一个SecurityFilterChain。</p> <p>FilterChainProxy调用doFilter方法，再调用doFilterInternal方法，通过getFilters(HttpServletRequest request)方法通过传入的request得到第一个匹配的SecurityFilterChain，通过getFilters()方法得到SecurityFilterChain中所有的过滤器，构建为一个VirtualFilterChain，最后调用每个过滤器的doFilter方法。</p></blockquote> <h2 id="httpsecurity和websecurity的配置"><a href="#httpsecurity和websecurity的配置" class="header-anchor">#</a> HttpSecurity和WebSecurity的配置</h2> <div class="language- extra-class"><pre class="language-text"><code>public class SecurityConfig {
    @Bean
    public DefaultSecurityFilterChain securityFilterChain(HttpSecurity http) {
	    ......
        return http.build();
    }

    @Bean
    public WebSecurityCustomizer webSecurityCustomizer() {
        return web -&gt; {
            ......
        }
    }
}

</code></pre></div><hr> <h1 id="三个核心类"><a href="#三个核心类" class="header-anchor">#</a> 三个核心类</h1> <ul><li>HttpSecurity</li> <li>SecurityConfigurer</li> <li>AbstractConfiguredSecurityBuilder(间接实现了SecurityBuilder)</li></ul> <blockquote><p>SecurityBuilder用来构建安全对象，安全对象包括：HttpSecurity、FilterChainProxy、AuthenticationManager SecurityConfigurer用来配置安全对象构建器（SecurityBuilder），典型的有：FormLoginConfigurer、CsrfConfigurer</p></blockquote> <h2 id="securityconfigurer"><a href="#securityconfigurer" class="header-anchor">#</a> SecurityConfigurer</h2> <blockquote><p>安全构建器SecurityBuilder的配置器</p></blockquote> <blockquote><p>SecurityBuilder用来构建一个对象，SecurityConfigurer用来配置一个SecurityBuilder</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Allows for configuring a {@link SecurityBuilder}. All {@link SecurityConfigurer} first
 * have their {@link #init(SecurityBuilder)} method invoked. After all
 * {@link #init(SecurityBuilder)} methods have been invoked, each
 * {@link #configure(SecurityBuilder)} method is invoked.
 * //必须先调用init再调用configure
 * * @param &lt;O&gt; The object being built by the {@link SecurityBuilder} B
 * @param &lt;B&gt; The {@link SecurityBuilder} that builds objects of type O. This is also the
 * {@link SecurityBuilder} that is being configured.
 * @author Rob Winch * @see AbstractConfiguredSecurityBuilder
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SecurityConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityBuilder</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Initialize the {@link SecurityBuilder}. Here only shared state should be created
     * and modified, but not properties on the {@link SecurityBuilder} used for building
     * the object. This ensures that the {@link #configure(SecurityBuilder)} method uses
     * the correct shared objects when building. Configurers should be applied here.     * @param builder
     * @throws Exception
     */</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">B</span> builder<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Configure the {@link SecurityBuilder} by setting the necessary properties on the
     * {@link SecurityBuilder}.
     * @param builder
     * @throws Exception
     */</span>
    <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">B</span> builder<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre></div><h2 id="abstractconfiguredsecuritybuilder"><a href="#abstractconfiguredsecuritybuilder" class="header-anchor">#</a> AbstractConfiguredSecurityBuilder</h2> <p><img src="/Sardinary/assets/img/Untitled4.02192c85.png" alt="Untitled"></p> <blockquote><p>类图中AbstractSecurityBuilder的作用：控制build只能构建一次</p></blockquote> <p><strong>AbstractConfiguredSecurityBuilder被SecurityConfigurer所配置</strong></p> <p>AbstractConfiguredSecurityBuilder类：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractConfiguredSecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityBuilder</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token keyword">extends</span> <span class="token class-name">AbstractSecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> logger <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//被一堆的SecurityConfigurer所配置</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configurers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configurersAddedInInitializing <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> sharedObjects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> allowConfigurersOfSameType<span class="token punctuation">;</span>
	<span class="token comment">//构建状态</span>
    <span class="token keyword">private</span> <span class="token class-name">BuildState</span> buildState <span class="token operator">=</span> <span class="token class-name">BuildState</span><span class="token punctuation">.</span><span class="token constant">UNBUILT</span><span class="token punctuation">;</span>
	<span class="token comment">//对象后置处理</span>
	<span class="token comment">//可以实现里面的postProcesser方法自定义处理</span>
    <span class="token keyword">private</span> <span class="token class-name">ObjectPostProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> objectPostProcessor<span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">setSharedObject</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> sharedType<span class="token punctuation">,</span> <span class="token class-name">C</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token keyword">this</span><span class="token punctuation">.</span>sharedObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>sharedType<span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">C</span> <span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> sharedType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">C</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sharedObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sharedType<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">//🌟add方法</span>
	<span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">C</span> configurer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>configurer<span class="token punctuation">,</span> <span class="token string">&quot;configurer cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> configurer
	       <span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token number">.1</span>️⃣buildState<span class="token punctuation">.</span><span class="token function">isConfigured</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//判断是否已经configured，已经构建的不能应用配置器</span>
	          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot apply &quot;</span> <span class="token operator">+</span> configurer <span class="token operator">+</span> <span class="token string">&quot; to already built object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token punctuation">}</span>
	       <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowConfigurersOfSameType<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//是否允许同一个类型的configurer</span>
	          configs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configurers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token punctuation">}</span>
	       <span class="token comment">//如果不允许，则configs一定为null</span>
	       configs <span class="token operator">=</span> <span class="token punctuation">(</span>configs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> configs <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//如果==null，先初始化</span>
	       configs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>configurer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token keyword">this</span><span class="token punctuation">.</span>configurers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> configs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token number">3</span>️⃣🌟<span class="token comment">//初始化过程中加入的configure加入configurersAddedInInitializing</span>
	       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>buildState<span class="token punctuation">.</span><span class="token function">isInitializing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	          <span class="token keyword">this</span><span class="token punctuation">.</span>configurersAddedInInitializing<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>configurer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token punctuation">}</span>
	    <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">O</span> <span class="token function">doBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	       <span class="token keyword">this</span><span class="token punctuation">.</span>buildState <span class="token operator">=</span> <span class="token class-name">BuildState</span><span class="token punctuation">.</span><span class="token constant">INITIALIZING</span><span class="token punctuation">;</span>  <span class="token comment">//状态变为正在初始化</span>
	       <span class="token function">beforeInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token number">4</span>️⃣<span class="token comment">//初始化</span>
	       <span class="token keyword">this</span><span class="token punctuation">.</span>buildState <span class="token operator">=</span> <span class="token class-name">BuildState</span><span class="token punctuation">.</span><span class="token constant">CONFIGURING</span><span class="token punctuation">;</span> <span class="token comment">//状态改为正在配置</span>
	       <span class="token function">beforeConfigure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">5</span>️⃣
	       <span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">6</span>️⃣
	       <span class="token keyword">this</span><span class="token punctuation">.</span>buildState <span class="token operator">=</span> <span class="token class-name">BuildState</span><span class="token punctuation">.</span><span class="token constant">BUILDING</span><span class="token punctuation">;</span>  <span class="token comment">//状态改为正在构建</span>
	       <span class="token comment">//🌟7️⃣performBuild()是一个抽象方法，必须子类实现，真正实现构建的方法</span>
	       <span class="token class-name">O</span> result <span class="token operator">=</span> <span class="token function">performBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token keyword">this</span><span class="token punctuation">.</span>buildState <span class="token operator">=</span> <span class="token class-name">BuildState</span><span class="token punctuation">.</span><span class="token constant">BUILT</span><span class="token punctuation">;</span>
	       <span class="token keyword">return</span> result<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token number">4</span>️⃣
	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configurers <span class="token operator">=</span> <span class="token number">2</span>️⃣<span class="token function">getConfigurers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token comment">//所有的配置器每个初始化</span>
	    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span></span> configurer <span class="token operator">:</span> configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	       configurer<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span></span> configurer <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configurersAddedInInitializing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	       configurer<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token number">2</span>️⃣
	<span class="token keyword">private</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getConfigurers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configs <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configurers<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	       result<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>configs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token number">6</span>️⃣<span class="token comment">//congigure方法</span>
	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configurers <span class="token operator">=</span> <span class="token function">getConfigurers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span></span> configurer <span class="token operator">:</span> configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	       configurer<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getConfigurers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configs <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configurers<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	       result<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>configs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_4️⃣init"><a href="#_4️⃣init" class="header-anchor">#</a> 4️⃣init()</h3> <h3 id="collection-securityconfigurer-o-b-configurers-2️⃣getconfigurers-作用"><a href="#collection-securityconfigurer-o-b-configurers-2️⃣getconfigurers-作用" class="header-anchor">#</a> Collection&lt;SecurityConfigurer&lt;O, B&gt;&gt; configurers = 2️⃣getConfigurers()作用：</h3> <blockquote><p>此时再对configurers执行put，集合中不会再添加新的元素了，因为getConfigurers方法创建了一个新的集合并返回。</p></blockquote> <h3 id="for-securityconfigurer-o-b-configurer-this-configurersaddedininitializing-作用"><a href="#for-securityconfigurer-o-b-configurer-this-configurersaddedininitializing-作用" class="header-anchor">#</a> for (SecurityConfigurer&lt;O, B&gt; configurer : this.configurersAddedInInitializing)作用：</h3> <blockquote><p>执行第一个for的时候，configurers中的元素执行init方法时候可能会执行add一个configure，而这个时候add的configure不能加入configures集合了，只能加入最初的configures map。</p> <p>但是这些configure也要执行init方法，因此建立属性private final List&lt;SecurityConfigurer&lt;O, B&gt;&gt; configurersAddedInInitializing = new ArrayList&lt;&gt;();，将这些configure加入configurersAddedInInitializing（3️⃣），遍历执行init方法。</p> <p><strong>这就是为什么要建立configurersAddedInInitializing属性，以及add方法中3️⃣处的作用。</strong></p></blockquote> <blockquote><p>问题：configurersAddedInInitializing中的configure执行init方法的时候再执行add一个configure会发生什么？</p></blockquote> <blockquote><p>验证：在groovy console中写入</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>List&lt;String&gt; list = new ArrayList&lt;&gt;()
list.add (&quot;1&quot;)
list.add (&quot;2&quot;)
for(String item in list) {
	if (item.equals (&quot;1&quot;)) {
	list. add (&quot;3&quot;)
	}
	System.out.println(item)
｝

</code></pre></div><blockquote><p>执行抛出异常java.util.ConcurrentModificationException</p> <p>因为执行add的时候ArrayList的modcount++，不等于expectedModCount，会报错</p></blockquote> <h3 id="_5️⃣beforeconfigure"><a href="#_5️⃣beforeconfigure" class="header-anchor">#</a> 5️⃣beforeConfigure()</h3> <p>在本类中为空方法，在HttpSecurity中有一个实现</p> <div class="language- extra-class"><pre class="language-text"><code>@Override
protected void beforeConfigure() throws Exception {
    if (this.authenticationManager != null) {
       setSharedObject(AuthenticationManager.class, this.authenticationManager);
    }
    else {
       ObservationRegistry registry = getObservationRegistry();
       AuthenticationManager manager = getAuthenticationRegistry().build();
       if (!registry.isNoop() &amp;&amp; manager != null) {
          setSharedObject(AuthenticationManager.class, new ObservationAuthenticationManager(registry, manager));
       }
       else {
          setSharedObject(AuthenticationManager.class, manager);
       }
    }
}

</code></pre></div><h3 id="_1️⃣buildstate"><a href="#_1️⃣buildstate" class="header-anchor">#</a> 1️⃣BuildState</h3> <div class="language- extra-class"><pre class="language-text"><code>private enum BuildState {

    /**
     * This is the state before the {@link Builder#build()} is invoked     */    UNBUILT(0),

    /**
     * The state from when {@link Builder#build()} is first invoked until all the     * {@link SecurityConfigurer#init(SecurityBuilder)} methods have been invoked.
     */    INITIALIZING(1),

    /**
     * The state from after all {@link SecurityConfigurer#init(SecurityBuilder)} have
     * been invoked until after all the     * {@link SecurityConfigurer#configure(SecurityBuilder)} methods have been
     * invoked.     */    CONFIGURING(2),

    /**
     * From the point after all the     * {@link SecurityConfigurer#configure(SecurityBuilder)} have completed to just
     * after {@link AbstractConfiguredSecurityBuilder#performBuild()}.
     */    BUILDING(3),

    /**
     * After the object has been completely built.     */    BUILT(4);

    private final int order;

    BuildState(int order) {
       this.order = order;
    }

    public boolean isInitializing() {
       return INITIALIZING.order == this.order;
    }

    /**
     * Determines if the state is CONFIGURING or later     * @return     */    public boolean isConfigured() {
       return this.order &gt;= CONFIGURING.order;
    }

}

</code></pre></div><h2 id="httpsecurity-2"><a href="#httpsecurity-2" class="header-anchor">#</a> HttpSecurity</h2> <h3 id="_7️⃣httpsecurity对performbuild-方法的实现"><a href="#_7️⃣httpsecurity对performbuild-方法的实现" class="header-anchor">#</a> 7️⃣HttpSecurity对performBuild()方法的实现</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">DefaultSecurityFilterChain</span> <span class="token function">performBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ExpressionUrlAuthorizationConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> expressionConfigurer <span class="token operator">=</span> <span class="token function">getConfigurer</span><span class="token punctuation">(</span>
          <span class="token class-name">ExpressionUrlAuthorizationConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AuthorizeHttpRequestsConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> httpConfigurer <span class="token operator">=</span> <span class="token function">getConfigurer</span><span class="token punctuation">(</span><span class="token class-name">AuthorizeHttpRequestsConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> oneConfigurerPresent <span class="token operator">=</span> expressionConfigurer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">^</span> httpConfigurer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

	 <span class="token comment">//该判断的含义：expressionConfigurer和httpConfigurer只能配置一个</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">(</span>expressionConfigurer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> httpConfigurer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> oneConfigurerPresent<span class="token punctuation">,</span>
          <span class="token string">&quot;authorizeHttpRequests cannot be used in conjunction with authorizeRequests. Please select just one.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>filters<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">OrderComparator</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> sortedFilters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Filter</span> filter <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>filters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       sortedFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">OrderedFilter</span><span class="token punctuation">)</span> filter<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestMatcher<span class="token punctuation">,</span> sortedFilters<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><blockquote><p>该方法最终构建出DefaultSecurityFilterChain（属性为一堆filters和一个requestMatcher）</p></blockquote> <blockquote><p>在HttpSecurity中，默认的requestMatcher为：</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>private RequestMatcher requestMatcher = AnyRequestMatcher.INSTANCE;

</code></pre></div><blockquote><p>其matches方法返回true，匹配所有request</p> <p>在HttpSecurity的requestMatcher方法中，可以自定义requestMatcher</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>public HttpSecurity requestMatcher (RequestMatcher requestMatcher) {
	this.requestMatcher = requestMatcher;
	return this;
｝

</code></pre></div><hr> <h1 id="四个核心类"><a href="#四个核心类" class="header-anchor">#</a> 四个核心类</h1> <ul><li><p>AuthenticationManager</p> <p>一个安全对象</p> <p>用来认证，认证的时候需要一个Authentication</p> <p>认证后返回一个标记为已认证的Authentication对象</p></li> <li><p>AuthenticationManagerBuilder</p> <p>用来构建AuthenticationManager的SecurityBuilder</p> <p>继承自AbstractConfiguredSecurityBuilder</p></li> <li><p>ProviderManager</p> <p>AuthenticationManager的具体实现</p> <p>一个ProviderManager中有很多AuthenticationProvider</p></li> <li><p>AuthenticationProvider</p> <p>认证策略模式的实现类</p></li></ul> <h2 id="authentication"><a href="#authentication" class="header-anchor">#</a> Authentication</h2> <p>只是封装认证信息。没有任何逻辑。</p> <div class="language- extra-class"><pre class="language-text"><code>public interface Authentication extends Principal, Serializable {
	//获取权限/角色
	Collection&lt;? extends GrantedAuthority&gt; getAuthorities();
	//获取凭证（如密码）
	Object getCredentials();
	//获取详细信息
	Object getDetails();
	//获取主体（如用户名）
	Object getPrincipal();
	boolean isAuthenticated();
	void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException;
}

</code></pre></div><p>有一个重要的实现类UsernamePasswordAuthenticationToken</p> <h2 id="authenticationmanager"><a href="#authenticationmanager" class="header-anchor">#</a> AuthenticationManager</h2> <div class="language- extra-class"><pre class="language-text"><code>public interface AuthenticationManager {
	Authentication authenticate(Authentication authentication) throws AuthenticationException;
}

</code></pre></div><p>authenticate方法返回一个填充好所有属性的Authentication对象</p> <h2 id="authenticationmanagerbuilder"><a href="#authenticationmanagerbuilder" class="header-anchor">#</a> AuthenticationManagerBuilder</h2> <p>描述：</p> <div class="language- extra-class"><pre class="language-text"><code>SecurityBuilder used to create an AuthenticationManager. Allows for easily building in memory authentication, LDAP authentication, JDBC based authentication, adding UserDetailsService, and adding AuthenticationProvider's.

</code></pre></div><p><img src="/Sardinary/assets/img/Untitled5.a368cc08.png" alt="Untitled"></p> <h3 id="属性"><a href="#属性" class="header-anchor">#</a> 属性</h3> <div class="language- extra-class"><pre class="language-text"><code>public class AuthenticationManagerBuilder
       extends AbstractConfiguredSecurityBuilder&lt;AuthenticationManager, AuthenticationManagerBuilder&gt;
       implements ProviderManagerBuilder&lt;AuthenticationManagerBuilder&gt; {

    private final Log logger = LogFactory.getLog(getClass());

    private AuthenticationManager parentAuthenticationManager;

    private List&lt;AuthenticationProvider&gt; authenticationProviders = new ArrayList&lt;&gt;();

    private UserDetailsService defaultUserDetailsService;

    private Boolean eraseCredentials;

    private AuthenticationEventPublisher eventPublisher;

	......

</code></pre></div><p>继承自AbstractConfiguredSecurityBuilder，而这个抽象类最重要的方法是<strong>performBuild方法</strong></p> <h3 id="performbuild"><a href="#performbuild" class="header-anchor">#</a> performBuild()</h3> <div class="language- extra-class"><pre class="language-text"><code>@Override
protected ProviderManager performBuild() throws Exception {
    if (!isConfigured()) {  //如果没有配置就想构建，返回null
       this.logger.debug(&quot;No authenticationProviders and no parentAuthenticationManager defined. Returning null.&quot;);
       return null;
    }
    ProviderManager providerManager = new ProviderManager(this.authenticationProviders, this.parentAuthenticationManager);
    if (this.eraseCredentials != null) { //清除凭证
       providerManager.setEraseCredentialsAfterAuthentication(this.eraseCredentials);
    }
    if (this.eventPublisher != null) {  //设置时间发布器
       providerManager.setAuthenticationEventPublisher(this.eventPublisher);
    }
    providerManager = postProcess(providerManager);  //后处理
    return providerManager;
}

</code></pre></div><blockquote><p>ProviderManager providerManager = new ProviderManager(this.authenticationProviders, this.parentAuthenticationManager)：</p> <p>设置authenticationProviders，即一堆的<a href="https://sardinary.vercel.app/spring/spring-security-01/#authentication-provider" target="_blank" rel="noopener noreferrer">AuthenticationProvider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；和parentAuthenticationManager，即父类的<a href="https://sardinary.vercel.app/spring/spring-security-01/#authentication-manager" target="_blank" rel="noopener noreferrer">AuthenticationManager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <blockquote><p>返回值为ProviderManager</p></blockquote> <h3 id="postprocess-providermanager"><a href="#postprocess-providermanager" class="header-anchor">#</a> postProcess(providerManager)</h3> <p>后处理。可以实现ObjectPostProcesser接口，实现postProcesser方法实现自定义配置</p> <div class="language- extra-class"><pre class="language-text"><code>public interface ObjectPostProcessor&lt;T&gt; {
	&lt;O extends T&gt; O postProcess (O object);
｝

</code></pre></div><h3 id="属性设置"><a href="#属性设置" class="header-anchor">#</a> 属性设置</h3> <h3 id="authenticationprovider在这个构造方法被设置"><a href="#authenticationprovider在这个构造方法被设置" class="header-anchor">#</a> AuthenticationProvider在这个构造方法被设置</h3> <div class="language- extra-class"><pre class="language-text"><code>@Override
public AuthenticationManagerBuilder authenticationProvider(AuthenticationProvider authenticationProvider) {
    this.authenticationProviders.add(authenticationProvider);
    return this;
}

</code></pre></div><h3 id="parentauthenticationmanager在这个构造方法被设置"><a href="#parentauthenticationmanager在这个构造方法被设置" class="header-anchor">#</a> parentAuthenticationManager在这个构造方法被设置</h3> <div class="language- extra-class"><pre class="language-text"><code>public AuthenticationManagerBuilder parentAuthenticationManager(AuthenticationManager authenticationManager) {
    if (authenticationManager instanceof ProviderManager) {
       eraseCredentials(((ProviderManager) authenticationManager).isEraseCredentialsAfterAuthentication());
    }
    this.parentAuthenticationManager = authenticationManager;
    return this;
}

</code></pre></div><h2 id="authenticationprovider"><a href="#authenticationprovider" class="header-anchor">#</a> AuthenticationProvider</h2> <div class="language- extra-class"><pre class="language-text"><code>public interface AuthenticationProvider {
	Authentication authenticate(Authentication authentication) throws AuthenticationException;
	//是否支持认证，返回true就调用authenticate方法

    boolean supports(Class&lt;?&gt; authentication);
}

</code></pre></div><h3 id="authenticate-authentication-authentication"><a href="#authenticate-authentication-authentication" class="header-anchor">#</a> authenticate(Authentication authentication)</h3> <p>和<a href="https://sardinary.vercel.app/spring/spring-security-01/#authentication-manager" target="_blank" rel="noopener noreferrer">AuthenticationManager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的authenticate方法相同</p> <h3 id="策略模式"><a href="#策略模式" class="header-anchor">#</a> 策略模式</h3> <p>一个问题多种解法。特点有解耦，职责单一，开闭原则</p> <h2 id="providermanager"><a href="#providermanager" class="header-anchor">#</a> ProviderManager</h2> <p><img src="/Sardinary/assets/img/Untitled6.0a6834f4.png" alt="Untitled"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProviderManager</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationManager</span><span class="token punctuation">,</span> <span class="token class-name">MessageSourceAware</span><span class="token punctuation">,</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> logger <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">ProviderManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">AuthenticationEventPublisher</span> eventPublisher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NullEventPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthenticationProvider</span><span class="token punctuation">&gt;</span></span> providers <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token number">1</span>️⃣

    <span class="token keyword">protected</span> <span class="token class-name">MessageSourceAccessor</span> messages <span class="token operator">=</span> <span class="token class-name">SpringSecurityMessageSource</span><span class="token punctuation">.</span><span class="token function">getAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> parent<span class="token punctuation">;</span>  <span class="token number">1</span>️⃣

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> eraseCredentialsAfterAuthentication <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
	    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Authentication</span><span class="token punctuation">&gt;</span></span> toTest <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//测试authentication是否支持</span>
	    <span class="token class-name">AuthenticationException</span> lastException <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	    <span class="token class-name">AuthenticationException</span> parentException <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	    <span class="token class-name">Authentication</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	    <span class="token class-name">Authentication</span> parentResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	    <span class="token keyword">int</span> currentPosition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	    <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>providers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token comment">//逐个provider去调用toTest方法</span>
	    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationProvider</span> provider <span class="token operator">:</span> <span class="token function">getProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>provider<span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span>toTest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	          <span class="token keyword">continue</span><span class="token punctuation">;</span>
	       <span class="token punctuation">}</span>
	       <span class="token comment">//如果支持，继续认证</span>
	       <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	          logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Authenticating request with %s (%d/%d)&quot;</span><span class="token punctuation">,</span>
	                provider<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">++</span>currentPosition<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token punctuation">}</span>
	       <span class="token keyword">try</span> <span class="token punctuation">{</span>
	          result <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
	          <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	             <span class="token function">copyDetails</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//将authentication通过copyDetails赋值给result</span>
	             <span class="token keyword">break</span><span class="token punctuation">;</span>
	          <span class="token punctuation">}</span>
	       <span class="token punctuation">}</span>
	       <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AccountStatusException</span> <span class="token operator">|</span> <span class="token class-name">InternalAuthenticationServiceException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	          <span class="token function">prepareException</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
	          <span class="token comment">// SEC-546: Avoid polling additional providers if auth failure is due to</span>
	          <span class="token comment">// invalid account status          throw ex;</span>
	       <span class="token punctuation">}</span>
	       <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	          lastException <span class="token operator">=</span> ex<span class="token punctuation">;</span>
	       <span class="token punctuation">}</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">//for循环中的provider都不支持，result == null</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	       <span class="token comment">// Allow the parent to try.</span>
	       <span class="token keyword">try</span> <span class="token punctuation">{</span>
	          parentResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//2️⃣调用parent的authenticate，测试parent的provider是否支持</span>
	          result <span class="token operator">=</span> parentResult<span class="token punctuation">;</span>
	       <span class="token punctuation">}</span>
	       <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ProviderNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	          <span class="token comment">// ignore as we will throw below if no other exception occurred prior to</span>
	          <span class="token comment">// calling parent and the parent          // may throw ProviderNotFound even though a provider in the child already          // handled the request       }</span>
	       <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	          parentException <span class="token operator">=</span> ex<span class="token punctuation">;</span>
	          lastException <span class="token operator">=</span> ex<span class="token punctuation">;</span>
	       <span class="token punctuation">}</span>
	    <span class="token punctuation">}</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eraseCredentialsAfterAuthentication <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>result <span class="token keyword">instanceof</span> <span class="token class-name">CredentialsContainer</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//是否擦除凭证信息。登录成功在内存擦出凭证信息，保护隐私</span>
	          <span class="token comment">// Authentication is complete. Remove credentials and other secret data</span>
	          <span class="token comment">// from authentication          ((CredentialsContainer) result).eraseCredentials();</span>
	       <span class="token punctuation">}</span>
	       <span class="token comment">// If the parent AuthenticationManager was attempted and successful then it</span>
	       <span class="token comment">// will publish an AuthenticationSuccessEvent</span>
	       <span class="token comment">// This check prevents a duplicate AuthenticationSuccessEvent if the parent</span>
	       <span class="token comment">// AuthenticationManager already published it</span>
	       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">3</span>️⃣parentResult <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	          <span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher<span class="token punctuation">.</span><span class="token function">publishAuthenticationSuccess</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token punctuation">}</span>

	       <span class="token keyword">return</span> result<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>

	    <span class="token comment">// Parent was null, or didn't authenticate (or throw an exception).</span>
	    <span class="token comment">//没有一个provicer可以支持认证</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastException <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	       lastException <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProviderNotFoundException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;ProviderManager.providerNotFound&quot;</span><span class="token punctuation">,</span>
	             <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> toTest<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;No AuthenticationProvider found for {0}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token comment">// If the parent AuthenticationManager was attempted and failed then it will</span>
	    <span class="token comment">// publish an AbstractAuthenticationFailureEvent    // This check prevents a duplicate AbstractAuthenticationFailureEvent if the    // parent AuthenticationManager already published it    if (parentException == null) {</span>
	       <span class="token function">prepareException</span><span class="token punctuation">(</span>lastException<span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    <span class="token keyword">throw</span> lastException<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

</code></pre></div><h3 id="authenticate方法"><a href="#authenticate方法" class="header-anchor">#</a> authenticate方法</h3> <blockquote><p>1️⃣先使用providers中的AuthenticationProvider，如果都不支持，就调用父类的AuthenticationProvider。</p> <p>如果再认证不过，就报错</p></blockquote> <blockquote><p>2️⃣parent的provider中，最主要的还是ProviderManager</p> <p><img src="/Sardinary/assets/img/Untitled7.5feb62db.png" alt="Untitled"></p></blockquote> <blockquote><p>3️⃣判断事件是由谁发生的。返回false说明事件由父类完成认证，父类完成的认证父类来发布。同时避免重复发布。</p></blockquote> <h3 id="流程"><a href="#流程" class="header-anchor">#</a> 流程</h3> <p>子类的provider逐个认证，如果认证都不成功，就用父类的provider逐个认证。如果子类和父类中没有一个provider支持认证，就抛出异常。</p> <p>如果认证成功，将authentication通过copyDetails赋值给result</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p><strong>AuthenticationManagerBuilder构建AuthenticationManager，实际上就是构建ProviderManager（是AuthenticationManager的一个具体实现）AuthenticationProvider是真正认证请求的ProviderManager维护了一堆的AuthenticationProvider，认证的时候调用AuthenticationProvider的authenticate方法</strong></p> <hr> <h1 id="五个核心类"><a href="#五个核心类" class="header-anchor">#</a> 五个核心类</h1> <ul><li><p>UserDetailsService</p></li> <li><p>DaoAuthenticationProvider</p> <p>数据库相关认证</p></li> <li><p>AbstractUserDetailsAuthenticationProvider</p> <p>DaoAuthenticationProvider的一个父类</p></li> <li><p>UsernamePasswordAuthenticationFilter</p></li> <li><p>FormLoginConfigurer</p> <p>是一个<a href="https://sardinary.vercel.app/spring/spring-security-01/#security-configurer" target="_blank" rel="noopener noreferrer">SecurityConfigurer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>用来配置UsernamePasswordAuthenticationFilter</p> <p>配置的是HttpSecurityBuilder（<a href="https://sardinary.vercel.app/spring/spring-security-01/#http-security" target="_blank" rel="noopener noreferrer">HttpSecurity<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的构建器）</p></li></ul> <h2 id="userdetailsservice"><a href="#userdetailsservice" class="header-anchor">#</a> UserDetailsService</h2> <p>通过用户名加载用户信息</p> <div class="language- extra-class"><pre class="language-text"><code>public interface UserDetailsService {
	UserDetails loadUserByUsername(String username) throws UsernameNotFoundException;
}

</code></pre></div><p>实现类：</p> <p><img src="/Sardinary/assets/img/Untitled8.d5d63d17.png" alt="Untitled"></p> <h2 id="daoauthenticationprovider"><a href="#daoauthenticationprovider" class="header-anchor">#</a> DaoAuthenticationProvider</h2> <p><img src="/Sardinary/assets/img/Untitled9.f0c8b167.png" alt="Untitled"></p> <p>AuthenticationProvider的实现类，通过UserDetailsService用来获取用户详情</p> <p>父类为<a href="https://sardinary.vercel.app/spring/spring-security-01/#abstract-user-details-authentication-provider" target="_blank" rel="noopener noreferrer">AbstractUserDetailsAuthenticationProvider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="abstractuserdetailsauthenticationprovider"><a href="#abstractuserdetailsauthenticationprovider" class="header-anchor">#</a> AbstractUserDetailsAuthenticationProvider</h2> <p><strong>A base AuthenticationProvider that allows subclasses to override and work with UserDetails objects. The class is designed to respond to UsernamePasswordAuthenticationToken authentication requests.</strong></p> <p>是<a href="https://sardinary.vercel.app/spring/spring-security-01/#authentication-provider" target="_blank" rel="noopener noreferrer">AuthenticationProvider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的实现类</p> <h3 id="🌟authenticate方法"><a href="#🌟authenticate方法" class="header-anchor">#</a> 🌟authenticate方法</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isInstanceOf</span><span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> authentication<span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;AbstractUserDetailsAuthenticationProvider.onlySupports&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Only UsernamePasswordAuthenticationToken is supported&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//拿到username</span>
    <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token number">1</span>️⃣<span class="token function">determineUsername</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//是否使用缓存</span>
    <span class="token keyword">boolean</span> cacheWasUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">//2️⃣获取缓存</span>
    <span class="token class-name">UserDetails</span> user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userCache<span class="token punctuation">.</span><span class="token function">getUserFromCache</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token comment">//缓存里没有user</span>
	    <span class="token comment">//事实上user永远等于null</span>
       cacheWasUsed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
       <span class="token keyword">try</span> <span class="token punctuation">{</span>
		    <span class="token comment">//拿到用户的user对象</span>
		    user <span class="token operator">=</span> <span class="token number">6</span>️⃣<span class="token function">retrieveUser</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UsernameNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to find user '&quot;</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//3️⃣是否隐藏UserNotFoundExceptions</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>hideUserNotFoundExceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages
             <span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bad credentials&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token string">&quot;retrieveUser returned null - a violation of the interface contract&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
	    <span class="token comment">//校验</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>preAuthenticationChecks<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">additionalAuthenticationChecks</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//4️⃣</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cacheWasUsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment">// There was a problem, so try again after checking</span>
       <span class="token comment">// we're using latest data (i.e. not from the cache)       cacheWasUsed = false;</span>
       user <span class="token operator">=</span> <span class="token function">retrieveUser</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>preAuthenticationChecks<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">additionalAuthenticationChecks</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//检验</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>postAuthenticationChecks<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cacheWasUsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//如果没用缓存，就加入缓存</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>userCache<span class="token punctuation">.</span><span class="token function">putUserInCache</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Object</span> principalToReturn <span class="token operator">=</span> user<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>forcePrincipalAsString<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//如果强制principal为String</span>
       principalToReturn <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">5</span>️⃣<span class="token function">createSuccessAuthentication</span><span class="token punctuation">(</span>principalToReturn<span class="token punctuation">,</span> authentication<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_1️⃣determineusername"><a href="#_1️⃣determineusername" class="header-anchor">#</a> 1️⃣determineUsername</h3> <div class="language- extra-class"><pre class="language-text"><code>private String determineUsername(Authentication authentication) {
    return (authentication.getPrincipal() == null) ? &quot;NONE_PROVIDED&quot; : authentication.getName();
}

</code></pre></div><h3 id="_2️⃣user永远等于null"><a href="#_2️⃣user永远等于null" class="header-anchor">#</a> 2️⃣user永远等于null</h3> <blockquote><p>this.userCache的赋值为：</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>private UserCache userCache = new NullUserCache();

</code></pre></div><p>而NullUserCache实现了UserCache接口。</p> <p>UserCache是为了在远程连接的时候避免频繁调用数据库，于是可以将用户信息存储在UserCache中。</p> <p>但是一般我们都保存在session中，所以SpringSecurity默认给this.userCache赋值为NullUserCache，不使用UserCache</p> <p>所以2️⃣位置user永远等于null</p> <p>也可以实现自己的UserCache，该类中提供了方法setUserCache</p> <div class="language- extra-class"><pre class="language-text"><code>public void setUserCache(UserCache userCache) {
    this.userCache = userCache;
}

</code></pre></div><h3 id="_3️⃣关于隐藏usernotfoundexceptions"><a href="#_3️⃣关于隐藏usernotfoundexceptions" class="header-anchor">#</a> 3️⃣关于隐藏UserNotFoundExceptions</h3> <p>3️⃣处判断是否隐藏UserNotFoundExceptions。隐藏用户名的正确性，是一种安全保护机制</p> <h3 id="_4️⃣如果捕获到了authenticationexception"><a href="#_4️⃣如果捕获到了authenticationexception" class="header-anchor">#</a> 4️⃣如果捕获到了AuthenticationException</h3> <blockquote><p>如果不是从缓存获取，则抛异常。</p></blockquote> <blockquote><p>如果是从缓存获取，有一种可能是缓存中用登录凭证信息更新不及时（与数据库信息不同）导致异常，所以再此调用retrieveUser方法获取user并进行校验</p></blockquote> <h3 id="关于校验"><a href="#关于校验" class="header-anchor">#</a> 关于校验</h3> <p>该类的属性中：</p> <div class="language- extra-class"><pre class="language-text"><code>private UserDetailsChecker preAuthenticationChecks = new DefaultPreAuthenticationChecks();

private UserDetailsChecker postAuthenticationChecks = new DefaultPostAuthenticationChecks();

</code></pre></div><h3 id="userdetailschecker"><a href="#userdetailschecker" class="header-anchor">#</a> UserDetailsChecker</h3> <div class="language- extra-class"><pre class="language-text"><code>public interface UserDetailsChecker {
	void check(UserDetails toCheck);
}

</code></pre></div><h3 id="defaultpreauthenticationchecks"><a href="#defaultpreauthenticationchecks" class="header-anchor">#</a> DefaultPreAuthenticationChecks</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">DefaultPreAuthenticationChecks</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsChecker</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name">UserDetails</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">.</span><span class="token function">isAccountNonLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">AbstractUserDetailsAuthenticationProvider</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger
             <span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to authenticate since user account is locked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockedException</span><span class="token punctuation">(</span><span class="token class-name">AbstractUserDetailsAuthenticationProvider</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages
             <span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;AbstractUserDetailsAuthenticationProvider.locked&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;User account is locked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">AbstractUserDetailsAuthenticationProvider</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger
             <span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to authenticate since user account is disabled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DisabledException</span><span class="token punctuation">(</span><span class="token class-name">AbstractUserDetailsAuthenticationProvider</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages
             <span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;AbstractUserDetailsAuthenticationProvider.disabled&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;User is disabled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">.</span><span class="token function">isAccountNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">AbstractUserDetailsAuthenticationProvider</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger
             <span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to authenticate since user account has expired&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccountExpiredException</span><span class="token punctuation">(</span><span class="token class-name">AbstractUserDetailsAuthenticationProvider</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages
             <span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;AbstractUserDetailsAuthenticationProvider.expired&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;User account has expired&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h3 id="defaultpostauthenticationchecks"><a href="#defaultpostauthenticationchecks" class="header-anchor">#</a> DefaultPostAuthenticationChecks</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">DefaultPostAuthenticationChecks</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsChecker</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name">UserDetails</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">.</span><span class="token function">isCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//凭证是否过期</span>
          <span class="token class-name">AbstractUserDetailsAuthenticationProvider</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger
             <span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to authenticate since user account credentials have expired&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CredentialsExpiredException</span><span class="token punctuation">(</span><span class="token class-name">AbstractUserDetailsAuthenticationProvider</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages
             <span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;AbstractUserDetailsAuthenticationProvider.credentialsExpired&quot;</span><span class="token punctuation">,</span>
                   <span class="token string">&quot;User credentials have expired&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h3 id="additionalauthenticationchecks"><a href="#additionalauthenticationchecks" class="header-anchor">#</a> additionalAuthenticationChecks</h3> <div class="language- extra-class"><pre class="language-text"><code>protected abstract void additionalAuthenticationChecks(UserDetails userDetails,
       UsernamePasswordAuthenticationToken authentication) throws AuthenticationException;

</code></pre></div><p>做一些凭证相关的校验</p> <p>该方法在<a href="https://sardinary.vercel.app/spring/spring-security-01/#dao-authentication-provider" target="_blank" rel="noopener noreferrer">DaoAuthenticationProvider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>有该方法的唯一实现</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;deprecation&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">additionalAuthenticationChecks</span><span class="token punctuation">(</span><span class="token class-name">UserDetails</span> userDetails<span class="token punctuation">,</span>
       <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//判断是否存在凭证</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to authenticate since no credentials provided&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages
          <span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bad credentials&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//得到用户前端输入的未加密的raw密码</span>
    <span class="token class-name">String</span> presentedPassword <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//进行用户密码校验</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>presentedPassword<span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to authenticate since password does not match stored value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages
          <span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bad credentials&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>其中的PasswordEncoder为密码加密类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PasswordEncoder</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span> rawPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span> rawPassword<span class="token punctuation">,</span> <span class="token class-name">String</span> encodedPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">upgradeEncoding</span><span class="token punctuation">(</span><span class="token class-name">String</span> encodedPassword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_5️⃣createsuccessauthentication"><a href="#_5️⃣createsuccessauthentication" class="header-anchor">#</a> 5️⃣createSuccessAuthentication</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Authentication</span> <span class="token function">createSuccessAuthentication</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span><span class="token class-name">UserDetails</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//得到一个UsernamePasswordAuthenticationToken</span>
	<span class="token class-name">UsernamePasswordAuthenticationToken</span> result <span class="token operator">=</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span>principal<span class="token punctuation">,</span>authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>authoritiesMapper<span class="token punctuation">.</span><span class="token function">mapAuthorities</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	result<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Authenticated user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="authoritiesmapper"><a href="#authoritiesmapper" class="header-anchor">#</a> authoritiesMapper</h3> <p>this.authoritiesMapper默认为空实现(authorities原样返回)</p> <div class="language- extra-class"><pre class="language-text"><code>private GrantedAuthoritiesMapper authoritiesMapper = new NullAuthentiesMapper()；

</code></pre></div><p>也可以自己定制GrantedAuthoritiesMapper</p> <h3 id="daoauthenticationprovider中的createsuccessauthentication"><a href="#daoauthenticationprovider中的createsuccessauthentication" class="header-anchor">#</a> <a href="https://sardinary.vercel.app/spring/spring-security-01/#dao-authentication-provider" target="_blank" rel="noopener noreferrer">DaoAuthenticationProvider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中的createSuccessAuthentication</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Authentication</span> <span class="token function">createSuccessAuthentication</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">UserDetails</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//是否升级加密</span>
    <span class="token keyword">boolean</span> upgradeEncoding <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userDetailsPasswordService <span class="token operator">!=</span> <span class="token keyword">null</span>
          <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">upgradeEncoding</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>upgradeEncoding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> presentedPassword <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">String</span> newPassword <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>presentedPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
       user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userDetailsPasswordService<span class="token punctuation">.</span><span class="token function">updatePassword</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> newPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">createSuccessAuthentication</span><span class="token punctuation">(</span>principal<span class="token punctuation">,</span> authentication<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="userdetailspasswordservice"><a href="#userdetailspasswordservice" class="header-anchor">#</a> userDetailsPasswordService</h3> <p>可以通过实现该接口提供updatePassword方法来自定义更新密码</p> <h3 id="_6️⃣retrieveuser🌟"><a href="#_6️⃣retrieveuser🌟" class="header-anchor">#</a> 6️⃣retrieveUser🌟</h3> <h3 id="在daoauthenticationprovider中唯一实现"><a href="#在daoauthenticationprovider中唯一实现" class="header-anchor">#</a> 在<a href="https://sardinary.vercel.app/spring/spring-security-01/#dao-authentication-provider" target="_blank" rel="noopener noreferrer">DaoAuthenticationProvider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中唯一实现</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">UserDetails</span> <span class="token function">retrieveUser</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
    <span class="token function">prepareTimingAttackProtection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
	    <span class="token comment">//通过loadUserByUsername拿到UserDetails</span>
       <span class="token class-name">UserDetails</span> loadedUser <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUserDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>loadedUser <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalAuthenticationServiceException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;UserDetailsService returned null, which is an interface contract violation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">return</span> loadedUser<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//可以自定义getUserDetailsService()，在loadedUser == null的时候抛出UsernameNotFoundException</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UsernameNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">mitigateAgainstTimingAttack</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InternalAuthenticationServiceException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalAuthenticationServiceException</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="preparetimingattackprotection-和mitigateagainsttimingattack-authentication"><a href="#preparetimingattackprotection-和mitigateagainsttimingattack-authentication" class="header-anchor">#</a> prepareTimingAttackProtection()和mitigateAgainstTimingAttack(authentication)</h3> <p>用于干扰计时攻击，防止通过反应时间长短来判断用户名是否存在</p> <p>计时攻击：密码匹配需要一个明显的耗时，攻击者可以通过耗时长短来得到一些测试信息。</p> <h3 id="流程-2"><a href="#流程-2" class="header-anchor">#</a> 流程</h3> <p>先从缓存中获取，如果获取不到就调用retrieveUser方法获取，然后进行一系列检验，最后包装为createSuccessAuthentication对象返回</p> <h2 id="usernamepasswordauthenticationfilter"><a href="#usernamepasswordauthenticationfilter" class="header-anchor">#</a> UsernamePasswordAuthenticationFilter</h2> <h3 id="父类为abstractauthenticationprocessingfilter"><a href="#父类为abstractauthenticationprocessingfilter" class="header-anchor">#</a> 父类为AbstractAuthenticationProcessingFilter</h3> <p><img src="/Sardinary/assets/img/Untitled10.55140881.png" alt="Untitled"></p> <h3 id="父类的dofilter方法"><a href="#父类的dofilter方法" class="header-anchor">#</a> 父类的doFilter方法</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">requiresAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//是否需要认证</span>
       chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
	    <span class="token comment">//拿到的是已经认证成功的authentication</span>
       <span class="token class-name">Authentication</span> authenticationResult <span class="token operator">=</span> <span class="token number">2</span>️⃣<span class="token function">attemptAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>authenticationResult <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// return immediately as subclass has indicated that it hasn't completed</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>sessionStrategy<span class="token punctuation">.</span><span class="token function">onAuthentication</span><span class="token punctuation">(</span>authenticationResult<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// Authentication success</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>continueChainBeforeSuccessfulAuthentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//继续调用过滤器</span>
       <span class="token punctuation">}</span>
	    <span class="token comment">//1️⃣successfulAuthentication中会调用successHandler，即自定义认证成功的处理逻辑</span>
       <span class="token function">successfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> authenticationResult<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InternalAuthenticationServiceException</span> failed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;An internal error occurred while trying to authenticate the user.&quot;</span><span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//登录失败调用failureHandler</span>
       <span class="token function">unsuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// Authentication failed</span>
       <span class="token function">unsuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_1️⃣successfulauthentication"><a href="#_1️⃣successfulauthentication" class="header-anchor">#</a> 1️⃣successfulAuthentication</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">successfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authResult<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token class-name">SecurityContext</span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextRepository<span class="token punctuation">.</span><span class="token function">saveContext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Set SecurityContextHolder to %s&quot;</span><span class="token punctuation">,</span> authResult<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeServices<span class="token punctuation">.</span><span class="token function">loginSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//发布事件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InteractiveAuthenticationSuccessEvent</span><span class="token punctuation">(</span>authResult<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//调用successHandler，即自定义认证成功的处理逻辑</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>successHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> authResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_2️⃣attemptauthentication"><a href="#_2️⃣attemptauthentication" class="header-anchor">#</a> 2️⃣attemptAuthentication</h3> <blockquote><p>request进来 -&gt; 包装为UsernamePasswordAuthenticationToken -&gt; 传给AuthenticationManager进行认证</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">attemptAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span>
       <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>postOnly <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;Authentication method not supported: &quot;</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token function">obtainUsername</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    username <span class="token operator">=</span> <span class="token punctuation">(</span>username <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> username<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token function">obtainPassword</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    password <span class="token operator">=</span> <span class="token punctuation">(</span>password <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> password <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//拿到username和password之后，封装UsernamePasswordAuthenticationToken</span>
    <span class="token class-name">UsernamePasswordAuthenticationToken</span> authRequest <span class="token operator">=</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">.</span><span class="token function">unauthenticated</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>
          password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Allow subclasses to set the &quot;details&quot; property</span>
    <span class="token comment">//details：存储一些额外的信息</span>
    <span class="token function">setDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> authRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAuthenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="更改usernameparameter和passwordparameter"><a href="#更改usernameparameter和passwordparameter" class="header-anchor">#</a> 更改usernameParameter和passwordParameter</h3> <p>在UsernamePasswordAuthenticationFilter中规定了</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SPRING_SECURITY_FORM_USERNAME_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;username&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SPRING_SECURITY_FORM_PASSWORD_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> usernameParameter <span class="token operator">=</span> <span class="token constant">SPRING_SECURITY_FORM_USERNAME_KEY</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> passwordParameter <span class="token operator">=</span> <span class="token constant">SPRING_SECURITY_FORM_PASSWORD_KEY</span><span class="token punctuation">;</span>

</code></pre></div><p>更改方法：</p> <p>可以在我们写的config类中自定义：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DefaultSecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre></div><p>原因：formLogin()提供了一个<a href="https://sardinary.vercel.app/spring/spring-security-01/#form-login-configurer" target="_blank" rel="noopener noreferrer">FormLoginConfigurer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">FormLoginConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpSecurity</span><span class="token punctuation">&gt;</span></span> <span class="token function">formlogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">getOrApply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FormLoginConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="formloginconfigurer"><a href="#formloginconfigurer" class="header-anchor">#</a> FormLoginConfigurer</h2> <p><img src="/Sardinary/assets/img/Untitled11.1133f72a.png" alt="Untitled"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FormLoginConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">HttpSecurityBuilder</span><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAuthenticationFilterConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">,</span> <span class="token class-name">FormLoginConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token class-name">FormLoginConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//登录页面</span>
     <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">FormLoginConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span></span> <span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token class-name">String</span> loginPage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span>loginPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">FormLoginConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span></span> <span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token class-name">String</span> usernameParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">getAuthenticationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setUsernameParameter</span><span class="token punctuation">(</span>usernameParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">FormLoginConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span></span> <span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token class-name">String</span> passwordParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">getAuthenticationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPasswordParameter</span><span class="token punctuation">(</span>passwordParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//失败重定向</span>
    <span class="token keyword">public</span> <span class="token class-name">FormLoginConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span></span> <span class="token function">failureForwardUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> forwardUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">failureHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ForwardAuthenticationFailureHandler</span><span class="token punctuation">(</span>forwardUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">FormLoginConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span></span> <span class="token function">successForwardUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> forwardUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">successHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ForwardAuthenticationSuccessHandler</span><span class="token punctuation">(</span>forwardUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
       <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">initDefaultLoginFilter</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">RequestMatcher</span> <span class="token function">createLoginProcessingUrlMatcher</span><span class="token punctuation">(</span><span class="token class-name">String</span> loginProcessingUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">(</span>loginProcessingUrl<span class="token punctuation">,</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getUsernameParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token function">getAuthenticationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUsernameParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getPasswordParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token function">getAuthenticationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPasswordParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//在init方法中被调用</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initDefaultLoginFilter</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">DefaultLoginPageGeneratingFilter</span> loginPageGeneratingFilter <span class="token operator">=</span> http
          <span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">DefaultLoginPageGeneratingFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>loginPageGeneratingFilter <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isCustomLoginPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          loginPageGeneratingFilter<span class="token punctuation">.</span><span class="token function">setFormLoginEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          loginPageGeneratingFilter<span class="token punctuation">.</span><span class="token function">setUsernameParameter</span><span class="token punctuation">(</span><span class="token function">getUsernameParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          loginPageGeneratingFilter<span class="token punctuation">.</span><span class="token function">setPasswordParameter</span><span class="token punctuation">(</span><span class="token function">getPasswordParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          loginPageGeneratingFilter<span class="token punctuation">.</span><span class="token function">setLoginPageUrl</span><span class="token punctuation">(</span><span class="token function">getLoginPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          loginPageGeneratingFilter<span class="token punctuation">.</span><span class="token function">setFailureUrl</span><span class="token punctuation">(</span><span class="token function">getFailureUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          loginPageGeneratingFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationUrl</span><span class="token punctuation">(</span><span class="token function">getLoginProcessingUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="父类securityconfigureradapter"><a href="#父类securityconfigureradapter" class="header-anchor">#</a> 父类SecurityConfigurerAdapter</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfigurerAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityBuilder</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">SecurityConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">B</span> securityBuilder<span class="token punctuation">;</span>

	<span class="token comment">//属于configurer的objectPostProcessor，和securityBuilder中的objectPostProcessor不是同一个对象，但是作用相似</span>
    <span class="token keyword">private</span> <span class="token class-name">CompositeObjectPostProcessor</span> objectPostProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompositeObjectPostProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">B</span> builder<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">B</span> builder<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//返回builder，可以达到链式调用的效果</span>
    <span class="token keyword">public</span> <span class="token class-name">B</span> <span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token function">getBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">B</span> <span class="token function">getBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityBuilder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;securityBuilder cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityBuilder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token class-name">T</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>objectPostProcessor<span class="token punctuation">.</span><span class="token function">postProcess</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addObjectPostProcessor</span><span class="token punctuation">(</span><span class="token class-name">ObjectPostProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> objectPostProcessor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>objectPostProcessor<span class="token punctuation">.</span><span class="token function">addObjectPostProcessor</span><span class="token punctuation">(</span>objectPostProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBuilder</span><span class="token punctuation">(</span><span class="token class-name">B</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>securityBuilder <span class="token operator">=</span> builder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">CompositeObjectPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">ObjectPostProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
		<span class="token comment">//可以维护多个postProcessor</span>
       <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ObjectPostProcessor</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> postProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token annotation punctuation">@Override</span>
       <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;rawtypes&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;unchecked&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
       <span class="token comment">//逐个调用</span>
       <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ObjectPostProcessor</span> opp <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postProcessors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> oppClass <span class="token operator">=</span> opp<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> oppType <span class="token operator">=</span> <span class="token class-name">GenericTypeResolver</span><span class="token punctuation">.</span><span class="token function">resolveTypeArgument</span><span class="token punctuation">(</span>oppClass<span class="token punctuation">,</span> <span class="token class-name">ObjectPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span>oppType <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> oppType<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                object <span class="token operator">=</span> opp<span class="token punctuation">.</span><span class="token function">postProcess</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> object<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

		<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">addObjectPostProcessor</span><span class="token punctuation">(</span><span class="token class-name">ObjectPostProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> objectPostProcessor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		    <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>objectPostProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token keyword">this</span><span class="token punctuation">.</span>postProcessors<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">AnnotationAwareOrderComparator</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h3 id="父类abstracthttpconfigurer"><a href="#父类abstracthttpconfigurer" class="header-anchor">#</a> 父类AbstractHttpConfigurer</h3> <h3 id="disable"><a href="#disable" class="header-anchor">#</a> disable</h3> <p>移除Configurer</p> <div class="language- extra-class"><pre class="language-text"><code>public B disable() {
    getBuilder().removeConfigurer(getClass());
    return getBuilder();
}

</code></pre></div><p>removeConfigurer方法在接口HttpSecurityBuilder中声明，在<a href="https://sardinary.vercel.app/spring/spring-security-01/#abstract-configured-security-builder" target="_blank" rel="noopener noreferrer">AbstractConfiguredSecurityBuilder<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中实现</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">C</span> <span class="token function">removeConfigurer</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityConfigurer</span><span class="token punctuation">&lt;</span><span class="token class-name">O</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configurers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>configs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">removeFromConfigurersAddedInInitializing</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>configs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Only one configurer expected for type &quot;</span> <span class="token operator">+</span> clazz <span class="token operator">+</span> <span class="token string">&quot;, but got &quot;</span> <span class="token operator">+</span> configs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">C</span><span class="token punctuation">)</span> configs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="withobjectpostprocessor"><a href="#withobjectpostprocessor" class="header-anchor">#</a> withObjectPostProcessor</h3> <p>添加一个objectPostProcessor</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">withObjectPostProcessor</span><span class="token punctuation">(</span><span class="token class-name">ObjectPostProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> objectPostProcessor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">addObjectPostProcessor</span><span class="token punctuation">(</span>objectPostProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="父类abstractauthenticationfilterconfigurer"><a href="#父类abstractauthenticationfilterconfigurer" class="header-anchor">#</a> 父类AbstractAuthenticationFilterConfigurer</h3> <p>实现了<a href="https://sardinary.vercel.app/spring/spring-security-01/#security-configurer" target="_blank" rel="noopener noreferrer">SecurityConfigurer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，因此实现了init方法和configure方法</p> <h3 id="init"><a href="#init" class="header-anchor">#</a> init</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">B</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	<span class="token comment">//注册一些默认属性</span>
    <span class="token function">updateAuthenticationDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">updateAccessDefaults</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerDefaultAuthenticationEntryPoint</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="configure"><a href="#configure" class="header-anchor">#</a> Configure</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">B</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">PortMapper</span> portMapper <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">PortMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>portMapper <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationEntryPoint<span class="token punctuation">.</span><span class="token function">setPortMapper</span><span class="token punctuation">(</span>portMapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//拿出共享对象，得到请求的缓存器</span>
    <span class="token class-name">RequestCache</span> requestCache <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">RequestCache</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCache <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//1️⃣</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>defaultSuccessHandler<span class="token punctuation">.</span><span class="token function">setRequestCache</span><span class="token punctuation">(</span>requestCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>authFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationManager</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>authFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationSuccessHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>successHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>authFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationFailureHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>failureHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationDetailsSource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>authFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationDetailsSource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationDetailsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">SessionAuthenticationStrategy</span> sessionAuthenticationStrategy <span class="token operator">=</span> http
       <span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">SessionAuthenticationStrategy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionAuthenticationStrategy <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>authFilter<span class="token punctuation">.</span><span class="token function">setSessionAuthenticationStrategy</span><span class="token punctuation">(</span>sessionAuthenticationStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">RememberMeServices</span> rememberMeServices <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">RememberMeServices</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rememberMeServices <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>authFilter<span class="token punctuation">.</span><span class="token function">setRememberMeServices</span><span class="token punctuation">(</span>rememberMeServices<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//设置安全上下文</span>
    <span class="token class-name">SecurityContextConfigurer</span> securityContextConfigurer <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getConfigurer</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>securityContextConfigurer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> securityContextConfigurer<span class="token punctuation">.</span><span class="token function">isRequireExplicitSave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">SecurityContextRepository</span> securityContextRepository <span class="token operator">=</span> securityContextConfigurer
          <span class="token punctuation">.</span><span class="token function">getSecurityContextRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>authFilter<span class="token punctuation">.</span><span class="token function">setSecurityContextRepository</span><span class="token punctuation">(</span>securityContextRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>authFilter<span class="token punctuation">.</span><span class="token function">setSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token function">getSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">F</span> filter <span class="token operator">=</span> <span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//2️⃣</span>
    <span class="token comment">//添加filter</span>
    http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//3️⃣</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_1️⃣this-defaultsuccesshandler-setrequestcache-requestcache"><a href="#_1️⃣this-defaultsuccesshandler-setrequestcache-requestcache" class="header-anchor">#</a> 1️⃣this.defaultSuccessHandler.setRequestCache(requestCache)</h3> <p>保存用户登录失败前的页面，下次登录成功后默认打开上次登录的最后页面（即保存的页面），用户体验好</p> <h3 id="_2️⃣postprocess-this-authfilter"><a href="#_2️⃣postprocess-this-authfilter" class="header-anchor">#</a> 2️⃣postProcess(this.authFilter)</h3> <h3 id="可以在我们配置的config类自定义postprocesser"><a href="#可以在我们配置的config类自定义postprocesser" class="header-anchor">#</a> 可以在我们配置的config类自定义postProcesser</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DefaultSecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">withObjectPostProcessor</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">addObjectPostProcessor</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre></div><p>在...处new一个自己的objectPostProcessor，instanceof某一个filter</p> <h3 id="this-authfilter注入的时机"><a href="#this-authfilter注入的时机" class="header-anchor">#</a> this.authFilter注入的时机</h3> <div class="language- extra-class"><pre class="language-text"><code>protected final void setAuthenticationFilter(F authFilter) {
    this.authFilter = authFilter;
}

</code></pre></div><p>其中setAuthenticationFilter被调用的时机为：</p> <blockquote><p>在子类中被调用。</p> <p>例如子类FormLoginConfigurer</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">FormLoginConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">usernameParameter</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">passwordParameter</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><blockquote><p>其中super的构造方法</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">AbstractAuthenticationFilterConfigurer</span><span class="token punctuation">(</span><span class="token class-name">F</span> authenticationFilter<span class="token punctuation">,</span> <span class="token class-name">String</span> defaultLoginProcessingUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>authFilter <span class="token operator">=</span> authenticationFilter<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultLoginProcessingUrl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span>defaultLoginProcessingUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_3️⃣addfilter"><a href="#_3️⃣addfilter" class="header-anchor">#</a> 3️⃣addFilter</h3> <p>HttpSecurityBuilder接口中声明，<a href="https://sardinary.vercel.app/spring/spring-security-01/#http-security" target="_blank" rel="noopener noreferrer">HttpSecurity<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中实现</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">HttpSecurity</span> <span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token class-name">Filter</span> filter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Integer</span> order <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>filterOrders<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span>filter<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>order <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;The Filter class &quot;</span> <span class="token operator">+</span> filter<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token operator">+</span> <span class="token string">&quot; does not have a registered order and cannot be added without a specified order. Consider using addFilterBefore or addFilterAfter instead.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>filters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderedFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="匿名登录"><a href="#匿名登录" class="header-anchor">#</a> 匿名登录</h2> <blockquote><p>登录成功后，默认的用户名和密码由SecurityProperties类中的User类中的属性确定</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>private String name = &quot;user&quot;;
private String password = UUID.randomUUID().toString();

</code></pre></div><blockquote><p>默认情况下会执行UserDetailsServiceAutoConfiguration类中的：</p></blockquote> <ul><li>inMemoryUserDetailsManager方法</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">InMemoryUserDetailsManager</span> <span class="token function">inMemoryUserDetailsManager</span><span class="token punctuation">(</span><span class="token class-name">SecurityProperties</span> properties<span class="token punctuation">,</span> <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PasswordEncoder</span><span class="token punctuation">&gt;</span></span> passwordEncoder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SecurityProperties<span class="token punctuation">.</span>User</span> user <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> roles <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryUserDetailsManager</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserDetails</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOrDeducePassword</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">PasswordEncoder</span><span class="token punctuation">)</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">getIfAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">toStringArray</span><span class="token punctuation">(</span>roles<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>InMemoryUserDetailsManager类</p> <p><img src="/Sardinary/assets/img/Untitled12.4b248751.png" alt="Untitled"></p> <ul><li>getOrDeducePassword方法</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getOrDeducePassword</span><span class="token punctuation">(</span><span class="token class-name">SecurityProperties<span class="token punctuation">.</span>User</span> user<span class="token punctuation">,</span> <span class="token class-name">PasswordEncoder</span> encoder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> password <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">isPasswordGenerated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%n%nUsing generated security password: %s%n%nThis generated password is for development use only. Your security configuration must be updated before running your application in production.%n&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> encoder <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token constant">PASSWORD_ALGORITHM_PATTERN</span><span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;{noop}&quot;</span> <span class="token operator">+</span> password <span class="token operator">:</span> password<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="登录过程"><a href="#登录过程" class="header-anchor">#</a> 登录过程</h3> <p>进入<a href="https://sardinary.vercel.app/spring/spring-security-01/#abstract-authentication-processing-filter" target="_blank" rel="noopener noreferrer">AbstractAuthenticationProcessingFilter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的<a href="https://sardinary.vercel.app/spring/spring-security-01/#do-filter" target="_blank" rel="noopener noreferrer">doFilter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>方法</p> <p>前端登录成功后会调用<a href="https://sardinary.vercel.app/spring/spring-security-01/#username-password-authentication-filter" target="_blank" rel="noopener noreferrer">UsernamePasswordAuthenticationFilter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的<a href="https://sardinary.vercel.app/spring/spring-security-01/#2-attempt-authentication" target="_blank" rel="noopener noreferrer">attemptAuthentication<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>方法</p> <p>其中的this.getAuthenticationManager()是一个providerManager，但是该providerManage的providers属性中只有一个AnonymousAuthenticationProvider；而该providerManage的parent属性中的providers中有<a href="https://sardinary.vercel.app/spring/spring-security-01/#dao-authentication-provider" target="_blank" rel="noopener noreferrer">DaoAuthenticationProvider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>然后执行<a href="https://sardinary.vercel.app/spring/spring-security-01/#provider-manager" target="_blank" rel="noopener noreferrer">ProviderManager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的authenticate方法，在判断子类provider是否支持的时候发现子类的唯一的AnonymousAuthenticationProvider不支持，然后调用父类的provider，发现支持<a href="https://sardinary.vercel.app/spring/spring-security-01/#dao-authentication-provider" target="_blank" rel="noopener noreferrer">DaoAuthenticationProvider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>然后执行provider.<a href="https://sardinary.vercel.app/spring/spring-security-01/#authenticate" target="_blank" rel="noopener noreferrer">authenticate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>方法，进入<a href="https://sardinary.vercel.app/spring/spring-security-01/#abstract-user-details-authentication-provider" target="_blank" rel="noopener noreferrer">AbstractUserDetailsAuthenticationProvider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>类</p> <p>然后进入执行<a href="https://sardinary.vercel.app/spring/spring-security-01/#6-retrieve-user" target="_blank" rel="noopener noreferrer">retrieveUser<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>方法，进入<a href="https://sardinary.vercel.app/spring/spring-security-01/#dao-authentication-provider" target="_blank" rel="noopener noreferrer">DaoAuthenticationProvider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>类，</p> <p>其中的this.getUserDetailsService为inMemoryUserDetailsManager</p> <p>执行到<a href="https://sardinary.vercel.app/spring/spring-security-01/#abstract-user-details-authentication-provider" target="_blank" rel="noopener noreferrer">AbstractUserDetailsAuthenticationProvider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的<a href="https://sardinary.vercel.app/spring/spring-security-01/#authenticate" target="_blank" rel="noopener noreferrer">authenticate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>方法的return createSuccessAuthentication语句时</p> <p>执行方法createSuccessAuthentication，进入<a href="https://sardinary.vercel.app/spring/spring-security-01/#dao-authentication-provider" target="_blank" rel="noopener noreferrer">DaoAuthenticationProvider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>类</p> <p>执行到return super.createSuccessAuthentication的时候</p> <p>进入父类<a href="https://sardinary.vercel.app/spring/spring-security-01/#abstract-user-details-authentication-provider" target="_blank" rel="noopener noreferrer">AbstractUserDetailsAuthenticationProvider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的<a href="https://sardinary.vercel.app/spring/spring-security-01/#5-create-success-authentication" target="_blank" rel="noopener noreferrer">createSuccessAuthentication<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>方法</p> <p>执行UsernamePasswordAuthenticationToken.authenticated方法得到UsernamePasswordAuthenticationToken</p> <p><em>......一系列返回</em></p> <p>执行完attemptAuthentication方法，返回认证成功的<a href="https://sardinary.vercel.app/spring/spring-security-01/#authentication" target="_blank" rel="noopener noreferrer">Authentication<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>到<a href="https://sardinary.vercel.app/spring/spring-security-01/#abstract-authentication-processing-filter" target="_blank" rel="noopener noreferrer">AbstractAuthenticationProcessingFilter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，继续完成<a href="https://sardinary.vercel.app/spring/spring-security-01/#do-filter" target="_blank" rel="noopener noreferrer">doFilter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>方法</p> <p>调用successfulAuthentication方法</p> <p>调用onAuthenticationSuccess方法，进入SavedRequestAwareAuthenticationSuccessHandler类，进行重定向</p></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#引入" class="sidebar-link reco-side-引入" data-v-b57cc07c>引入</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#httpsecurity" class="sidebar-link reco-side-httpsecurity" data-v-b57cc07c>HttpSecurity</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#securityfilterchain" class="sidebar-link reco-side-securityfilterchain" data-v-b57cc07c>SecurityFilterChain</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#实现类defaultsecurityfilterchain" class="sidebar-link reco-side-实现类defaultsecurityfilterchain" data-v-b57cc07c>实现类DefaultSecurityFilterChain</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#websecurity" class="sidebar-link reco-side-websecurity" data-v-b57cc07c>WebSecurity</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#securitybuilder的build方法-dobuild方法" class="sidebar-link reco-side-securitybuilder的build方法-dobuild方法" data-v-b57cc07c>SecurityBuilder的build方法 -&gt; doBuild方法</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#filterchainproxy" class="sidebar-link reco-side-filterchainproxy" data-v-b57cc07c>FilterChainProxy</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#springsecurity流程" class="sidebar-link reco-side-springsecurity流程" data-v-b57cc07c>SpringSecurity流程</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#httpsecurity和websecurity的配置" class="sidebar-link reco-side-httpsecurity和websecurity的配置" data-v-b57cc07c>HttpSecurity和WebSecurity的配置</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#securityconfigurer" class="sidebar-link reco-side-securityconfigurer" data-v-b57cc07c>SecurityConfigurer</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#abstractconfiguredsecuritybuilder" class="sidebar-link reco-side-abstractconfiguredsecuritybuilder" data-v-b57cc07c>AbstractConfiguredSecurityBuilder</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#_4️⃣init" class="sidebar-link reco-side-_4️⃣init" data-v-b57cc07c>4️⃣init()</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#collection-securityconfigurer-o-b-configurers-2️⃣getconfigurers-作用" class="sidebar-link reco-side-collection-securityconfigurer-o-b-configurers-2️⃣getconfigurers-作用" data-v-b57cc07c>Collection configurers = 2️⃣getConfigurers()作用：</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#for-securityconfigurer-o-b-configurer-this-configurersaddedininitializing-作用" class="sidebar-link reco-side-for-securityconfigurer-o-b-configurer-this-configurersaddedininitializing-作用" data-v-b57cc07c>for (SecurityConfigurer configurer : this.configurersAddedInInitializing)作用：</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#_5️⃣beforeconfigure" class="sidebar-link reco-side-_5️⃣beforeconfigure" data-v-b57cc07c>5️⃣beforeConfigure()</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#_1️⃣buildstate" class="sidebar-link reco-side-_1️⃣buildstate" data-v-b57cc07c>1️⃣BuildState</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#httpsecurity-2" class="sidebar-link reco-side-httpsecurity-2" data-v-b57cc07c>HttpSecurity</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#_7️⃣httpsecurity对performbuild-方法的实现" class="sidebar-link reco-side-_7️⃣httpsecurity对performbuild-方法的实现" data-v-b57cc07c>7️⃣HttpSecurity对performBuild()方法的实现</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#authentication" class="sidebar-link reco-side-authentication" data-v-b57cc07c>Authentication</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#authenticationmanager" class="sidebar-link reco-side-authenticationmanager" data-v-b57cc07c>AuthenticationManager</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#authenticationmanagerbuilder" class="sidebar-link reco-side-authenticationmanagerbuilder" data-v-b57cc07c>AuthenticationManagerBuilder</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#属性" class="sidebar-link reco-side-属性" data-v-b57cc07c>属性</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#performbuild" class="sidebar-link reco-side-performbuild" data-v-b57cc07c>performBuild()</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#postprocess-providermanager" class="sidebar-link reco-side-postprocess-providermanager" data-v-b57cc07c>postProcess(providerManager)</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#属性设置" class="sidebar-link reco-side-属性设置" data-v-b57cc07c>属性设置</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#authenticationprovider在这个构造方法被设置" class="sidebar-link reco-side-authenticationprovider在这个构造方法被设置" data-v-b57cc07c>AuthenticationProvider在这个构造方法被设置</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#parentauthenticationmanager在这个构造方法被设置" class="sidebar-link reco-side-parentauthenticationmanager在这个构造方法被设置" data-v-b57cc07c>parentAuthenticationManager在这个构造方法被设置</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#authenticationprovider" class="sidebar-link reco-side-authenticationprovider" data-v-b57cc07c>AuthenticationProvider</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#authenticate-authentication-authentication" class="sidebar-link reco-side-authenticate-authentication-authentication" data-v-b57cc07c>authenticate(Authentication authentication)</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#策略模式" class="sidebar-link reco-side-策略模式" data-v-b57cc07c>策略模式</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#providermanager" class="sidebar-link reco-side-providermanager" data-v-b57cc07c>ProviderManager</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#authenticate方法" class="sidebar-link reco-side-authenticate方法" data-v-b57cc07c>authenticate方法</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#流程" class="sidebar-link reco-side-流程" data-v-b57cc07c>流程</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#总结" class="sidebar-link reco-side-总结" data-v-b57cc07c>总结</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#userdetailsservice" class="sidebar-link reco-side-userdetailsservice" data-v-b57cc07c>UserDetailsService</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#daoauthenticationprovider" class="sidebar-link reco-side-daoauthenticationprovider" data-v-b57cc07c>DaoAuthenticationProvider</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#abstractuserdetailsauthenticationprovider" class="sidebar-link reco-side-abstractuserdetailsauthenticationprovider" data-v-b57cc07c>AbstractUserDetailsAuthenticationProvider</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#🌟authenticate方法" class="sidebar-link reco-side-🌟authenticate方法" data-v-b57cc07c>🌟authenticate方法</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#_1️⃣determineusername" class="sidebar-link reco-side-_1️⃣determineusername" data-v-b57cc07c>1️⃣determineUsername</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#_2️⃣user永远等于null" class="sidebar-link reco-side-_2️⃣user永远等于null" data-v-b57cc07c>2️⃣user永远等于null</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#_3️⃣关于隐藏usernotfoundexceptions" class="sidebar-link reco-side-_3️⃣关于隐藏usernotfoundexceptions" data-v-b57cc07c>3️⃣关于隐藏UserNotFoundExceptions</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#_4️⃣如果捕获到了authenticationexception" class="sidebar-link reco-side-_4️⃣如果捕获到了authenticationexception" data-v-b57cc07c>4️⃣如果捕获到了AuthenticationException</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#关于校验" class="sidebar-link reco-side-关于校验" data-v-b57cc07c>关于校验</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#userdetailschecker" class="sidebar-link reco-side-userdetailschecker" data-v-b57cc07c>UserDetailsChecker</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#defaultpreauthenticationchecks" class="sidebar-link reco-side-defaultpreauthenticationchecks" data-v-b57cc07c>DefaultPreAuthenticationChecks</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#defaultpostauthenticationchecks" class="sidebar-link reco-side-defaultpostauthenticationchecks" data-v-b57cc07c>DefaultPostAuthenticationChecks</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#additionalauthenticationchecks" class="sidebar-link reco-side-additionalauthenticationchecks" data-v-b57cc07c>additionalAuthenticationChecks</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#_5️⃣createsuccessauthentication" class="sidebar-link reco-side-_5️⃣createsuccessauthentication" data-v-b57cc07c>5️⃣createSuccessAuthentication</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#authoritiesmapper" class="sidebar-link reco-side-authoritiesmapper" data-v-b57cc07c>authoritiesMapper</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#daoauthenticationprovider中的createsuccessauthentication" class="sidebar-link reco-side-daoauthenticationprovider中的createsuccessauthentication" data-v-b57cc07c>DaoAuthenticationProvider中的createSuccessAuthentication</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#userdetailspasswordservice" class="sidebar-link reco-side-userdetailspasswordservice" data-v-b57cc07c>userDetailsPasswordService</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#_6️⃣retrieveuser🌟" class="sidebar-link reco-side-_6️⃣retrieveuser🌟" data-v-b57cc07c>6️⃣retrieveUser🌟</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#在daoauthenticationprovider中唯一实现" class="sidebar-link reco-side-在daoauthenticationprovider中唯一实现" data-v-b57cc07c>在DaoAuthenticationProvider中唯一实现</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#preparetimingattackprotection-和mitigateagainsttimingattack-authentication" class="sidebar-link reco-side-preparetimingattackprotection-和mitigateagainsttimingattack-authentication" data-v-b57cc07c>prepareTimingAttackProtection()和mitigateAgainstTimingAttack(authentication)</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#流程-2" class="sidebar-link reco-side-流程-2" data-v-b57cc07c>流程</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#usernamepasswordauthenticationfilter" class="sidebar-link reco-side-usernamepasswordauthenticationfilter" data-v-b57cc07c>UsernamePasswordAuthenticationFilter</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#父类为abstractauthenticationprocessingfilter" class="sidebar-link reco-side-父类为abstractauthenticationprocessingfilter" data-v-b57cc07c>父类为AbstractAuthenticationProcessingFilter</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#父类的dofilter方法" class="sidebar-link reco-side-父类的dofilter方法" data-v-b57cc07c>父类的doFilter方法</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#_1️⃣successfulauthentication" class="sidebar-link reco-side-_1️⃣successfulauthentication" data-v-b57cc07c>1️⃣successfulAuthentication</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#_2️⃣attemptauthentication" class="sidebar-link reco-side-_2️⃣attemptauthentication" data-v-b57cc07c>2️⃣attemptAuthentication</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#更改usernameparameter和passwordparameter" class="sidebar-link reco-side-更改usernameparameter和passwordparameter" data-v-b57cc07c>更改usernameParameter和passwordParameter</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#formloginconfigurer" class="sidebar-link reco-side-formloginconfigurer" data-v-b57cc07c>FormLoginConfigurer</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#父类securityconfigureradapter" class="sidebar-link reco-side-父类securityconfigureradapter" data-v-b57cc07c>父类SecurityConfigurerAdapter</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#父类abstracthttpconfigurer" class="sidebar-link reco-side-父类abstracthttpconfigurer" data-v-b57cc07c>父类AbstractHttpConfigurer</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#disable" class="sidebar-link reco-side-disable" data-v-b57cc07c>disable</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#withobjectpostprocessor" class="sidebar-link reco-side-withobjectpostprocessor" data-v-b57cc07c>withObjectPostProcessor</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#父类abstractauthenticationfilterconfigurer" class="sidebar-link reco-side-父类abstractauthenticationfilterconfigurer" data-v-b57cc07c>父类AbstractAuthenticationFilterConfigurer</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#init" class="sidebar-link reco-side-init" data-v-b57cc07c>init</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#configure" class="sidebar-link reco-side-configure" data-v-b57cc07c>Configure</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#_1️⃣this-defaultsuccesshandler-setrequestcache-requestcache" class="sidebar-link reco-side-_1️⃣this-defaultsuccesshandler-setrequestcache-requestcache" data-v-b57cc07c>1️⃣this.defaultSuccessHandler.setRequestCache(requestCache)</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#_2️⃣postprocess-this-authfilter" class="sidebar-link reco-side-_2️⃣postprocess-this-authfilter" data-v-b57cc07c>2️⃣postProcess(this.authFilter)</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#可以在我们配置的config类自定义postprocesser" class="sidebar-link reco-side-可以在我们配置的config类自定义postprocesser" data-v-b57cc07c>可以在我们配置的config类自定义postProcesser</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#this-authfilter注入的时机" class="sidebar-link reco-side-this-authfilter注入的时机" data-v-b57cc07c>this.authFilter注入的时机</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#_3️⃣addfilter" class="sidebar-link reco-side-_3️⃣addfilter" data-v-b57cc07c>3️⃣addFilter</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#匿名登录" class="sidebar-link reco-side-匿名登录" data-v-b57cc07c>匿名登录</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_01%2043df0f31c1074521b09583c6ba675b1f.html#登录过程" class="sidebar-link reco-side-登录过程" data-v-b57cc07c>登录过程</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:0;" data-v-248d85d6></canvas></div><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="/Sardinary/assets/js/app.b4352b80.js" defer></script><script src="/Sardinary/assets/js/7.1de0e771.js" defer></script><script src="/Sardinary/assets/js/2.32e86603.js" defer></script><script src="/Sardinary/assets/js/1.87af8fda.js" defer></script><script src="/Sardinary/assets/js/19.73412c71.js" defer></script>
  </body>
</html>
