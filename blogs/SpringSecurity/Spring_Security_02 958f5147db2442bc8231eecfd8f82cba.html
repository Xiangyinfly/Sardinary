<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SpringSecurity源码解析-2 | Sardinary&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content=" ">
    
    <link rel="preload" href="/Sardinary/assets/css/0.styles.cca88062.css" as="style"><link rel="preload" href="/Sardinary/assets/js/app.b4352b80.js" as="script"><link rel="preload" href="/Sardinary/assets/js/7.1de0e771.js" as="script"><link rel="preload" href="/Sardinary/assets/js/2.32e86603.js" as="script"><link rel="preload" href="/Sardinary/assets/js/1.87af8fda.js" as="script"><link rel="preload" href="/Sardinary/assets/js/25.c67021f4.js" as="script"><link rel="prefetch" href="/Sardinary/assets/js/10.49a810cd.js"><link rel="prefetch" href="/Sardinary/assets/js/11.7175f7e3.js"><link rel="prefetch" href="/Sardinary/assets/js/14.a5477566.js"><link rel="prefetch" href="/Sardinary/assets/js/15.439772b1.js"><link rel="prefetch" href="/Sardinary/assets/js/16.16e886bc.js"><link rel="prefetch" href="/Sardinary/assets/js/17.0e6e36bb.js"><link rel="prefetch" href="/Sardinary/assets/js/18.5e148afa.js"><link rel="prefetch" href="/Sardinary/assets/js/19.73412c71.js"><link rel="prefetch" href="/Sardinary/assets/js/20.e6e484b2.js"><link rel="prefetch" href="/Sardinary/assets/js/21.7c59eb62.js"><link rel="prefetch" href="/Sardinary/assets/js/22.1a4515f8.js"><link rel="prefetch" href="/Sardinary/assets/js/23.77f49651.js"><link rel="prefetch" href="/Sardinary/assets/js/24.2978efd9.js"><link rel="prefetch" href="/Sardinary/assets/js/26.6879f189.js"><link rel="prefetch" href="/Sardinary/assets/js/27.a2713265.js"><link rel="prefetch" href="/Sardinary/assets/js/28.0e7ec6a5.js"><link rel="prefetch" href="/Sardinary/assets/js/29.b33743d7.js"><link rel="prefetch" href="/Sardinary/assets/js/3.5b666661.js"><link rel="prefetch" href="/Sardinary/assets/js/30.3b66f6c0.js"><link rel="prefetch" href="/Sardinary/assets/js/31.a9a2ab1e.js"><link rel="prefetch" href="/Sardinary/assets/js/32.14ad86fd.js"><link rel="prefetch" href="/Sardinary/assets/js/33.1afd794c.js"><link rel="prefetch" href="/Sardinary/assets/js/34.31730445.js"><link rel="prefetch" href="/Sardinary/assets/js/35.acb79716.js"><link rel="prefetch" href="/Sardinary/assets/js/36.f161e3da.js"><link rel="prefetch" href="/Sardinary/assets/js/37.164bb569.js"><link rel="prefetch" href="/Sardinary/assets/js/38.0e4326d9.js"><link rel="prefetch" href="/Sardinary/assets/js/39.c0cdc477.js"><link rel="prefetch" href="/Sardinary/assets/js/4.95ecc938.js"><link rel="prefetch" href="/Sardinary/assets/js/40.4c8a03a6.js"><link rel="prefetch" href="/Sardinary/assets/js/41.b3e26267.js"><link rel="prefetch" href="/Sardinary/assets/js/42.6526990c.js"><link rel="prefetch" href="/Sardinary/assets/js/43.237a07a2.js"><link rel="prefetch" href="/Sardinary/assets/js/44.20a80a6c.js"><link rel="prefetch" href="/Sardinary/assets/js/45.ee53ec88.js"><link rel="prefetch" href="/Sardinary/assets/js/46.55f62d10.js"><link rel="prefetch" href="/Sardinary/assets/js/47.2a4b0a3b.js"><link rel="prefetch" href="/Sardinary/assets/js/48.d2f40143.js"><link rel="prefetch" href="/Sardinary/assets/js/49.6f809adc.js"><link rel="prefetch" href="/Sardinary/assets/js/5.c87bfc3b.js"><link rel="prefetch" href="/Sardinary/assets/js/50.e8110b40.js"><link rel="prefetch" href="/Sardinary/assets/js/51.e5d33d8f.js"><link rel="prefetch" href="/Sardinary/assets/js/52.35081e55.js"><link rel="prefetch" href="/Sardinary/assets/js/53.f148b50f.js"><link rel="prefetch" href="/Sardinary/assets/js/54.c9fddbbe.js"><link rel="prefetch" href="/Sardinary/assets/js/55.3bf482f3.js"><link rel="prefetch" href="/Sardinary/assets/js/56.284247d8.js"><link rel="prefetch" href="/Sardinary/assets/js/57.cd2fa388.js"><link rel="prefetch" href="/Sardinary/assets/js/58.9717d8f3.js"><link rel="prefetch" href="/Sardinary/assets/js/59.387411ca.js"><link rel="prefetch" href="/Sardinary/assets/js/6.363116dc.js"><link rel="prefetch" href="/Sardinary/assets/js/60.10700fc9.js"><link rel="prefetch" href="/Sardinary/assets/js/61.37f12cd5.js"><link rel="prefetch" href="/Sardinary/assets/js/62.1ee2e76e.js"><link rel="prefetch" href="/Sardinary/assets/js/63.05cc0dee.js"><link rel="prefetch" href="/Sardinary/assets/js/64.2eefe5c7.js"><link rel="prefetch" href="/Sardinary/assets/js/65.57aedaf0.js"><link rel="prefetch" href="/Sardinary/assets/js/66.3362b95c.js"><link rel="prefetch" href="/Sardinary/assets/js/67.31c9d9fd.js"><link rel="prefetch" href="/Sardinary/assets/js/68.966d4fa1.js"><link rel="prefetch" href="/Sardinary/assets/js/69.a33abe62.js"><link rel="prefetch" href="/Sardinary/assets/js/70.11dd9007.js"><link rel="prefetch" href="/Sardinary/assets/js/71.8006b388.js"><link rel="prefetch" href="/Sardinary/assets/js/72.73f1646b.js"><link rel="prefetch" href="/Sardinary/assets/js/73.f53d7f97.js"><link rel="prefetch" href="/Sardinary/assets/js/74.db2bf712.js"><link rel="prefetch" href="/Sardinary/assets/js/8.1ffd42bb.js"><link rel="prefetch" href="/Sardinary/assets/js/9.8e14a092.js"><link rel="prefetch" href="/Sardinary/assets/js/vendors~docsearch.34a230bb.js">
    <link rel="stylesheet" href="/Sardinary/assets/css/0.styles.cca88062.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Sardinary's Blog</h3> <p class="description" data-v-59e6cb88> </p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Sardinary Chen</span>
          
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Sardinary/" class="home-link router-link-active"><img src="/Sardinary/avatar.jpg" alt="Sardinary's Blog" class="logo"> <span class="site-name">Sardinary's Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Sardinary/" class="nav-link"><i class="undefined"></i>
  🏠
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Sardinary/categories/后端/" class="nav-link"><i class="undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/Sardinary/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Sardinary 🎈
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Xiangyinfly" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/Sardinary/avatar.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    Sardinary Chen
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>36</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>12</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/Sardinary/" class="nav-link"><i class="undefined"></i>
  🏠
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Sardinary/categories/后端/" class="nav-link"><i class="undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Sardinary/categories/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/Sardinary/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Sardinary 🎈
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Xiangyinfly" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>SpringSecurity源码解析-2</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Sardinary Chen</span>
          
        <!---->
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">SpringSecurity源码解析-2</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>Sardinary Chen</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2/26/2024</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>SpringSecurity</span><span class="tag-item" data-v-8a445198>源码解析</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="spring-security-02"><a href="#spring-security-02" class="header-anchor">#</a> Spring_Security_02</h1> <h1 id="securitycontext相关类"><a href="#securitycontext相关类" class="header-anchor">#</a> SecurityContext相关类</h1> <ul><li>SecurityContext存有Authentication的一个对象</li> <li>SecurityContextHolder</li> <li>SecurityContextHolderStrategy</li> <li>SecurityContextPersistenceFilter</li> <li>SecurityContextHolderFilter</li> <li>SecurityContextRepository</li> <li>SecurityContextConfigurer配置过滤器</li></ul> <h2 id="securitycontext"><a href="#securitycontext" class="header-anchor">#</a> SecurityContext</h2> <p>存储<code>Authentication</code>的实例就是安全上下文</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SecurityContext</span> <span class="token keyword">extends</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token class-name">Authentication</span> <span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">setAuthentication</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="securitycontextholder"><a href="#securitycontextholder" class="header-anchor">#</a> SecurityContextHolder</h2> <p><strong>SecurityContext的持有器</strong></p> <h3 id="一些设置context的重要方法"><a href="#一些设置context的重要方法" class="header-anchor">#</a> 一些设置context的重要方法</h3> <div class="language- extra-class"><pre class="language-text"><code>public static void clearContext() {
    strategy.clearContext();
}

public static SecurityContext getContext() {
    return strategy.getContext();
}

public static void setContext(SecurityContext context) {
    strategy.setContext(context);
}

</code></pre></div><p>通过strategy属性来实现这些方法</p> <p>SecurityContextHolder类维护了一个<a href="https://sardinary.vercel.app/spring/spring-security-02/#security-context-holder-strategy" target="_blank" rel="noopener noreferrer">SecurityContextHolderStrategy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language- extra-class"><pre class="language-text"><code>private static SecurityContextHolderStrategy strategy;

</code></pre></div><h3 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h3> <p>类加载后首先执行静态代码块</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token punctuation">{</span>
    <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//执行初始化</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initializeStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    initializeCount<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initializeStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//判断策略类是否在初始化之前已经自定义设置好。返回true则直接退出方法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">MODE_PRE_INITIALIZED</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>strategyName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>strategy <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;When using &quot;</span> <span class="token operator">+</span> <span class="token constant">MODE_PRE_INITIALIZED</span>
             <span class="token operator">+</span> <span class="token string">&quot;, setContextHolderStrategy must be called with the fully constructed strategy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//判断是否空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>strategyName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// Set default</span>
       strategyName <span class="token operator">=</span> <span class="token constant">MODE_THREADLOCAL</span><span class="token punctuation">;</span>  <span class="token comment">//默认为MODE_THREADLOCAL</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategyName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">MODE_THREADLOCAL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//将strategy默认设置为ThreadLocalSecurityContextHolderStrategy</span>
       strategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategyName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">MODE_INHERITABLETHREADLOCAL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       strategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InheritableThreadLocalSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategyName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token constant">MODE_GLOBAL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       strategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GlobalSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Try to load a custom strategy</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>strategyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> customStrategy <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       strategy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SecurityContextHolderStrategy</span><span class="token punctuation">)</span> customStrategy<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">handleReflectionException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="securitycontextholderstrategy"><a href="#securitycontextholderstrategy" class="header-anchor">#</a> SecurityContextHolderStrategy</h2> <p><strong>SecurityContextHolder存储SecurityContext的一种策略</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SecurityContextHolderStrategy</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SecurityContext</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDeferredContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">setContext</span><span class="token punctuation">(</span><span class="token class-name">SecurityContext</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">setDeferredContext</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span></span> deferredContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">setContext</span><span class="token punctuation">(</span>deferredContext<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">SecurityContext</span> <span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre></div><p>实现类：</p> <p><img src="/Sardinary/assets/img/Untitled13.7219cc11.png" alt="Untitled"></p> <h3 id="主要使用threadlocalsecuritycontextholderstrategy"><a href="#主要使用threadlocalsecuritycontextholderstrategy" class="header-anchor">#</a> 主要使用ThreadLocalSecurityContextHolderStrategy</h3> <p>一个变量对一个线程共享，对不同线程不共享</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalSecurityContextHolderStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">SecurityContextHolderStrategy</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Supplier</span><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> contextHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       contextHolder<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SecurityContext</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token function">getDeferredContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDeferredContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> contextHolder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">SecurityContext</span> context <span class="token operator">=</span> <span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> context<span class="token punctuation">;</span>
          contextHolder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setContext</span><span class="token punctuation">(</span><span class="token class-name">SecurityContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">&quot;Only non-null SecurityContext instances are permitted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       contextHolder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDeferredContext</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span></span> deferredContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>deferredContext<span class="token punctuation">,</span> <span class="token string">&quot;Only non-null Supplier instances are permitted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span></span> notNullDeferredContext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
          <span class="token class-name">SecurityContext</span> result <span class="token operator">=</span> deferredContext<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token string">&quot;A Supplier&lt;SecurityContext&gt; returned null and is not allowed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> result<span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">;</span>
       contextHolder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>notNullDeferredContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SecurityContext</span> <span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SecurityContextImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//是SecurityContext的默认实现</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h2 id="securitycontextrepository"><a href="#securitycontextrepository" class="header-anchor">#</a> SecurityContextRepository</h2> <p>用于持久化SecurityContext</p> <p>常常自定义SecurityContextRepository，通过内存数据库来进行持久化</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SecurityContextRepository</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Deprecated</span>
    <span class="token class-name">SecurityContext</span> <span class="token function">loadContext</span><span class="token punctuation">(</span><span class="token class-name">HttpRequestResponseHolder</span> requestResponseHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//获取</span>
    <span class="token keyword">default</span> <span class="token class-name">DeferredSecurityContext</span> <span class="token function">loadDeferredContext</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span></span> supplier <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">loadContext</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpRequestResponseHolder</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SupplierDeferredSecurityContext</span><span class="token punctuation">(</span><span class="token class-name">SingletonSupplier</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>supplier<span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContextHolderStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//保存</span>
    <span class="token keyword">void</span> <span class="token function">saveContext</span><span class="token punctuation">(</span><span class="token class-name">SecurityContext</span> context<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">containsContext</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre></div><h2 id="securitycontextpersistencefilter"><a href="#securitycontextpersistencefilter" class="header-anchor">#</a> SecurityContextPersistenceFilter</h2> <p>该类已经过时，用<a href="https://sardinary.vercel.app/spring/spring-security-02/#security-context-holder-filter" target="_blank" rel="noopener noreferrer">SecurityContextHolderFilter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>代替</p> <p><img src="/Sardinary/assets/img/Untitled14.15dadc32.png" alt="Untitled"></p> <h3 id="dofilter方法"><a href="#dofilter方法" class="header-anchor">#</a> doFilter方法</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
       <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
       <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token comment">// ensure that filter is only applied once per request</span>
    <span class="token comment">//保证每个请求只会进行一次filter</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>forceEagerSessionCreation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> session<span class="token punctuation">.</span><span class="token function">isNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Created session %s eagerly&quot;</span><span class="token punctuation">,</span> session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">HttpRequestResponseHolder</span> holder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpRequestResponseHolder</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SecurityContext</span> contextBeforeChainExecution <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>repo<span class="token punctuation">.</span><span class="token function">loadContext</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
	    <span class="token comment">//调用ThreadLocalSecurityContextHolderStrategy的setContext方法。</span>
		<span class="token comment">//方便后续可以直接可以用securityContextHolderStrategy获取SecurityContext</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>contextBeforeChainExecution<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>contextBeforeChainExecution<span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Set SecurityContextHolder to empty SecurityContext&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">this</span><span class="token punctuation">.</span>logger
                <span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Set SecurityContextHolder to %s&quot;</span><span class="token punctuation">,</span> contextBeforeChainExecution<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
       chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>holder<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span> <span class="token punctuation">{</span>
       <span class="token class-name">SecurityContext</span> contextAfterChainExecution <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// Crucial removal of SecurityContextHolder contents before anything else.</span>
       <span class="token comment">//最后清除Context</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>repo<span class="token punctuation">.</span><span class="token function">saveContext</span><span class="token punctuation">(</span>contextAfterChainExecution<span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       request<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Cleared SecurityContextHolder to complete request&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="redis中出现两个token的原因"><a href="#redis中出现两个token的原因" class="header-anchor">#</a> Redis中出现两个token的原因</h3> <p><a href="https://sardinary.vercel.app/spring/spring-security-02/#security-context-configurer" target="_blank" rel="noopener noreferrer">SecurityContextConfigurer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的<a href="https://sardinary.vercel.app/spring/spring-security-02/#configure" target="_blank" rel="noopener noreferrer">configure<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>方法中，如果requireExplicitSave为false，即启用自动保存，则会调用本类的doFilter方法：</p> <p>try中调用doFilter的时候会调用UsernamePasswordAuthenticationFilter，其父类的方法中会调用saveContext；</p> <p>而finally中又会调用一次saveContext，导致redis中出现两个token</p> <h2 id="securitycontextholderfilter"><a href="#securitycontextholderfilter" class="header-anchor">#</a> SecurityContextHolderFilter</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
       <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
       <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span></span> deferredContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextRepository<span class="token punctuation">.</span><span class="token function">loadDeferredContext</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">setDeferredContext</span><span class="token punctuation">(</span>deferredContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
       chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       request<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>doFilter方法中不会去保存SecurityContext</p> <p>需要我们自己保存，比如在AuthenticationSuccessHandler中去保存</p> <h2 id="securitycontextconfigurer"><a href="#securitycontextconfigurer" class="header-anchor">#</a> SecurityContextConfigurer</h2> <p><img src="/Sardinary/assets/img/Untitled15.72a96b9b.png" alt="Untitled"></p> <p>配置过滤器</p> <h3 id="configure方法"><a href="#configure方法" class="header-anchor">#</a> configure方法</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SecurityContextRepository</span> securityContextRepository <span class="token operator">=</span> <span class="token function">getSecurityContextRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requireExplicitSave<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//判断是否需要手动保存，之前默认false，现在默认true</span>
	    <span class="token comment">//返回true，即需要手动保存</span>
	    <span class="token comment">//可以自定义ObjectPostProcess</span>
       <span class="token class-name">SecurityContextHolderFilter</span> securityContextHolderFilter <span class="token operator">=</span> <span class="token function">postProcess</span><span class="token punctuation">(</span>
             <span class="token keyword">new</span> <span class="token class-name">SecurityContextHolderFilter</span><span class="token punctuation">(</span>securityContextRepository<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       securityContextHolderFilter<span class="token punctuation">.</span><span class="token function">setSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token function">getSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>securityContextHolderFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token class-name">SecurityContextPersistenceFilter</span> securityContextFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecurityContextPersistenceFilter</span><span class="token punctuation">(</span>
             securityContextRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
       securityContextFilter<span class="token punctuation">.</span><span class="token function">setSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token function">getSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">SessionManagementConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> sessionManagement <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getConfigurer</span><span class="token punctuation">(</span><span class="token class-name">SessionManagementConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">SessionCreationPolicy</span> sessionCreationPolicy <span class="token operator">=</span> <span class="token punctuation">(</span>sessionManagement <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
             <span class="token operator">?</span> sessionManagement<span class="token punctuation">.</span><span class="token function">getSessionCreationPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span><span class="token constant">ALWAYS</span> <span class="token operator">==</span> sessionCreationPolicy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          securityContextFilter<span class="token punctuation">.</span><span class="token function">setForceEagerSessionCreation</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ForceEagerSessionCreationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       securityContextFilter <span class="token operator">=</span> <span class="token function">postProcess</span><span class="token punctuation">(</span>securityContextFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
       http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>securityContextFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>build方法 -&gt; doBuild方法 -&gt; performBuild方法 -&gt; 执行真正的逻辑</strong></p> <h2 id="securityfilterchain加入filterchainproxy的时机"><a href="#securityfilterchain加入filterchainproxy的时机" class="header-anchor">#</a> SecurityFilterChain加入FilterChainProxy的时机</h2> <p>SpringSecurity顶层为FilterChainProxy，维护了一堆SecurityFilterChain</p> <p>HttpSecurity的performBuild方法构建出了SecurityFilterChain的默认实现DefaultSecurityFilterChain</p> <p>WebSecurity的performBuild方法构建出了一个Filter，本质上是一个FilterChainProxy</p> <blockquote><p>什么时候将一堆SecurityFilterChain加入该FilterChainProxy？</p></blockquote> <p>WebSecurity的performBuild方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">Filter</span> <span class="token function">performBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityFilterChainBuilders<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;At least one SecurityBuilder&lt;? extends SecurityFilterChain&gt; needs to be specified. &quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;Typically this is done by exposing a SecurityFilterChain bean. &quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;More advanced users can invoke &quot;</span> <span class="token operator">+</span> <span class="token class-name">WebSecurity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token string">&quot;.addSecurityFilterChainBuilder directly&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> chainSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ignoredRequests<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityFilterChainBuilders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建SecurityFilterChain的集合</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityFilterChain</span><span class="token punctuation">&gt;</span></span> securityFilterChains <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>chainSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMatcherEntry</span><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">WebInvocationPrivilegeEvaluator</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> requestMatcherPrivilegeEvaluatorsEntries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> ignoredRequest <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ignoredRequests<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">WebSecurity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;You are asking Spring Security to ignore &quot;</span> <span class="token operator">+</span> ignoredRequest
             <span class="token operator">+</span> <span class="token string">&quot;. This is not recommended -- please use permitAll via HttpSecurity#authorizeHttpRequests instead.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token comment">//构建securityFilterChain并加入</span>
       <span class="token class-name">SecurityFilterChain</span> securityFilterChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSecurityFilterChain</span><span class="token punctuation">(</span><span class="token number">2</span>️⃣ignoredRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
       securityFilterChains<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>securityFilterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
       requestMatcherPrivilegeEvaluatorsEntries
          <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getRequestMatcherPrivilegeEvaluatorsEntry</span><span class="token punctuation">(</span>securityFilterChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//3️⃣</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">SecurityFilterChain</span><span class="token punctuation">&gt;</span></span> securityFilterChainBuilder <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityFilterChainBuilders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">SecurityFilterChain</span> securityFilterChain <span class="token operator">=</span> securityFilterChainBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       securityFilterChains<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>securityFilterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
       requestMatcherPrivilegeEvaluatorsEntries
          <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getRequestMatcherPrivilegeEvaluatorsEntry</span><span class="token punctuation">(</span>securityFilterChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>privilegeEvaluator <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>privilegeEvaluator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestMatcherDelegatingWebInvocationPrivilegeEvaluator</span><span class="token punctuation">(</span>
             requestMatcherPrivilegeEvaluatorsEntries<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//将securityFilterChains加入到filterChainProxy</span>
    <span class="token class-name">FilterChainProxy</span> filterChainProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterChainProxy</span><span class="token punctuation">(</span>securityFilterChains<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>httpFirewall <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       filterChainProxy<span class="token punctuation">.</span><span class="token function">setFirewall</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>httpFirewall<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestRejectedHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       filterChainProxy<span class="token punctuation">.</span><span class="token function">setRequestRejectedHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestRejectedHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>observationRegistry<span class="token punctuation">.</span><span class="token function">isNoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">CompositeRequestRejectedHandler</span> requestRejectedHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompositeRequestRejectedHandler</span><span class="token punctuation">(</span>
             <span class="token keyword">new</span> <span class="token class-name">ObservationMarkingRequestRejectedHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>observationRegistry<span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token keyword">new</span> <span class="token class-name">HttpStatusRequestRejectedHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       filterChainProxy<span class="token punctuation">.</span><span class="token function">setRequestRejectedHandler</span><span class="token punctuation">(</span>requestRejectedHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    filterChainProxy<span class="token punctuation">.</span><span class="token function">setFilterChainDecorator</span><span class="token punctuation">(</span><span class="token function">getFilterChainDecorator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    filterChainProxy<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Filter</span> result <span class="token operator">=</span> filterChainProxy<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>debugEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;\n\n&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;********************************************************************\n&quot;</span>
             <span class="token operator">+</span> <span class="token string">&quot;**********        Security debugging is enabled.       *************\n&quot;</span>
             <span class="token operator">+</span> <span class="token string">&quot;**********    This may include sensitive information.  *************\n&quot;</span>
             <span class="token operator">+</span> <span class="token string">&quot;**********      Do not use in a production system!     *************\n&quot;</span>
             <span class="token operator">+</span> <span class="token string">&quot;********************************************************************\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DebugFilter</span><span class="token punctuation">(</span>filterChainProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>postBuildAction<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>2️⃣关于ignoredRequest</p> <p>WebSecurity自己维护的属性，本质上是RequestMatcher</p> <p>在我们所写的config类中，</p> <div class="language- extra-class"><pre class="language-text"><code>@Bean
public WebSecurityCustomizer webSecurityCustomizer() {
    return web -&gt; {
	    web.ignoring().mvcMatchers();
    }
}

</code></pre></div><p>配置忽略的请求保存在ignoredRequest中</p> <p>3️⃣</p> <p>我们调用addSecurityFilterChainBuilder方法可以在securityFilterChainBuilders属性中加入SecurityFilterChainBuilder，其中的SecurityFilterChainBuilder会在此自动构建产生SecurityFilterChain</p> <h2 id="springsecurity本质是一个过滤器之中套了很多过滤器"><a href="#springsecurity本质是一个过滤器之中套了很多过滤器" class="header-anchor">#</a> SpringSecurity本质是一个过滤器之中套了很多过滤器</h2> <p>FilterChainProxy的doFilter方法</p> <p>FilterChainProxy的doFilterInternal方法</p> <p>FilterChainProxy的getFilter方法</p> <p>DefaultSecurityFilterChain的matches方法</p> <p>this.requestMatcher匹配anyRequest，一定返回true</p> <p>构建VirtualFilterChain，逐个filter进行doFilter</p> <p>VirtualFilterChain中的filter逐个doFilter结束后，执行this.originalChain.doFilter</p> <p>VirtualFilterChain中的doFilter方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentPosition <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>originalChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentPosition<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token class-name">Filter</span> nextFilter <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>additionalFilters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentPosition <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> name <span class="token operator">=</span> nextFilter<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Invoking %s (%d/%d)&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentPosition<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    nextFilter<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><hr> <h1 id="rememberme相关类"><a href="#rememberme相关类" class="header-anchor">#</a> RememberMe相关类</h1> <ul><li>RememberMeAuthenticationFilter</li> <li>RememberMeAuthenticationProvider</li> <li>RememberMeAuthenticationToken</li> <li>RememberMeConfigurer</li> <li>RememberMeServices</li></ul> <p>RememberMe也算一种认证方式，需要cookie认证</p> <h2 id="remembermeauthenticationfilter"><a href="#remembermeauthenticationfilter" class="header-anchor">#</a> RememberMeAuthenticationFilter</h2> <h3 id="属性"><a href="#属性" class="header-anchor">#</a> 属性</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">SecurityContextHolderStrategy</span> securityContextHolderStrategy <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span>
    <span class="token punctuation">.</span><span class="token function">getContextHolderStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">ApplicationEventPublisher</span> eventPublisher<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">AuthenticationSuccessHandler</span> successHandler<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">RememberMeServices</span> rememberMeServices<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">SecurityContextRepository</span> securityContextRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpSessionSecurityContextRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="dofilter方法-2"><a href="#dofilter方法-2" class="header-anchor">#</a> doFilter方法</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
       <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
       <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//如果不等于null，说明已经被认证过，就不需要认证了，退出方法</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span>
          <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;SecurityContextHolder not populated with remember-me token, as it already contained: '&quot;</span>
                <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//1️⃣</span>
    <span class="token class-name">Authentication</span> rememberMeAuth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeServices<span class="token punctuation">.</span><span class="token function">autoLogin</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rememberMeAuth <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// Attempt authentication via AuthenticationManager</span>
       <span class="token keyword">try</span> <span class="token punctuation">{</span>
	       <span class="token comment">//调用authenticate方法，得到一个认证后的Authentication重新赋值给rememberMeAuth</span>
          rememberMeAuth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// Store to SecurityContextHolder</span>

		  <span class="token comment">//创建一个新的context并放入rememberMeAuth，再setContext</span>
          <span class="token class-name">SecurityContext</span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          context<span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">onSuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;SecurityContextHolder populated with remember-me token: '&quot;</span>
                <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//进行持久化</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextRepository<span class="token punctuation">.</span><span class="token function">saveContext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InteractiveAuthenticationSuccessEvent</span><span class="token punctuation">(</span>
                   <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>successHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">this</span><span class="token punctuation">.</span>successHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span>
             <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;SecurityContextHolder not populated with remember-me token, as AuthenticationManager &quot;</span>
                   <span class="token operator">+</span> <span class="token string">&quot;rejected Authentication returned by RememberMeServices: '%s'; &quot;</span>
                   <span class="token operator">+</span> <span class="token string">&quot;invalidating remember-me token&quot;</span><span class="token punctuation">,</span> rememberMeAuth<span class="token punctuation">)</span><span class="token punctuation">,</span>
                ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeServices<span class="token punctuation">.</span><span class="token function">loginFail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//空实现，意味着登录失败不会抛出异常</span>
          <span class="token function">onUnsuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_1️⃣"><a href="#_1️⃣" class="header-anchor">#</a> 1️⃣</h3> <p>this.rememberMeServices：</p> <p><a href="https://sardinary.vercel.app/spring/spring-security-02/#remember-me-services" target="_blank" rel="noopener noreferrer">RememberMeServices<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 类属性</p> <p>autoLogin方法：</p> <p><a href="https://sardinary.vercel.app/spring/spring-security-02/#auto-login" target="_blank" rel="noopener noreferrer">autoLogin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>方法的重要实现类<a href="https://sardinary.vercel.app/spring/spring-security-02/#abstract-remember-me-services" target="_blank" rel="noopener noreferrer">AbstractRememberMeServices<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="remembermeservices"><a href="#remembermeservices" class="header-anchor">#</a> RememberMeServices</h2> <h3 id="作用"><a href="#作用" class="header-anchor">#</a> 作用</h3> <p>通过request拿出信息，构造出一个Authentication，和UsernamePasswordAuthenticationToken类似</p> <p>根据我们的需要构造一个用于rememberMe认证的Authentication</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RememberMeServices</span> <span class="token punctuation">{</span>
	<span class="token comment">//根据请求信息构造Authentication</span>
    <span class="token class-name">Authentication</span> <span class="token function">autoLogin</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">loginFail</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">loginSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
          <span class="token class-name">Authentication</span> successfulAuthentication<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre></div><blockquote><p>The returned Authentication must be acceptable to org.springframework.security.authentication.AuthenticationManager or org.springframework.security.authentication.AuthenticationProvider defined by the web application. It is recommended org.springframework.security.authentication.RememberMeAuthenticationToken be used in most cases, as it has a corresponding authentication provider</p></blockquote> <p>建议返回一个<a href="https://sardinary.vercel.app/spring/spring-security-02/#remember-me-authentication-token" target="_blank" rel="noopener noreferrer">RememberMeAuthenticationToken<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="实现类"><a href="#实现类" class="header-anchor">#</a> 实现类</h3> <p><img src="/Sardinary/assets/img/Untitled16.b07fc0a1.png" alt="Untitled"></p> <h2 id="remembermeauthenticationprovider"><a href="#remembermeauthenticationprovider" class="header-anchor">#</a> RememberMeAuthenticationProvider</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">supports</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RememberMeAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKeyHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;RememberMeAuthenticationProvider.incorrectKey&quot;</span><span class="token punctuation">,</span>
             <span class="token string">&quot;The presented RememberMeAuthenticationToken does not contain the expected key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> authentication<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>该authenticate方法未进行重要逻辑</p> <h2 id="remembermeauthenticationtoken"><a href="#remembermeauthenticationtoken" class="header-anchor">#</a> RememberMeAuthenticationToken</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RememberMeAuthenticationToken</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAuthenticationToken</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token class-name">SpringSecurityCoreVersion</span><span class="token punctuation">.</span><span class="token constant">SERIAL_VERSION_UID</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> principal<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> keyHash<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RememberMeAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> principal<span class="token punctuation">,</span>
          <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">super</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>principal <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>principal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot pass null or empty values to constructor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>keyHash <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
       <span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">RememberMeAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> keyHash<span class="token punctuation">,</span> <span class="token class-name">Object</span> principal<span class="token punctuation">,</span>
          <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">super</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>keyHash <span class="token operator">=</span> keyHash<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
       <span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getKeyHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>keyHash<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>principal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">RememberMeAuthenticationToken</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">RememberMeAuthenticationToken</span> other <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RememberMeAuthenticationToken</span><span class="token punctuation">)</span> obj<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getKeyHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> other<span class="token punctuation">.</span><span class="token function">getKeyHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       result <span class="token operator">=</span> <span class="token number">31</span> <span class="token operator">*</span> result <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>keyHash<span class="token punctuation">;</span>
       <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><p>和UsernamePasswordAuthenticationToken一样是AbstractAuthenticationToken的实现类</p> <h2 id="abstractremembermeservices"><a href="#abstractremembermeservices" class="header-anchor">#</a> AbstractRememberMeServices</h2> <h3 id="autologin方法"><a href="#autologin方法" class="header-anchor">#</a> autoLogin方法</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">autoLogin</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//拿到cookie</span>
    <span class="token class-name">String</span> rememberMeCookie <span class="token operator">=</span> <span class="token number">1</span>️⃣<span class="token function">extractRememberMeCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rememberMeCookie <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Remember-me cookie detected&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rememberMeCookie<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie was empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token number">2</span>️⃣<span class="token function">cancelCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
	    <span class="token comment">//解码</span>
       <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookieTokens <span class="token operator">=</span> <span class="token number">3</span>️⃣<span class="token function">decodeCookie</span><span class="token punctuation">(</span>rememberMeCookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">UserDetails</span> user <span class="token operator">=</span> <span class="token number">4</span>️⃣<span class="token function">processAutoLoginCookie</span><span class="token punctuation">(</span>cookieTokens<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>userDetailsChecker<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Remember-me cookie accepted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token function">createSuccessfulAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CookieTheftException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">cancelCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UsernameNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Remember-me login was valid but corresponding user not found.&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvalidCookieException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid remember-me cookie: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AccountStatusException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid UserDetails: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RememberMeAuthenticationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">cancelCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_1️⃣extractremembermecookie"><a href="#_1️⃣extractremembermecookie" class="header-anchor">#</a> 1️⃣extractRememberMeCookie</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">extractRememberMeCookie</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Cookie</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookies <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cookies <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>cookies<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Cookie</span> cookie <span class="token operator">:</span> cookies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cookieName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cookie<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> cookie<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>其中this.cookieName为属性：</p> <p>private String cookieName = SPRING_SECURITY_REMEMBER_ME_COOKIE_KEY;</p> <h3 id="_2️⃣cancelcookie"><a href="#_2️⃣cancelcookie" class="header-anchor">#</a> 2️⃣cancelCookie</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">cancelCookie</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Cancelling cookie&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cookieName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token function">getCookiePath</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cookieDomain <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       cookie<span class="token punctuation">.</span><span class="token function">setDomain</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cookieDomain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    cookie<span class="token punctuation">.</span><span class="token function">setSecure</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>useSecureCookie <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>useSecureCookie <span class="token operator">:</span> request<span class="token punctuation">.</span><span class="token function">isSecure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>A positive value indicates that the cookie will expire after that many seconds have passed. Note that the value is the maximum age when the cookie will expire, not the cookie's current age.</p> <p>A negative value means that the cookie is not stored persistently and will be deleted when the Web browser exits. A zero value causes the cookie to be deleted.</p> <p>cookie.setMaxAge(0)：设置为0代表删除cookie</p> <h3 id="_3️⃣decodecookie"><a href="#_3️⃣decodecookie" class="header-anchor">#</a> 3️⃣decodeCookie</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">decodeCookie</span><span class="token punctuation">(</span><span class="token class-name">String</span> cookieValue<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InvalidCookieException</span> <span class="token punctuation">{</span>
	<span class="token comment">//修复base64编码被抹掉的等号</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> cookieValue<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       cookieValue <span class="token operator">=</span> cookieValue <span class="token operator">+</span> <span class="token string">&quot;=&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> cookieAsPlainText<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
       cookieAsPlainText <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>cookieValue<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidCookieException</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie token was not Base64 encoded; value was '&quot;</span> <span class="token operator">+</span> cookieValue <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tokens <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">delimitedListToStringArray</span><span class="token punctuation">(</span>cookieAsPlainText<span class="token punctuation">,</span> <span class="token constant">DELIMITER</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//通过冒号分割</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tokens<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">try</span> <span class="token punctuation">{</span>
          tokens<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">URLDecoder</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>tokens<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> tokens<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_4️⃣processautologincookie"><a href="#_4️⃣processautologincookie" class="header-anchor">#</a> 4️⃣processAutoLoginCookie</h3> <p>在本类中该方法为抽象方法</p> <p>实现类：</p> <p><img src="/Sardinary/assets/img/Untitled17.06b88cd9.png" alt="Untitled"></p> <p>第一个基于数据库，第二个基于内存</p> <p>在TokenBasedRememberMeServices中的实现：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">UserDetails</span> <span class="token function">processAutoLoginCookie</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookieTokens<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
       <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//判断cookie长度</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isValidCookieTokensLength</span><span class="token punctuation">(</span>cookieTokens<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidCookieException</span><span class="token punctuation">(</span>
             <span class="token string">&quot;Cookie token did not contain 3 or 4 tokens, but contained '&quot;</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>cookieTokens<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">long</span> tokenExpiryTime <span class="token operator">=</span> <span class="token function">getTokenExpiryTime</span><span class="token punctuation">(</span>cookieTokens<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTokenExpired</span><span class="token punctuation">(</span>tokenExpiryTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//判断cookie是否过期</span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidCookieException</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie token[1] has expired (expired on '&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>tokenExpiryTime<span class="token punctuation">)</span>
             <span class="token operator">+</span> <span class="token string">&quot;'; current time is '&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;')&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Check the user exists. Defer lookup until after expiry time checked, to</span>
    <span class="token comment">// possibly avoid expensive database call.    UserDetails userDetails = getUserDetailsService().loadUserByUsername(cookieTokens[0]);</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;UserDetailsService &quot;</span> <span class="token operator">+</span> <span class="token function">getUserDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">+</span> <span class="token string">&quot; returned null for username &quot;</span> <span class="token operator">+</span> cookieTokens<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">&quot;. &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;This is an interface contract violation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Check signature of token matches remaining details. Must do this after user</span>
    <span class="token comment">// lookup, as we need the DAO-derived password. If efficiency was a major issue,    // just add in a UserCache implementation, but recall that this method is usually    // only called once per HttpSession - if the token is valid, it will cause    // SecurityContextHolder population, whilst if invalid, will cause the cookie to    // be cancelled.    String actualTokenSignature = cookieTokens[2];</span>
    <span class="token class-name">RememberMeTokenAlgorithm</span> actualAlgorithm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>matchingAlgorithm<span class="token punctuation">;</span>
    <span class="token comment">// If the cookie value contains the algorithm, we use that algorithm to check the</span>
    <span class="token comment">// signature    if (cookieTokens.length == 4) {</span>
       actualTokenSignature <span class="token operator">=</span> cookieTokens<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
       actualAlgorithm <span class="token operator">=</span> <span class="token class-name">RememberMeTokenAlgorithm</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>cookieTokens<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//生成一个signature，并于cookie中自带的signature比对</span>
    <span class="token class-name">String</span> expectedTokenSignature <span class="token operator">=</span> <span class="token function">makeTokenSignature</span><span class="token punctuation">(</span>tokenExpiryTime<span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> actualAlgorithm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">equals</span><span class="token punctuation">(</span>expectedTokenSignature<span class="token punctuation">,</span> actualTokenSignature<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidCookieException</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie contained signature '&quot;</span> <span class="token operator">+</span> actualTokenSignature <span class="token operator">+</span> <span class="token string">&quot;' but expected '&quot;</span>
             <span class="token operator">+</span> expectedTokenSignature <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> userDetails<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="remembermeconfigurer"><a href="#remembermeconfigurer" class="header-anchor">#</a> RememberMeConfigurer</h2> <p>重要方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token function">validateInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RememberMeServices</span> rememberMeServices <span class="token operator">=</span> <span class="token function">getRememberMeServices</span><span class="token punctuation">(</span>http<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    http<span class="token punctuation">.</span><span class="token function">setSharedObject</span><span class="token punctuation">(</span><span class="token class-name">RememberMeServices</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> rememberMeServices<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LogoutConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">H</span><span class="token punctuation">&gt;</span></span> logoutConfigurer <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getConfigurer</span><span class="token punctuation">(</span><span class="token class-name">LogoutConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logoutConfigurer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logoutHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       logoutConfigurer<span class="token punctuation">.</span><span class="token function">addLogoutHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logoutHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">RememberMeAuthenticationProvider</span> authenticationProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RememberMeAuthenticationProvider</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    authenticationProvider <span class="token operator">=</span> <span class="token function">postProcess</span><span class="token punctuation">(</span>authenticationProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
    http<span class="token punctuation">.</span><span class="token function">authenticationProvider</span><span class="token punctuation">(</span>authenticationProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initDefaultLoginFilter</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//创建过滤器，加入到过滤器链</span>
    <span class="token class-name">RememberMeAuthenticationFilter</span> rememberMeFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RememberMeAuthenticationFilter</span><span class="token punctuation">(</span>
          http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rememberMeServices<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationSuccessHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       rememberMeFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationSuccessHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationSuccessHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">SecurityContextConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> securityContextConfigurer <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getConfigurer</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>securityContextConfigurer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> securityContextConfigurer<span class="token punctuation">.</span><span class="token function">isRequireExplicitSave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">SecurityContextRepository</span> securityContextRepository <span class="token operator">=</span> securityContextConfigurer
          <span class="token punctuation">.</span><span class="token function">getSecurityContextRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       rememberMeFilter<span class="token punctuation">.</span><span class="token function">setSecurityContextRepository</span><span class="token punctuation">(</span>securityContextRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    rememberMeFilter<span class="token punctuation">.</span><span class="token function">setSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token function">getSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rememberMeFilter <span class="token operator">=</span> <span class="token function">postProcess</span><span class="token punctuation">(</span>rememberMeFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>rememberMeFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>剩下的其他方法大多数是给使用者提供自定义属性的方法</p> <p><a href="http://xn--confighttp-0t2pq24a34f2p4dqsyd76t.xxx/" target="_blank" rel="noopener noreferrer">即config类中所写的http.xxx<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>()</p> <h1 id="session相关类"><a href="#session相关类" class="header-anchor">#</a> Session相关类</h1> <ul><li>SessionManagementConfigurer</li> <li>SessionManagementFilter</li> <li>SessionAuthenticationStrategy</li> <li>SessionInformation</li> <li>SessionRegistry</li> <li>SessionInformationExpiredStrategy</li></ul> <h2 id="sessionmanagementfilter"><a href="#sessionmanagementfilter" class="header-anchor">#</a> SessionManagementFilter</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
       <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
       <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">FILTER_APPLIED</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityContextRepository<span class="token punctuation">.</span><span class="token function">containsContext</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>authentication <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>trustResolver<span class="token punctuation">.</span><span class="token function">isAnonymous</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
             <span class="token number">1</span>️⃣<span class="token keyword">this</span><span class="token punctuation">.</span>sessionAuthenticationStrategy<span class="token punctuation">.</span><span class="token function">onAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SessionAuthenticationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//抛出异常，失败处理</span>
             <span class="token comment">// The session strategy can reject the authentication</span>
             <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;SessionAuthenticationStrategy rejected the authentication object&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">this</span><span class="token punctuation">.</span>failureHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">return</span><span class="token punctuation">;</span>
	      <span class="token punctuation">}</span>
		  <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextRepository<span class="token punctuation">.</span>saveContext
		  <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//保存</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getRequestedSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">isRequestedSessionIdValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Request requested invalid session id %s&quot;</span><span class="token punctuation">,</span>
                      request<span class="token punctuation">.</span><span class="token function">getRequestedSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>invalidSessionStrategy <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>invalidSessionStrategy<span class="token punctuation">.</span><span class="token function">onInvalidSessionDetected</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>重要方法：1️⃣this.<a href="https://sardinary.vercel.app/spring/spring-security-02/#session-authentication-strategy" target="_blank" rel="noopener noreferrer">sessionAuthenticationStrategy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> .onAuthentication</p> <h2 id="sessionauthenticationstrategy"><a href="#sessionauthenticationstrategy" class="header-anchor">#</a> SessionAuthenticationStrategy</h2> <p>一个策略类的接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SessionAuthenticationStrategy</span> <span class="token punctuation">{</span>

    <span class="token keyword">void</span> <span class="token function">onAuthentication</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span>
          <span class="token keyword">throws</span> <span class="token class-name">SessionAuthenticationException</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre></div><p>实现类有：</p> <p><img src="/Sardinary/assets/img/Untitled18.1a90a2c6.png" alt="Untitled"></p> <h3 id="实现类registersessionauthenticationstrategy"><a href="#实现类registersessionauthenticationstrategy" class="header-anchor">#</a> 实现类RegisterSessionAuthenticationStrategy</h3> <p>Strategy used to register a user with the SessionRegistry after successful Authentication.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegisterSessionAuthenticationStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">SessionAuthenticationStrategy</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SessionRegistry</span> sessionRegistry<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RegisterSessionAuthenticationStrategy</span><span class="token punctuation">(</span><span class="token class-name">SessionRegistry</span> sessionRegistry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>sessionRegistry<span class="token punctuation">,</span> <span class="token string">&quot;The sessionRegistry cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>sessionRegistry <span class="token operator">=</span> sessionRegistry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

     <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthentication</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
          <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//注册一个新的session</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>sessionRegistry<span class="token punctuation">.</span><span class="token function">registerNewSession</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="实现类concurrentsessioncontrolauthenticationstrategy"><a href="#实现类concurrentsessioncontrolauthenticationstrategy" class="header-anchor">#</a> 实现类ConcurrentSessionControlAuthenticationStrategy</h3> <p>onAuthentication方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthentication</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
       <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> allowedSessions <span class="token operator">=</span> <span class="token function">getMaximumSessionsForThisUser</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>allowedSessions <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// We permit unlimited logins</span>
       <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//根据principle信息拿到所有的session，bool属性为是否包括过期session</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SessionInformation</span><span class="token punctuation">&gt;</span></span> sessions <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sessionRegistry<span class="token punctuation">.</span><span class="token function">getAllSessions</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> sessionCount <span class="token operator">=</span> sessions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionCount <span class="token operator">&lt;</span> allowedSessions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// They haven't got too many login sessions running at present</span>
       <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionCount <span class="token operator">==</span> allowedSessions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//false表示如果session不存在不会去创建</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Only permit it though if this request is associated with one of the</span>
          <span class="token comment">// already registered sessions</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SessionInformation</span> si <span class="token operator">:</span> sessions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token punctuation">.</span><span class="token function">getSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token comment">//如果sessions中没有改session，则说明改session可能是新的session，但是由于sessionCount已经到达允许的最大值了，再加入新的会超出最大值。于是调用allowableSessionsExceeded方法</span>
       <span class="token punctuation">}</span>
       <span class="token comment">// If the session is null, a new one will be created by the parent class,</span>
       <span class="token comment">// exceeding the allowed number</span>
    <span class="token punctuation">}</span>
    <span class="token function">allowableSessionsExceeded</span><span class="token punctuation">(</span>sessions<span class="token punctuation">,</span> allowedSessions<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sessionRegistry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>allowableSessionsExceeded方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">allowableSessionsExceeded</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SessionInformation</span><span class="token punctuation">&gt;</span></span> sessions<span class="token punctuation">,</span> <span class="token keyword">int</span> allowableSessions<span class="token punctuation">,</span>
       <span class="token class-name">SessionRegistry</span> registry<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SessionAuthenticationException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>exceptionIfMaximumExceeded <span class="token operator">||</span> <span class="token punctuation">(</span>sessions <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SessionAuthenticationException</span><span class="token punctuation">(</span>
             <span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;ConcurrentSessionControlAuthenticationStrategy.exceededAllowed&quot;</span><span class="token punctuation">,</span>
                   <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> allowableSessions <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Maximum sessions of {0} for this principal exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Determine least recently used sessions, and mark them for invalidation</span>
    sessions<span class="token punctuation">.</span>sortgetLastRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> maximumSessionsExceededBy <span class="token operator">=</span> sessions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> allowableSessions <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SessionInformation</span><span class="token punctuation">&gt;</span></span> sessionsToBeExpired <span class="token operator">=</span> sessions<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> maximumSessionsExceededBy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SessionInformation</span> session <span class="token operator">:</span> sessionsToBeExpired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       session<span class="token punctuation">.</span><span class="token function">expireNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>如果不抛异常，即不进if语句，则会把session按照时间排序，将最老的的session标记为过期，然后加入新的session</p> <h3 id="实现类compositesessionauthenticationstrategy"><a href="#实现类compositesessionauthenticationstrategy" class="header-anchor">#</a> 实现类CompositeSessionAuthenticationStrategy</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompositeSessionAuthenticationStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">SessionAuthenticationStrategy</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> logger <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SessionAuthenticationStrategy</span><span class="token punctuation">&gt;</span></span> delegateStrategies<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">CompositeSessionAuthenticationStrategy</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SessionAuthenticationStrategy</span><span class="token punctuation">&gt;</span></span> delegateStrategies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span>delegateStrategies<span class="token punctuation">,</span> <span class="token string">&quot;delegateStrategies cannot be null or empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SessionAuthenticationStrategy</span> strategy <span class="token operator">:</span> delegateStrategies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>strategy<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;delegateStrategies cannot contain null entires. Got &quot;</span> <span class="token operator">+</span> delegateStrategies<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>delegateStrategies <span class="token operator">=</span> delegateStrategies<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthentication</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
          <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SessionAuthenticationException</span> <span class="token punctuation">{</span>
       <span class="token keyword">int</span> currentPosition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
       <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegateStrategies<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SessionAuthenticationStrategy</span> delegate <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegateStrategies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Preparing session with %s (%d/%d)&quot;</span><span class="token punctuation">,</span>
                   delegate<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">++</span>currentPosition<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          delegate<span class="token punctuation">.</span><span class="token function">onAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; [delegateStrategies = &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegateStrategies <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><p>有属性List&lt;\SessionAuthenticationStrategy&gt; delegateStrategies</p> <p>维护了一堆的SessionAuthenticationStrategy</p> <p>再调用该类的onAuthentication方法时会逐个调用delegateStrategies中元素的onAuthentication方法</p> <p>从而实现多策略的组合模式</p> <h3 id="实现类abstractsessionfixationprotectionstrategy"><a href="#实现类abstractsessionfixationprotectionstrategy" class="header-anchor">#</a> 实现类AbstractSessionFixationProtectionStrategy</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthentication</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
       <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> hadSessionAlready <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadSessionAlready <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>alwaysCreateSession<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// Session fixation isn't a problem if there's no session</span>
       <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Create new session if necessary</span>
    <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hadSessionAlready <span class="token operator">&amp;&amp;</span> request<span class="token punctuation">.</span><span class="token function">isRequestedSessionIdValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> originalSessionId<span class="token punctuation">;</span>
       <span class="token class-name">String</span> newSessionId<span class="token punctuation">;</span>
       <span class="token class-name">Object</span> mutex <span class="token operator">=</span> <span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token function">getSessionMutex</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mutex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// We need to migrate to a new session</span>
          originalSessionId <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//得到一个新的sessionId</span>
          session <span class="token operator">=</span> <span class="token function">applySessionFixation</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
          newSessionId <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>originalSessionId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>newSessionId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Your servlet container did not change the session ID when a new session &quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;was created. You will not be adequately protected against session-fixation attacks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Changed session id from %s&quot;</span><span class="token punctuation">,</span> originalSessionId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
       <span class="token function">onSessionChange</span><span class="token punctuation">(</span>originalSessionId<span class="token punctuation">,</span> session<span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>通过定期改变sessionId来防止固定会话攻击</p> <h3 id="applysessionfixation方法"><a href="#applysessionfixation方法" class="header-anchor">#</a> applySessionFixation方法</h3> <div class="language- extra-class"><pre class="language-text"><code>abstract HttpSession applySessionFixation(HttpServletRequest request);

</code></pre></div><p><img src="/Sardinary/assets/img/Untitled19.13b46f20.png" alt="Untitled"></p> <p>模版方法，有两个实现</p> <h3 id="changesessionidauthenticationstrategy中的实现"><a href="#changesessionidauthenticationstrategy中的实现" class="header-anchor">#</a> ChangeSessionIdAuthenticationStrategy中的实现</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ChangeSessionIdAuthenticationStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSessionFixationProtectionStrategy</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token class-name">HttpSession</span> <span class="token function">applySessionFixation</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       request<span class="token punctuation">.</span><span class="token function">changeSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><p>直接改变sessionId，不用把session销毁也不会创建新的session对象，即session对象不会改变</p> <h3 id="sessionfixationprotectionstrategy中的实现"><a href="#sessionfixationprotectionstrategy中的实现" class="header-anchor">#</a> SessionFixationProtectionStrategy中的实现</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">final</span> <span class="token class-name">HttpSession</span> <span class="token function">applySessionFixation</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> originalSessionId <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Invalidating session with Id '&quot;</span> <span class="token operator">+</span> originalSessionId <span class="token operator">+</span> <span class="token string">&quot;' &quot;</span>
          <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>migrateSessionAttributes <span class="token operator">?</span> <span class="token string">&quot;and&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;without&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; migrating attributes.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attributesToMigrate <span class="token operator">=</span> <span class="token function">extractAttributes</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> maxInactiveIntervalToMigrate <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getMaxInactiveInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    session<span class="token punctuation">.</span><span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//属性为true，即创建一个新的session</span>
    session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// we now have a new session</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Started new session: %s&quot;</span><span class="token punctuation">,</span> session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">transferAttributes</span><span class="token punctuation">(</span>attributesToMigrate<span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>migrateSessionAttributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       session<span class="token punctuation">.</span><span class="token function">setMaxInactiveInterval</span><span class="token punctuation">(</span>maxInactiveIntervalToMigrate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> session<span class="token punctuation">;</span>  <span class="token comment">//返回新的session</span>
<span class="token punctuation">}</span>

</code></pre></div><p>创建了新的session从而改变sessionId</p> <h2 id="sessionregistry"><a href="#sessionregistry" class="header-anchor">#</a> SessionRegistry</h2> <p>存储SessionInformation</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SessionRegistry</span> <span class="token punctuation">{</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllPrincipals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SessionInformation</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllSessions</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token keyword">boolean</span> includeExpiredSessions<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SessionInformation</span> <span class="token function">getSessionInformation</span><span class="token punctuation">(</span><span class="token class-name">String</span> sessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">refreshLastRequest</span><span class="token punctuation">(</span><span class="token class-name">String</span> sessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">registerNewSession</span><span class="token punctuation">(</span><span class="token class-name">String</span> sessionId<span class="token punctuation">,</span> <span class="token class-name">Object</span> principal<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">removeSessionInformation</span><span class="token punctuation">(</span><span class="token class-name">String</span> sessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre></div><p>仅有一个实现类SessionRegistryImpl</p> <h2 id="sessioninformation"><a href="#sessioninformation" class="header-anchor">#</a> SessionInformation</h2> <p>维护了一些基本信息</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SessionInformation</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token class-name">SpringSecurityCoreVersion</span><span class="token punctuation">.</span><span class="token constant">SERIAL_VERSION_UID</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Date</span> lastRequest<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> principal<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> sessionId<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> expired <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SessionInformation</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">String</span> sessionId<span class="token punctuation">,</span> <span class="token class-name">Date</span> lastRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>principal<span class="token punctuation">,</span> <span class="token string">&quot;Principal required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>sessionId<span class="token punctuation">,</span> <span class="token string">&quot;SessionId required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>lastRequest<span class="token punctuation">,</span> <span class="token string">&quot;LastRequest required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>sessionId <span class="token operator">=</span> sessionId<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>lastRequest <span class="token operator">=</span> lastRequest<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">expireNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>expired <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">getLastRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastRequest<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>principal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sessionId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expired<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//每次刷新</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refreshLastRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>lastRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h2 id="sessioninformationexpiredstrategy"><a href="#sessioninformationexpiredstrategy" class="header-anchor">#</a> SessionInformationExpiredStrategy</h2> <div class="language- extra-class"><pre class="language-text"><code>/**
 * Determines the behaviour of the ConcurrentSessionFilter when an expired session is detected in the ConcurrentSessionFilter. */

	public interface SessionInformationExpiredStrategy {
    void onExpiredSessionDetected(SessionInformationExpiredEvent event) throws IOException, ServletException;

}

</code></pre></div><p>决定<a href="https://sardinary.vercel.app/spring/spring-security-02/#concurrent-session-filter" target="_blank" rel="noopener noreferrer">ConcurrentSessionFilter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的过期策略</p> <h3 id="onexpiredsessiondetected方法"><a href="#onexpiredsessiondetected方法" class="header-anchor">#</a> onExpiredSessionDetected方法</h3> <p><img src="/Sardinary/assets/img/Untitled20.18a23d5a.png" alt="Untitled"></p> <h3 id="responsebodysessioninformationexpiredstrategy中的实现"><a href="#responsebodysessioninformationexpiredstrategy中的实现" class="header-anchor">#</a> ResponseBodySessionInformationExpiredStrategy中的实现</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ResponseBodySessionInformationExpiredStrategy</span>
       <span class="token keyword">implements</span> <span class="token class-name">SessionInformationExpiredStrategy</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onExpiredSessionDetected</span><span class="token punctuation">(</span><span class="token class-name">SessionInformationExpiredEvent</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
       <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;This session has been expired (possibly due to multiple concurrent &quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;logins being attempted as the same user).&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       response<span class="token punctuation">.</span><span class="token function">flushBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h3 id="simpleredirectsessioninformationexpiredstrategy中的实现"><a href="#simpleredirectsessioninformationexpiredstrategy中的实现" class="header-anchor">#</a> SimpleRedirectSessionInformationExpiredStrategy中的实现</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SimpleRedirectSessionInformationExpiredStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">SessionInformationExpiredStrategy</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> logger <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> destinationUrl<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RedirectStrategy</span> redirectStrategy<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SimpleRedirectSessionInformationExpiredStrategy</span><span class="token punctuation">(</span><span class="token class-name">String</span> invalidSessionUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">(</span>invalidSessionUrl<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedirectStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">SimpleRedirectSessionInformationExpiredStrategy</span><span class="token punctuation">(</span><span class="token class-name">String</span> invalidSessionUrl<span class="token punctuation">,</span>
          <span class="token class-name">RedirectStrategy</span> redirectStrategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token class-name">UrlUtils</span><span class="token punctuation">.</span><span class="token function">isValidRedirectUrl</span><span class="token punctuation">(</span>invalidSessionUrl<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;url must start with '/' or with 'http(s)'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>destinationUrl <span class="token operator">=</span> invalidSessionUrl<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>redirectStrategy <span class="token operator">=</span> redirectStrategy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onExpiredSessionDetected</span><span class="token punctuation">(</span><span class="token class-name">SessionInformationExpiredEvent</span> event<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Redirecting to '&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>destinationUrl <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>redirectStrategy<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>destinationUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h3 id="this-redirectstrategy-sendredirect"><a href="#this-redirectstrategy-sendredirect" class="header-anchor">#</a> this.redirectStrategy.sendRedirect</h3> <p>重定向策略接口RedirectStrategy</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RedirectStrategy</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Performs a redirect to the supplied URL     * @param request the current request
     * @param response the response to redirect
     * @param url the target URL to redirect to, for example &quot;/login&quot;
     */</span>
     <span class="token keyword">void</span> <span class="token function">sendRedirect</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre></div><p>默认实现类为DefaultRedirectStrategy</p> <h3 id="concurrentsessionfilter"><a href="#concurrentsessionfilter" class="header-anchor">#</a> ConcurrentSessionFilter</h3> <p>doFilter方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
       <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
       <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token comment">//通过sessionRegistry.getSessionInformation得到session信息</span>
       <span class="token class-name">SessionInformation</span> info <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sessionRegistry<span class="token punctuation">.</span><span class="token function">getSessionInformation</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>info <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token comment">// Expired - abort processing</span>
             <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span>
                <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Requested session ID &quot;</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getRequestedSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; has expired.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token function">doLogout</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token comment">//2️⃣</span>
             <span class="token keyword">this</span><span class="token punctuation">.</span>sessionInformationExpiredStrategy
                <span class="token punctuation">.</span><span class="token function">onExpiredSessionDetected</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SessionInformationExpiredEvent</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// Non-expired - update last request date/time</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>sessionRegistry<span class="token punctuation">.</span><span class="token function">refreshLastRequest</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>2️⃣this.sessionInformationExpiredStrategy.onExpiredSessionDetected</p> <p>如果过期，就调用策略类的处理过期的方法onExpiredSessionDetected，该方法由其实现类具体实现</p> <h2 id="sessionmanagementconfigurer"><a href="#sessionmanagementconfigurer" class="header-anchor">#</a> SessionManagementConfigurer</h2> <p><img src="/Sardinary/assets/img/Untitled21.683115f4.png" alt="Untitled"></p> <p>重要方法：init和configure</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//set一些属性</span>
    <span class="token class-name">SecurityContextRepository</span> securityContextRepository <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextRepository</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> stateless <span class="token operator">=</span> <span class="token function">isStateless</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>securityContextRepository <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>stateless<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          http<span class="token punctuation">.</span><span class="token function">setSharedObject</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextRepository</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RequestAttributeSecurityContextRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>sessionManagementSecurityContextRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NullSecurityContextRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token class-name">HttpSessionSecurityContextRepository</span> httpSecurityRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpSessionSecurityContextRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          httpSecurityRepository<span class="token punctuation">.</span><span class="token function">setDisableUrlRewriting</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>enableSessionUrlRewriting<span class="token punctuation">)</span><span class="token punctuation">;</span>
          httpSecurityRepository<span class="token punctuation">.</span><span class="token function">setAllowSessionCreation</span><span class="token punctuation">(</span><span class="token function">isAllowSessionCreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name">AuthenticationTrustResolver</span> trustResolver <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationTrustResolver</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>trustResolver <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             httpSecurityRepository<span class="token punctuation">.</span><span class="token function">setTrustResolver</span><span class="token punctuation">(</span>trustResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>sessionManagementSecurityContextRepository <span class="token operator">=</span> httpSecurityRepository<span class="token punctuation">;</span>
          <span class="token class-name">DelegatingSecurityContextRepository</span> defaultRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelegatingSecurityContextRepository</span><span class="token punctuation">(</span>
                httpSecurityRepository<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RequestAttributeSecurityContextRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          http<span class="token punctuation">.</span><span class="token function">setSharedObject</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextRepository</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> defaultRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>sessionManagementSecurityContextRepository <span class="token operator">=</span> securityContextRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">RequestCache</span> requestCache <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">getSharedObject</span><span class="token punctuation">(</span><span class="token class-name">RequestCache</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCache <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>stateless<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          http<span class="token punctuation">.</span><span class="token function">setSharedObject</span><span class="token punctuation">(</span><span class="token class-name">RequestCache</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NullRequestCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    http<span class="token punctuation">.</span><span class="token function">setSharedObject</span><span class="token punctuation">(</span><span class="token class-name">SessionAuthenticationStrategy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token function">getSessionAuthenticationStrategy</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    http<span class="token punctuation">.</span><span class="token function">setSharedObject</span><span class="token punctuation">(</span><span class="token class-name">InvalidSessionStrategy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token function">getInvalidSessionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">H</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//添加sessoin相关的filter</span>
    <span class="token class-name">SessionManagementFilter</span> sessionManagementFilter <span class="token operator">=</span> <span class="token function">createSessionManagementFilter</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionManagementFilter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>sessionManagementFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isConcurrentSessionControlEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">ConcurrentSessionFilter</span> concurrentSessionFilter <span class="token operator">=</span> <span class="token function">createConcurrencyFilter</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>

       concurrentSessionFilter <span class="token operator">=</span> <span class="token function">postProcess</span><span class="token punctuation">(</span>concurrentSessionFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
       http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>concurrentSessionFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>enableSessionUrlRewriting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DisableEncodeUrlFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sessionPolicy <span class="token operator">==</span> <span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span><span class="token constant">ALWAYS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ForceEagerSessionCreationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><hr> <h1 id="一些filter"><a href="#一些filter" class="header-anchor">#</a> 一些Filter</h1> <p>DefaultSecurityFilterChain中的filter包含：</p> <p><img src="/Sardinary/assets/img/Untitled22.36d0462e.png" alt="Untitled"></p> <h2 id="disableencodeurlfilter"><a href="#disableencodeurlfilter" class="header-anchor">#</a> DisableEncodeUrlFilter</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DisableEncodeUrlFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
          <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
       filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token number">1</span>️⃣<span class="token class-name">DisableEncodeUrlResponseWrapper</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h3 id="_1️⃣disableencodeurlresponsewrapper"><a href="#_1️⃣disableencodeurlresponsewrapper" class="header-anchor">#</a> 1️⃣DisableEncodeUrlResponseWrapper</h3> <p>new DisableEncodeUrlResponseWrapper(response)：</p> <p>该参数是一个response的包装</p> <p><img src="/Sardinary/assets/img/Untitled23.661ce189.png" alt="Untitled"></p> <div class="language-java extra-class"><pre class="language-java"><code>	  <span class="token comment">//1️⃣</span>
      <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">DisableEncodeUrlResponseWrapper</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServletResponseWrapper</span> <span class="token punctuation">{</span>

       <span class="token keyword">private</span> <span class="token class-name">DisableEncodeUrlResponseWrapper</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">super</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token annotation punctuation">@Override</span>
       <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">encodeRedirectURL</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> url<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

		<span class="token comment">//2️⃣把sessionId编码到url中</span>
       <span class="token annotation punctuation">@Override</span>
       <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">encodeURL</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> url<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

</code></pre></div><blockquote><p>装饰器模式：类中先维护一份被装饰的对象，然后实现被装饰对象的方法，最后默认调用被装饰对象的同名方法</p> <p>比如该类的父类HttpServletResponseWrapper，还有HttpServletRequestWrapper</p></blockquote> <h3 id="_2️⃣encodeurl"><a href="#_2️⃣encodeurl" class="header-anchor">#</a> 2️⃣encodeURL</h3> <p>在HttpServletResponse中的声明：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 Encodes the specified URL by including the session ID in it, or, if encoding is not needed, returns the URL unchanged. The implementation of this method includes the logic to determine whether the session ID needs to be encoded in the URL. For example, if the browser supports cookies, or session tracking is turned off, URL encoding is unnecessary.
For robust session tracking, all URLs emitted by a servlet should be run through this method. Otherwise, URL rewriting cannot be used with browsers which do not support cookies.
Params:
url – the url to be encoded.
Returns:
the encoded URL if encoding is needed; the unchanged URL otherwise. */</span>
	<span class="token class-name">String</span> <span class="token function">encodeURL</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>如果有sessionId，就将sessionId包含在url中并返回；如果没有sessionId，就直接返回url</p> <p>而本类直接重写了encodeURL方法，直接返回url</p> <p><strong>所以DisableEncodeUrlFilter的作用就是让这些包含sessionId到url的方法失效</strong></p> <h2 id="webasyncmanagerintegrationfilter"><a href="#webasyncmanagerintegrationfilter" class="header-anchor">#</a> WebAsyncManagerIntegrationFilter</h2> <p>管理异步执行，在异步执行之前把SecurityContext放进去</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WebAsyncManagerIntegrationFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> <span class="token constant">CALLABLE_INTERCEPTOR_KEY</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">SecurityContextHolderStrategy</span> securityContextHolderStrategy <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span>
       <span class="token punctuation">.</span><span class="token function">getContextHolderStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
          <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
       <span class="token class-name">WebAsyncManager</span> asyncManager <span class="token operator">=</span> <span class="token class-name">WebAsyncUtils</span><span class="token punctuation">.</span><span class="token function">getAsyncManager</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">SecurityContextCallableProcessingInterceptor</span> securityProcessingInterceptor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SecurityContextCallableProcessingInterceptor</span><span class="token punctuation">)</span> asyncManager
          <span class="token punctuation">.</span><span class="token function">getCallableInterceptor</span><span class="token punctuation">(</span><span class="token constant">CALLABLE_INTERCEPTOR_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>securityProcessingInterceptor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">SecurityContextCallableProcessingInterceptor</span> interceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecurityContextCallableProcessingInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//1️⃣</span>
          interceptor<span class="token punctuation">.</span><span class="token function">setSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
          asyncManager<span class="token punctuation">.</span><span class="token function">registerCallableInterceptor</span><span class="token punctuation">(</span><span class="token constant">CALLABLE_INTERCEPTOR_KEY</span><span class="token punctuation">,</span> interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextHolderStrategy</span> securityContextHolderStrategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>securityContextHolderStrategy<span class="token punctuation">,</span> <span class="token string">&quot;securityContextHolderStrategy cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy <span class="token operator">=</span> securityContextHolderStrategy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h3 id="_1️⃣securitycontextcallableprocessinginterceptor"><a href="#_1️⃣securitycontextcallableprocessinginterceptor" class="header-anchor">#</a> 1️⃣SecurityContextCallableProcessingInterceptor</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SecurityContextCallableProcessingInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">CallableProcessingInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">SecurityContext</span> securityContext<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">SecurityContextHolderStrategy</span> securityContextHolderStrategy <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span>
       <span class="token punctuation">.</span><span class="token function">getContextHolderStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SecurityContextCallableProcessingInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">SecurityContextCallableProcessingInterceptor</span><span class="token punctuation">(</span><span class="token class-name">SecurityContext</span> securityContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>securityContext<span class="token punctuation">,</span> <span class="token string">&quot;securityContext cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">setSecurityContext</span><span class="token punctuation">(</span>securityContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">beforeConcurrentHandling</span><span class="token punctuation">(</span><span class="token class-name">NativeWebRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">setSecurityContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token comment">//在真正执行异步任务之前，会首先执行该拦截器，就会执行preProcess方法，从而执行setContext设置context</span>
    <span class="token comment">//后续就可以通过getContext方法来获得用户信息</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">preProcess</span><span class="token punctuation">(</span><span class="token class-name">NativeWebRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">postProcess</span><span class="token punctuation">(</span><span class="token class-name">NativeWebRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">,</span> <span class="token class-name">Object</span> concurrentResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token class-name">SecurityContextHolderStrategy</span> securityContextHolderStrategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>securityContextHolderStrategy<span class="token punctuation">,</span> <span class="token string">&quot;securityContextHolderStrategy cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy <span class="token operator">=</span> securityContextHolderStrategy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setSecurityContext</span><span class="token punctuation">(</span><span class="token class-name">SecurityContext</span> securityContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>securityContext <span class="token operator">=</span> securityContext<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h2 id="headerwriterfilter"><a href="#headerwriterfilter" class="header-anchor">#</a> HeaderWriterFilter</h2> <p>写响应头，委派给HeaderWriter接口，有很多实现类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeaderWriterFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>
	<span class="token comment">//维护了很多HeaderWriter</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HeaderWriter</span><span class="token punctuation">&gt;</span></span> headerWriters<span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">HeaderWriter</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">writeHeaders</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="logoutfilter"><a href="#logoutfilter" class="header-anchor">#</a> LogoutFilter</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogoutFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">SecurityContextHolderStrategy</span> securityContextHolderStrategy <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span>
       <span class="token punctuation">.</span><span class="token function">getContextHolderStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">RequestMatcher</span> logoutRequestMatcher<span class="token punctuation">;</span>

	<span class="token comment">//处理登出时的逻辑</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LogoutHandler</span> handler<span class="token punctuation">;</span>
	<span class="token comment">//处理登出后的逻辑，比如在里面的onLogoutSuccess方法通过参数response响应一个登出成功的状态</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LogoutSuccessHandler</span> logoutSuccessHandler<span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
	       <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
	    <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
	       <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">requiresLogout</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	       <span class="token class-name">Authentication</span> auth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	          <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Logging out [%s]&quot;</span><span class="token punctuation">,</span> auth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token punctuation">}</span>
	       <span class="token comment">//把具体逻辑实现交给handler</span>
	       <span class="token keyword">this</span><span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> auth<span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token keyword">this</span><span class="token punctuation">.</span>logoutSuccessHandler<span class="token punctuation">.</span><span class="token function">onLogoutSuccess</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> auth<span class="token punctuation">)</span><span class="token punctuation">;</span>
	       <span class="token keyword">return</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
	    chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre></div><h2 id="requestcacheawarefilter"><a href="#requestcacheawarefilter" class="header-anchor">#</a> RequestCacheAwareFilter</h2> <p>一般通过前端来实现。前后端分离项目不会用到该过滤器</p> <p>作用：复原认证请求之前的信息，比如登录失败后重定向到登录页面，登录成功后复原回上次登录成功时访问的页面</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestCacheAwareFilter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericFilterBean</span> <span class="token punctuation">{</span>
	<span class="token comment">//缓存请求信息的接口</span>
    <span class="token keyword">private</span> <span class="token class-name">RequestCache</span> requestCache<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RequestCacheAwareFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpSessionRequestCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">RequestCacheAwareFilter</span><span class="token punctuation">(</span><span class="token class-name">RequestCache</span> requestCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>requestCache<span class="token punctuation">,</span> <span class="token string">&quot;requestCache cannot be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>requestCache <span class="token operator">=</span> requestCache<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
          <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
       <span class="token class-name">HttpServletRequest</span> wrappedSavedRequest <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestCache<span class="token punctuation">.</span><span class="token function">getMatchingRequest</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span>
             <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
       chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>wrappedSavedRequest <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> wrappedSavedRequest <span class="token operator">:</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h2 id="securitycontextholderawarerequestfilter"><a href="#securitycontextholderawarerequestfilter" class="header-anchor">#</a> SecurityContextHolderAwareRequestFilter</h2> <p>实现了HttpServletRequest中一些标准的获取认证信息的方法，通过包装器的模式来实现</p> <h3 id="dofilter方法-3"><a href="#dofilter方法-3" class="header-anchor">#</a> doFilter方法</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
       <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> res<span class="token punctuation">)</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>doFilter方法中替换了req为this.requestFactory.create((HttpServletRequest) req, (HttpServletResponse) res)</p> <h3 id="create方法"><a href="#create方法" class="header-anchor">#</a> create方法</h3> <p>定义在HttpServletRequestFactory接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">interface</span> <span class="token class-name">HttpServletRequestFactory</span> <span class="token punctuation">{</span>
	<span class="token class-name">HttpServletRequest</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre></div><p>该方法在HttpServlet3RequestFactory类中有唯一实现</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">HttpServletRequest</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//1️⃣一个wapper包装类</span>
    <span class="token class-name">Servlet3SecurityContextHolderAwareRequestWrapper</span> wrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Servlet3SecurityContextHolderAwareRequestWrapper</span><span class="token punctuation">(</span>
          request<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rolePrefix<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    wrapper<span class="token punctuation">.</span><span class="token function">setSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> wrapper<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_1️⃣servlet3securitycontextholderawarerequestwrapper"><a href="#_1️⃣servlet3securitycontextholderawarerequestwrapper" class="header-anchor">#</a> 1️⃣Servlet3SecurityContextHolderAwareRequestWrapper</h3> <p>继承了SecurityContextHolderAwareRequestWrapper</p> <p>SecurityContextHolderAwareRequestWrapper包装器包装了HttpServletRequest接口中的一些方法，如：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRemoteUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Authentication</span> auth <span class="token operator">=</span> <span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>auth <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>auth<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>auth<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">UserDetails</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">UserDetails</span><span class="token punctuation">)</span> auth<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>auth <span class="token keyword">instanceof</span> <span class="token class-name">AbstractAuthenticationToken</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> auth<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> auth<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Principal</span> <span class="token function">getUserPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Authentication</span> auth <span class="token operator">=</span> <span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>auth <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>auth<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> auth<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isGranted</span><span class="token punctuation">(</span><span class="token class-name">String</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Authentication</span> auth <span class="token operator">=</span> <span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rolePrefix <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> role <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>role<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rolePrefix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       role <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rolePrefix <span class="token operator">+</span> role<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>auth <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>auth<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities <span class="token operator">=</span> auth<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>authorities <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">GrantedAuthority</span> grantedAuthority <span class="token operator">:</span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>role<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>grantedAuthority<span class="token punctuation">.</span><span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="anonymousauthenticationfilter"><a href="#anonymousauthenticationfilter" class="header-anchor">#</a> AnonymousAuthenticationFilter</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
       <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span></span> deferredContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">getDeferredContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy
       <span class="token punctuation">.</span><span class="token function">setDeferredContext</span><span class="token punctuation">(</span><span class="token function">defaultWithAnonymous</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">,</span> deferredContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span></span> <span class="token function">defaultWithAnonymous</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>
       <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span></span> currentDeferredContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">SingletonSupplier</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
       <span class="token class-name">SecurityContext</span> currentContext <span class="token operator">=</span> currentDeferredContext<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token function">defaultWithAnonymous</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> currentContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">SecurityContext</span> <span class="token function">defaultWithAnonymous</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">SecurityContext</span> currentContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Authentication</span> currentAuthentication <span class="token operator">=</span> currentContext<span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1️⃣如果Authentication==null，就createAuthentication方法创建一个</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentAuthentication <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Authentication</span> anonymous <span class="token operator">=</span> <span class="token function">createAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Set SecurityContextHolder to &quot;</span> <span class="token operator">+</span> anonymous<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Set SecurityContextHolder to anonymous SecurityContext&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token class-name">SecurityContext</span> anonymousContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       anonymousContext<span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> anonymousContext<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Did not set SecurityContextHolder since already authenticated &quot;</span>
                <span class="token operator">+</span> currentAuthentication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> currentContext<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_1️⃣核心方法createauthentication"><a href="#_1️⃣核心方法createauthentication" class="header-anchor">#</a> 1️⃣核心方法createAuthentication</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Authentication</span> <span class="token function">createAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AnonymousAuthenticationToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnonymousAuthenticationToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>principal<span class="token punctuation">,</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
    token<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationDetailsSource<span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> token<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="匿名、认证和完全认证"><a href="#匿名、认证和完全认证" class="header-anchor">#</a> 匿名、认证和完全认证</h3> <p>AnonymousAuthenticationToken为匿名认证</p> <p>用户通过rememberMe来进行认证登录为认证；用户通过用户名和密码进行认证登录为完全认证</p> <h2 id="exceptiontranslationfilter"><a href="#exceptiontranslationfilter" class="header-anchor">#</a> ExceptionTranslationFilter</h2> <h3 id="dofilter方法-4"><a href="#dofilter方法-4" class="header-anchor">#</a> doFilter方法</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
       <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
       <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">//该类只会捕获异常并处理，不会干涉逻辑</span>
       chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// Try to extract a SpringSecurityException from the stacktrace</span>
       <span class="token class-name">Throwable</span><span class="token punctuation">[</span><span class="token punctuation">]</span> causeChain <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>throwableAnalyzer<span class="token punctuation">.</span><span class="token function">determineCauseChain</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//用RuntimeException来接受，RuntimeException是这些异常的父类</span>
       <span class="token class-name">RuntimeException</span> securityException <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>throwableAnalyzer
          <span class="token punctuation">.</span><span class="token function">getFirstThrowableOfType</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> causeChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>securityException <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          securityException <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>throwableAnalyzer
             <span class="token punctuation">.</span><span class="token function">getFirstThrowableOfType</span><span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> causeChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>securityException <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//如果不是上述两种异常，直接再次抛出</span>
          <span class="token function">rethrow</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isCommitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//如果已经提交，直接抛异常</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to handle the Spring Security Exception &quot;</span>
                <span class="token operator">+</span> <span class="token string">&quot;because the response is already committed.&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment">//真正处理上述两种异常的方法</span>
       <span class="token function">handleSpringSecurityException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> securityException<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="handlespringsecurityexception方法"><a href="#handlespringsecurityexception方法" class="header-anchor">#</a> handleSpringSecurityException方法</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleSpringSecurityException</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span><span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span> <span class="token class-name">RuntimeException</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//1️⃣如果是AuthenticationException</span>
       <span class="token function">handleAuthenticationException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span><span class="token punctuation">)</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//2️⃣如果是AccessDeniedException</span>
       <span class="token function">handleAccessDeniedException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span><span class="token punctuation">)</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_1️⃣如果是authenticationexception"><a href="#_1️⃣如果是authenticationexception" class="header-anchor">#</a> 1️⃣如果是AuthenticationException</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//1️⃣</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleAuthenticationException</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Sending to authentication entry point since authentication failed&quot;</span><span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3️⃣</span>
    <span class="token function">sendStartAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_3️⃣sendstartauthentication"><a href="#_3️⃣sendstartauthentication" class="header-anchor">#</a> 3️⃣sendStartAuthentication</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">sendStartAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span>
       <span class="token class-name">AuthenticationException</span> reason<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// SEC-112: Clear the SecurityContextHolder's Authentication, as the</span>
    <span class="token comment">// existing Authentication is no longer considered valid</span>
    <span class="token class-name">SecurityContext</span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">createEmptyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//保存下来request，因为认证的时候往往会重定向到其他url</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requestCache<span class="token punctuation">.</span><span class="token function">saveRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationEntryPoint<span class="token punctuation">.</span><span class="token function">commence</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>关于this.<a href="https://sardinary.vercel.app/spring/spring-security-02/#authentication-entry-point" target="_blank" rel="noopener noreferrer">authenticationEntryPoint<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.commence：进行跳转并认证</p> <h3 id="_2️⃣如果是accessdeniedexception"><a href="#_2️⃣如果是accessdeniedexception" class="header-anchor">#</a> 2️⃣如果是AccessDeniedException</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//2️⃣</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleAccessDeniedException</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span> <span class="token class-name">AccessDeniedException</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> isAnonymous <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationTrustResolver<span class="token punctuation">.</span><span class="token function">isAnonymous</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果是匿名token或者是rememberMe的token，就直接调用sendStartAuthentication（见3️⃣）进行跳转到认证入口</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isAnonymous <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationTrustResolver<span class="token punctuation">.</span><span class="token function">isRememberMe</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Sending %s to authentication entry point since access is denied&quot;</span><span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token function">sendStartAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InsufficientAuthenticationException</span><span class="token punctuation">(</span>         <span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">&quot;ExceptionTranslationFilter.insufficientAuthentication&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Full authentication is required to access this resource&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment">//如果不是，则为访问被拒绝403，权限不够</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span>
                <span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Sending %s to access denied handler since access is denied&quot;</span><span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">,</span>
                exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token comment">//4️⃣调用accessDeniedHandler.handle方法</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>accessDeniedHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><a href="https://sardinary.vercel.app/spring/spring-security-02/#access-denied-handler" target="_blank" rel="noopener noreferrer">AccessDeniedHandler<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：访问被拒绝的处理器</p> <h2 id="authenticationentrypoint"><a href="#authenticationentrypoint" class="header-anchor">#</a> AuthenticationEntryPoint</h2> <p>认证的入口。</p> <p>即在没有认证的情况下，直接将页面转到认证页面或者返回未认证的信息并让前端转到认证页面。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AuthenticationEntryPoint</span> <span class="token punctuation">{</span>
	<span class="token keyword">void</span> <span class="token function">commence</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> authException<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>在前后端分离的项目中，commence方法更多的是返回一段json到前端，告诉前端该用户没有认证，前端实现重定向到认证界面。</p> <h2 id="accessdeniedhandler"><a href="#accessdeniedhandler" class="header-anchor">#</a> AccessDeniedHandler</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AccessDeniedHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AccessDeniedException</span> accessDeniedException<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre></div><p>一般情况下自己实现</p> <p>前后端分离的项目一般回返回一个json，提示没有权限</p> <h2 id="defaultsecurityfilterchain中filter注入的时机"><a href="#defaultsecurityfilterchain中filter注入的时机" class="header-anchor">#</a> DefaultSecurityFilterChain中filter注入的时机</h2> <p>我们在config类中只配置了</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">DefaultSecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>那DefaultSecurityFilterChain中这么多filter是什么时候加进来的？</p> <h3 id="httpsecurityconfiguration"><a href="#httpsecurityconfiguration" class="header-anchor">#</a> HttpSecurityConfiguration</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token constant">HTTPSECURITY_BEAN_NAME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Scope</span><span class="token punctuation">(</span><span class="token string">&quot;prototype&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">HttpSecurity</span> <span class="token function">httpSecurity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">LazyPasswordEncoder</span> passwordEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazyPasswordEncoder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AuthenticationManagerBuilder</span> authenticationBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultPasswordEncoderAuthenticationManagerBuilder</span><span class="token punctuation">(</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>objectPostProcessor<span class="token punctuation">,</span> passwordEncoder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    authenticationBuilder<span class="token punctuation">.</span><span class="token function">parentAuthenticationManager</span><span class="token punctuation">(</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    authenticationBuilder<span class="token punctuation">.</span><span class="token function">authenticationEventPublisher</span><span class="token punctuation">(</span><span class="token function">getAuthenticationEventPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HttpSecurity</span> http <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpSecurity</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>objectPostProcessor<span class="token punctuation">,</span> authenticationBuilder<span class="token punctuation">,</span> <span class="token function">createSharedObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//createSharedObjects()方法中把ApplicationContext放进了sharedObjects map</span>
    <span class="token class-name">WebAsyncManagerIntegrationFilter</span> webAsyncManagerIntegrationFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebAsyncManagerIntegrationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    webAsyncManagerIntegrationFilter<span class="token punctuation">.</span><span class="token function">setSecurityContextHolderStrategy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityContextHolderStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// @formatter:off</span>
    <span class="token comment">//默认filter在这个地方配置</span>
    <span class="token comment">//如果不需要这些默认配置，要在config类中手动禁用</span>
    http
       <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>webAsyncManagerIntegrationFilter<span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">securityContext</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">requestCache</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">servletApi</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultLoginPageConfigurer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    http<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// @formatter:on</span>
    <span class="token function">applyDefaultConfigurers</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//与sringboot相关的加载的一些</span>
    <span class="token keyword">return</span> http<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">applyDefaultConfigurers</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractHttpConfigurer</span><span class="token punctuation">&gt;</span></span> defaultHttpConfigurers <span class="token operator">=</span> <span class="token class-name">SpringFactoriesLoader</span>
       <span class="token punctuation">.</span><span class="token function">loadFactories</span><span class="token punctuation">(</span><span class="token class-name">AbstractHttpConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AbstractHttpConfigurer</span> configurer <span class="token operator">:</span> defaultHttpConfigurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       http<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>configurer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>DefaultSecurityFilterChain在WebSecurityConfiguration中被使用</p> <h3 id="websecurityconfiguration"><a href="#websecurityconfiguration" class="header-anchor">#</a> WebSecurityConfiguration</h3> <p>维护了securityFilterChains属性，并通过set方法注入</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityFilterChain</span><span class="token punctuation">&gt;</span></span> securityFilterChains <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token class-name">AbstractSecurityWebApplicationInitializer</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_FILTER_NAME</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Filter</span> <span class="token function">springSecurityFilterChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> hasFilterChain <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>securityFilterChains<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasFilterChain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>webSecurity<span class="token punctuation">.</span><span class="token function">addSecurityFilterChainBuilder</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>httpSecurity<span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span><span class="token punctuation">(</span>authorize<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> authorize<span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>httpSecurity<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>httpSecurity<span class="token punctuation">.</span><span class="token function">httpBasic</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>httpSecurity<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SecurityFilterChain</span> securityFilterChain <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityFilterChains<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>webSecurity<span class="token punctuation">.</span><span class="token function">addSecurityFilterChainBuilder</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> securityFilterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">WebSecurityCustomizer</span> customizer <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>webSecurityCustomizers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       customizer<span class="token punctuation">.</span><span class="token function">customize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>webSecurity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>webSecurity<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//此处调用了WebSecurity的build方法</span>
<span class="token punctuation">}</span>

</code></pre></div><p>生成一个Filter，即一个FilterChainProxy</p> <p>DEFAULT_FILTER_NAME的值为springSecurityFilterChain，即其beanName</p> <p>这个filter被DelegatingFilterProxy使用</p> <h3 id="delegatingfilterproxy"><a href="#delegatingfilterproxy" class="header-anchor">#</a> DelegatingFilterProxy</h3> <p>属于包org.springframework.web.filter</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
       <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

    <span class="token comment">// Lazily initialize the delegate if necessary.</span>
    <span class="token class-name">Filter</span> delegateToUse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>delegateToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token comment">//双重检查锁</span>
       <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegateMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          delegateToUse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>delegateToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	          <span class="token comment">//拿到 WebApplicationContext</span>
             <span class="token class-name">WebApplicationContext</span> wac <span class="token operator">=</span> <span class="token function">findWebApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span>wac <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;No WebApplicationContext found: &quot;</span> <span class="token operator">+</span>
                      <span class="token string">&quot;no ContextLoaderListener or DispatcherServlet registered?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
             <span class="token comment">//1️⃣通过 initDelegate方法拿到filter</span>
             delegateToUse <span class="token operator">=</span> <span class="token function">initDelegate</span><span class="token punctuation">(</span>wac<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> delegateToUse<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Let the delegate perform the actual doFilter operation.</span>
    <span class="token function">invokeDelegate</span><span class="token punctuation">(</span>delegateToUse<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> filterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>1️⃣initDelegate方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Filter</span> <span class="token function">initDelegate</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationContext</span> wac<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> targetBeanName <span class="token operator">=</span> <span class="token function">getTargetBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//此 TargetBeanName即springSecurityFilterChain</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>targetBeanName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;No target bean name set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//WebApplicationContext的getBean方法拿到filter</span>
    <span class="token class-name">Filter</span> delegate <span class="token operator">=</span> wac<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>targetBeanName<span class="token punctuation">,</span> <span class="token class-name">Filter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTargetFilterLifecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       delegate<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token function">getFilterConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> delegate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>DispatcherServlet是tomcat里面的最主要的servlet，在到达该servlet之前会执行一堆的filter，DelegatingFilterProxy就是其中的一个</p> <p>DelegatingFilterProxy执行的是WebSecurityConfiguration构建出的springSecurityFilterChain，即一个FilterChainProxy</p> <p>其中filterChains属性包含了一个或多个filterChain（一般只有一个），比如DefaultFilterChain。</p> <h3 id="springsecurity从tomcat执行下来的过程"><a href="#springsecurity从tomcat执行下来的过程" class="header-anchor">#</a> SpringSecurity从tomcat执行下来的过程</h3> <p>config类中在public DefaultSecurityFilterChain securityFilterChain(HttpSecurity http)方法中配置过滤器，构建成SecurityFilterChain来返回，</p> <p>在WebSecurityConfiguration中，通过@Autowired注入SecurityFilterChain，在springSecurityFilterChain方法中通过WebSecurity构建出一个FilterChainProxy，命名为springSecurityFilterChain，</p> <p>springSecurityFilterChain通过DelegatingFilterProxy添加到tomcat最原生的filter列表中，</p> <p>然后通过doFilter方法 -&gt; invokeDelegate方法真正执行</p> <h1 id="springsecurity顶层流程"><a href="#springsecurity顶层流程" class="header-anchor">#</a> SpringSecurity顶层流程</h1> <p>DelegatingFilterProxy -&gt; FilterChainProxy -&gt; SecurityFilterChain -&gt; 具体的Filter</p> <p>HttpSecurityConfiguration配置了基础的HttpSecurity对象以供我们注入使用</p> <p>WebSecurityConfiguration注入了我们自己的SecurityFilterChainBean然后添加到WebSecurity中</p> <p>最终由WebSecurity构建出FilterChainProxy来执行SpringSecurity的过滤逻辑</p></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#securitycontext" class="sidebar-link reco-side-securitycontext" data-v-b57cc07c>SecurityContext</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#securitycontextholder" class="sidebar-link reco-side-securitycontextholder" data-v-b57cc07c>SecurityContextHolder</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#一些设置context的重要方法" class="sidebar-link reco-side-一些设置context的重要方法" data-v-b57cc07c>一些设置context的重要方法</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#初始化" class="sidebar-link reco-side-初始化" data-v-b57cc07c>初始化</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#securitycontextholderstrategy" class="sidebar-link reco-side-securitycontextholderstrategy" data-v-b57cc07c>SecurityContextHolderStrategy</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#主要使用threadlocalsecuritycontextholderstrategy" class="sidebar-link reco-side-主要使用threadlocalsecuritycontextholderstrategy" data-v-b57cc07c>主要使用ThreadLocalSecurityContextHolderStrategy</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#securitycontextrepository" class="sidebar-link reco-side-securitycontextrepository" data-v-b57cc07c>SecurityContextRepository</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#securitycontextpersistencefilter" class="sidebar-link reco-side-securitycontextpersistencefilter" data-v-b57cc07c>SecurityContextPersistenceFilter</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#dofilter方法" class="sidebar-link reco-side-dofilter方法" data-v-b57cc07c>doFilter方法</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#redis中出现两个token的原因" class="sidebar-link reco-side-redis中出现两个token的原因" data-v-b57cc07c>Redis中出现两个token的原因</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#securitycontextholderfilter" class="sidebar-link reco-side-securitycontextholderfilter" data-v-b57cc07c>SecurityContextHolderFilter</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#securitycontextconfigurer" class="sidebar-link reco-side-securitycontextconfigurer" data-v-b57cc07c>SecurityContextConfigurer</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#configure方法" class="sidebar-link reco-side-configure方法" data-v-b57cc07c>configure方法</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#securityfilterchain加入filterchainproxy的时机" class="sidebar-link reco-side-securityfilterchain加入filterchainproxy的时机" data-v-b57cc07c>SecurityFilterChain加入FilterChainProxy的时机</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#springsecurity本质是一个过滤器之中套了很多过滤器" class="sidebar-link reco-side-springsecurity本质是一个过滤器之中套了很多过滤器" data-v-b57cc07c>SpringSecurity本质是一个过滤器之中套了很多过滤器</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#remembermeauthenticationfilter" class="sidebar-link reco-side-remembermeauthenticationfilter" data-v-b57cc07c>RememberMeAuthenticationFilter</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#属性" class="sidebar-link reco-side-属性" data-v-b57cc07c>属性</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#dofilter方法-2" class="sidebar-link reco-side-dofilter方法-2" data-v-b57cc07c>doFilter方法</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#_1️⃣" class="sidebar-link reco-side-_1️⃣" data-v-b57cc07c>1️⃣</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#remembermeservices" class="sidebar-link reco-side-remembermeservices" data-v-b57cc07c>RememberMeServices</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#作用" class="sidebar-link reco-side-作用" data-v-b57cc07c>作用</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#实现类" class="sidebar-link reco-side-实现类" data-v-b57cc07c>实现类</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#remembermeauthenticationprovider" class="sidebar-link reco-side-remembermeauthenticationprovider" data-v-b57cc07c>RememberMeAuthenticationProvider</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#remembermeauthenticationtoken" class="sidebar-link reco-side-remembermeauthenticationtoken" data-v-b57cc07c>RememberMeAuthenticationToken</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#abstractremembermeservices" class="sidebar-link reco-side-abstractremembermeservices" data-v-b57cc07c>AbstractRememberMeServices</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#autologin方法" class="sidebar-link reco-side-autologin方法" data-v-b57cc07c>autoLogin方法</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#_1️⃣extractremembermecookie" class="sidebar-link reco-side-_1️⃣extractremembermecookie" data-v-b57cc07c>1️⃣extractRememberMeCookie</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#_2️⃣cancelcookie" class="sidebar-link reco-side-_2️⃣cancelcookie" data-v-b57cc07c>2️⃣cancelCookie</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#_3️⃣decodecookie" class="sidebar-link reco-side-_3️⃣decodecookie" data-v-b57cc07c>3️⃣decodeCookie</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#_4️⃣processautologincookie" class="sidebar-link reco-side-_4️⃣processautologincookie" data-v-b57cc07c>4️⃣processAutoLoginCookie</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#remembermeconfigurer" class="sidebar-link reco-side-remembermeconfigurer" data-v-b57cc07c>RememberMeConfigurer</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#sessionmanagementfilter" class="sidebar-link reco-side-sessionmanagementfilter" data-v-b57cc07c>SessionManagementFilter</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#sessionauthenticationstrategy" class="sidebar-link reco-side-sessionauthenticationstrategy" data-v-b57cc07c>SessionAuthenticationStrategy</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#实现类registersessionauthenticationstrategy" class="sidebar-link reco-side-实现类registersessionauthenticationstrategy" data-v-b57cc07c>实现类RegisterSessionAuthenticationStrategy</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#实现类concurrentsessioncontrolauthenticationstrategy" class="sidebar-link reco-side-实现类concurrentsessioncontrolauthenticationstrategy" data-v-b57cc07c>实现类ConcurrentSessionControlAuthenticationStrategy</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#实现类compositesessionauthenticationstrategy" class="sidebar-link reco-side-实现类compositesessionauthenticationstrategy" data-v-b57cc07c>实现类CompositeSessionAuthenticationStrategy</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#实现类abstractsessionfixationprotectionstrategy" class="sidebar-link reco-side-实现类abstractsessionfixationprotectionstrategy" data-v-b57cc07c>实现类AbstractSessionFixationProtectionStrategy</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#applysessionfixation方法" class="sidebar-link reco-side-applysessionfixation方法" data-v-b57cc07c>applySessionFixation方法</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#changesessionidauthenticationstrategy中的实现" class="sidebar-link reco-side-changesessionidauthenticationstrategy中的实现" data-v-b57cc07c>ChangeSessionIdAuthenticationStrategy中的实现</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#sessionfixationprotectionstrategy中的实现" class="sidebar-link reco-side-sessionfixationprotectionstrategy中的实现" data-v-b57cc07c>SessionFixationProtectionStrategy中的实现</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#sessionregistry" class="sidebar-link reco-side-sessionregistry" data-v-b57cc07c>SessionRegistry</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#sessioninformation" class="sidebar-link reco-side-sessioninformation" data-v-b57cc07c>SessionInformation</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#sessioninformationexpiredstrategy" class="sidebar-link reco-side-sessioninformationexpiredstrategy" data-v-b57cc07c>SessionInformationExpiredStrategy</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#onexpiredsessiondetected方法" class="sidebar-link reco-side-onexpiredsessiondetected方法" data-v-b57cc07c>onExpiredSessionDetected方法</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#responsebodysessioninformationexpiredstrategy中的实现" class="sidebar-link reco-side-responsebodysessioninformationexpiredstrategy中的实现" data-v-b57cc07c>ResponseBodySessionInformationExpiredStrategy中的实现</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#simpleredirectsessioninformationexpiredstrategy中的实现" class="sidebar-link reco-side-simpleredirectsessioninformationexpiredstrategy中的实现" data-v-b57cc07c>SimpleRedirectSessionInformationExpiredStrategy中的实现</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#this-redirectstrategy-sendredirect" class="sidebar-link reco-side-this-redirectstrategy-sendredirect" data-v-b57cc07c>this.redirectStrategy.sendRedirect</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#concurrentsessionfilter" class="sidebar-link reco-side-concurrentsessionfilter" data-v-b57cc07c>ConcurrentSessionFilter</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#sessionmanagementconfigurer" class="sidebar-link reco-side-sessionmanagementconfigurer" data-v-b57cc07c>SessionManagementConfigurer</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#disableencodeurlfilter" class="sidebar-link reco-side-disableencodeurlfilter" data-v-b57cc07c>DisableEncodeUrlFilter</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#_1️⃣disableencodeurlresponsewrapper" class="sidebar-link reco-side-_1️⃣disableencodeurlresponsewrapper" data-v-b57cc07c>1️⃣DisableEncodeUrlResponseWrapper</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#_2️⃣encodeurl" class="sidebar-link reco-side-_2️⃣encodeurl" data-v-b57cc07c>2️⃣encodeURL</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#webasyncmanagerintegrationfilter" class="sidebar-link reco-side-webasyncmanagerintegrationfilter" data-v-b57cc07c>WebAsyncManagerIntegrationFilter</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#_1️⃣securitycontextcallableprocessinginterceptor" class="sidebar-link reco-side-_1️⃣securitycontextcallableprocessinginterceptor" data-v-b57cc07c>1️⃣SecurityContextCallableProcessingInterceptor</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#headerwriterfilter" class="sidebar-link reco-side-headerwriterfilter" data-v-b57cc07c>HeaderWriterFilter</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#logoutfilter" class="sidebar-link reco-side-logoutfilter" data-v-b57cc07c>LogoutFilter</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#requestcacheawarefilter" class="sidebar-link reco-side-requestcacheawarefilter" data-v-b57cc07c>RequestCacheAwareFilter</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#securitycontextholderawarerequestfilter" class="sidebar-link reco-side-securitycontextholderawarerequestfilter" data-v-b57cc07c>SecurityContextHolderAwareRequestFilter</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#dofilter方法-3" class="sidebar-link reco-side-dofilter方法-3" data-v-b57cc07c>doFilter方法</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#create方法" class="sidebar-link reco-side-create方法" data-v-b57cc07c>create方法</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#_1️⃣servlet3securitycontextholderawarerequestwrapper" class="sidebar-link reco-side-_1️⃣servlet3securitycontextholderawarerequestwrapper" data-v-b57cc07c>1️⃣Servlet3SecurityContextHolderAwareRequestWrapper</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#anonymousauthenticationfilter" class="sidebar-link reco-side-anonymousauthenticationfilter" data-v-b57cc07c>AnonymousAuthenticationFilter</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#_1️⃣核心方法createauthentication" class="sidebar-link reco-side-_1️⃣核心方法createauthentication" data-v-b57cc07c>1️⃣核心方法createAuthentication</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#匿名、认证和完全认证" class="sidebar-link reco-side-匿名、认证和完全认证" data-v-b57cc07c>匿名、认证和完全认证</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#exceptiontranslationfilter" class="sidebar-link reco-side-exceptiontranslationfilter" data-v-b57cc07c>ExceptionTranslationFilter</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#dofilter方法-4" class="sidebar-link reco-side-dofilter方法-4" data-v-b57cc07c>doFilter方法</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#handlespringsecurityexception方法" class="sidebar-link reco-side-handlespringsecurityexception方法" data-v-b57cc07c>handleSpringSecurityException方法</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#_1️⃣如果是authenticationexception" class="sidebar-link reco-side-_1️⃣如果是authenticationexception" data-v-b57cc07c>1️⃣如果是AuthenticationException</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#_3️⃣sendstartauthentication" class="sidebar-link reco-side-_3️⃣sendstartauthentication" data-v-b57cc07c>3️⃣sendStartAuthentication</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#_2️⃣如果是accessdeniedexception" class="sidebar-link reco-side-_2️⃣如果是accessdeniedexception" data-v-b57cc07c>2️⃣如果是AccessDeniedException</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#authenticationentrypoint" class="sidebar-link reco-side-authenticationentrypoint" data-v-b57cc07c>AuthenticationEntryPoint</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#accessdeniedhandler" class="sidebar-link reco-side-accessdeniedhandler" data-v-b57cc07c>AccessDeniedHandler</a></li><li class="level-2" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#defaultsecurityfilterchain中filter注入的时机" class="sidebar-link reco-side-defaultsecurityfilterchain中filter注入的时机" data-v-b57cc07c>DefaultSecurityFilterChain中filter注入的时机</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#httpsecurityconfiguration" class="sidebar-link reco-side-httpsecurityconfiguration" data-v-b57cc07c>HttpSecurityConfiguration</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#websecurityconfiguration" class="sidebar-link reco-side-websecurityconfiguration" data-v-b57cc07c>WebSecurityConfiguration</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#delegatingfilterproxy" class="sidebar-link reco-side-delegatingfilterproxy" data-v-b57cc07c>DelegatingFilterProxy</a></li><li class="level-3" data-v-b57cc07c><a href="/Sardinary/blogs/SpringSecurity/Spring_Security_02%20958f5147db2442bc8231eecfd8f82cba.html#springsecurity从tomcat执行下来的过程" class="sidebar-link reco-side-springsecurity从tomcat执行下来的过程" data-v-b57cc07c>SpringSecurity从tomcat执行下来的过程</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:0;" data-v-248d85d6></canvas></div><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="/Sardinary/assets/js/app.b4352b80.js" defer></script><script src="/Sardinary/assets/js/7.1de0e771.js" defer></script><script src="/Sardinary/assets/js/2.32e86603.js" defer></script><script src="/Sardinary/assets/js/1.87af8fda.js" defer></script><script src="/Sardinary/assets/js/25.c67021f4.js" defer></script>
  </body>
</html>
